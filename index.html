<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Aqua Control Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ocean-dark': '#0F172A', /* Slate 900 */
                        'ocean-deep': '#020617', /* Slate 950 */
                        'marine-blue': '#38BDF8', /* Sky 400 */
                        'coral-pink': '#FB7185', /* Rose 400 */
                        'sea-foam': '#CCFBF1', /* Teal 100 */
                        'glass-surface': 'rgba(30, 41, 59, 0.4)',
                        'glass-border': 'rgba(255, 255, 255, 0.08)',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(180deg, #0F172A 0%, #020617 100%);
            color: #E2E8F0; /* Slate 200 */
            min-height: 100dvh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
            -webkit-font-smoothing: antialiased;
        }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Glassmorphism Navigation */
        .glass-nav {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Premium Card Style */
        .card-glass {
            background: var(--tw-glass-surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--tw-glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 20px;
        }

        /* Inputs */
        .input-elegant {
            background: rgba(2, 6, 23, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #F8FAFC !important;
            height: 48px;
            border-radius: 12px;
            padding: 0 16px;
            font-size: 16px !important;
            transition: all 0.2s ease;
        }
        .input-elegant:focus {
            border-color: #38BDF8 !important;
            background: rgba(2, 6, 23, 0.8) !important;
            outline: none;
        }

        /* Buttons */
        .btn-ocean {
            background: linear-gradient(135deg, #38BDF8 0%, #0EA5E9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            border: none;
        }
        .btn-coral {
            background: linear-gradient(135deg, #FB7185 0%, #F43F5E 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
            border: none;
        }

        /* Animations */
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        .stream-cursor::after { content: ''; display: inline-block; width: 6px; height: 6px; background: #38BDF8; border-radius: 50%; margin-left: 4px; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .chart-label { font-size: 9px; fill: #94A3B8; font-family: sans-serif; }
        .nav-active { color: #38BDF8 !important; position: relative; }
        .nav-active::after { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #38BDF8; border-radius: 50%; box-shadow: 0 0 8px #38BDF8; }
    </style>
</head>
<body class="overflow-x-hidden">

    <header class="px-6 py-5 flex justify-between items-center sticky top-0 z-50 mix-blend-screen">
        <div>
            <h1 class="text-xs font-medium text-marine-blue tracking-[0.2em] uppercase opacity-80">Marine Suite</h1>
            <p class="text-2xl font-light tracking-tight text-white">Aqua Control</p>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-[10px] text-slate-400 font-medium tracking-wide">AI CONNECTED</span>
            <div class="w-2 h-2 rounded-full bg-marine-blue shadow-[0_0_10px_rgba(56,189,248,0.5)] animate-pulse"></div>
        </div>
    </header>

    <main class="p-5 space-y-8">

        <section id="tab-chat" class="tab-content active space-y-4">
            <div id="chat-history" class="h-[60dvh] overflow-y-auto space-y-5 pb-4 scroll-smooth pr-1">
                <div class="card-glass p-5 flex gap-3 items-start">
                    <div class="min-w-[24px] mt-1">
                        <svg class="w-6 h-6 text-marine-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-300 leading-relaxed">
                            こんにちは。Gemini 2.5 Flashです。<br>
                            水質、機材、生体の状態に基づいた最適なアドバイスを提供します。
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="fixed bottom-24 left-5 right-5 z-40">
                <div class="card-glass p-2 pl-4 flex gap-2 items-center backdrop-blur-xl">
                    <input type="text" id="chat-input" class="flex-1 bg-transparent border-none text-white text-base focus:outline-none placeholder-slate-500" placeholder="AIに相談する...">
                    <button onclick="handleChat()" class="btn-ocean w-10 h-10 rounded-xl flex items-center justify-center transition-transform active:scale-95">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                </div>
            </div>
        </section>

        <section id="tab-equip" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-light text-white tracking-wide">Equipment</h2>
                <button onclick="openModal('modal-equip')" class="text-xs text-marine-blue font-bold uppercase tracking-wider bg-marine-blue/10 px-3 py-1.5 rounded-full">+ Add Item</button>
            </div>
            <div id="equip-list" class="grid gap-3"></div>
        </section>

        <section id="tab-lives" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-light text-white tracking-wide">Livestock</h2>
                <button onclick="openModal('modal-lives')" class="text-xs text-marine-blue font-bold uppercase tracking-wider bg-marine-blue/10 px-3 py-1.5 rounded-full">+ Add Life</button>
            </div>
            <div id="lives-list" class="grid gap-3"></div>
        </section>

        <section id="tab-logs" class="tab-content space-y-8 pb-20">
            <div class="card-glass p-6 space-y-6">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-1 h-4 bg-coral-pink rounded-full"></div>
                    <h3 class="text-sm font-bold text-slate-200 uppercase tracking-widest">New Entry</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Salinity (SG)</label>
                        <input type="number" id="log-sg" step="0.001" class="input-elegant w-full text-center font-mono" placeholder="1.025">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Water Change (L)</label>
                        <input type="number" id="log-wc" class="input-elegant w-full text-center font-mono" placeholder="10">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Additives Dosing</label>
                    <div id="dose-slots" class="space-y-3">
                        <div class="flex gap-3">
                            <select id="log-add-type-1" class="input-elegant flex-1 text-xs appearance-none"></select>
                            <input type="number" id="log-add-val-1" class="input-elegant w-20 text-center font-mono" placeholder="Drop">
                        </div>
                        <div class="flex gap-3">
                            <select id="log-add-type-2" class="input-elegant flex-1 text-xs appearance-none"></select>
                            <input type="number" id="log-add-val-2" class="input-elegant w-20 text-center font-mono" placeholder="Drop">
                        </div>
                        <div class="flex gap-3">
                            <select id="log-add-type-3" class="input-elegant flex-1 text-xs appearance-none"></select>
                            <input type="number" id="log-add-val-3" class="input-elegant w-20 text-center font-mono" placeholder="Drop">
                        </div>
                    </div>
                </div>

                <button onclick="saveLog()" class="w-full h-12 btn-coral rounded-xl text-xs font-bold uppercase tracking-[0.2em] transition-transform active:scale-[0.98]">Save Record</button>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <div class="flex justify-between items-end px-2">
                        <h4 class="text-xs font-bold text-coral-pink uppercase tracking-widest">Salinity Trend</h4>
                        <span class="text-[10px] text-slate-500 font-mono">1.015 - 1.035 SG</span>
                    </div>
                    <div class="card-glass p-4 h-48 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-coral-pink/5 to-transparent pointer-events-none"></div>
                        <svg id="svg-chart-sg" class="w-full h-full relative z-10" preserveAspectRatio="none"></svg>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-end px-2">
                        <h4 class="text-xs font-bold text-marine-blue uppercase tracking-widest">Water Change Volume</h4>
                        <span class="text-[10px] text-slate-500 font-mono">0 - 15 L</span>
                    </div>
                    <div class="card-glass p-4 h-40 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-marine-blue/5 to-transparent pointer-events-none"></div>
                        <svg id="svg-chart-wc" class="w-full h-full relative z-10" preserveAspectRatio="none"></svg>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest px-2">Recent Logs</h4>
                <div id="logs-history" class="space-y-3"></div>
            </div>
        </section>

        <section id="tab-set" class="tab-content space-y-8">
            <div class="space-y-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-1">Configuration</h3>
                <div class="card-glass p-6 space-y-5">
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-500 uppercase tracking-wider">Gemini API Key</label>
                        <input type="password" id="set-api-key" class="input-elegant w-full text-xs font-mono" placeholder="sk-...">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[10px] text-slate-500 uppercase tracking-wider">Volume (L)</label>
                            <input type="number" id="set-volume" class="input-elegant w-full font-mono">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] text-slate-500 uppercase tracking-wider">Start Date</label>
                            <input type="date" id="set-start-date" class="input-elegant w-full text-xs font-mono text-center">
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h3 class="text-xs font-bold text-marine-blue uppercase tracking-widest">Additives List</h3>
                    <button onclick="addAdditiveField()" class="text-[10px] text-marine-blue border border-marine-blue/30 px-2 py-1 rounded hover:bg-marine-blue/10">Edit List</button>
                </div>
                <div id="additive-inputs" class="space-y-3"></div>
            </div>

            <div class="pt-8 border-t border-white/5 flex flex-col items-center gap-6">
                <button onclick="exportData()" class="text-xs text-slate-400 font-medium hover:text-white transition-colors border-b border-transparent hover:border-white">Export Backup (JSON)</button>
                <button onclick="clearAllData()" class="text-[10px] text-coral-pink/70 font-bold uppercase tracking-widest hover:text-coral-pink">Factory Reset</button>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 glass-nav z-[100]">
        <div class="flex justify-around items-center h-[90px] max-w-lg mx-auto px-2 safe-bottom pb-2">
            <button onclick="switchTab('chat')" class="nav-btn text-slate-500 flex flex-col items-center gap-1.5 w-16" data-tab="chat">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="text-[9px] font-medium tracking-wide">CHAT</span>
            </button>
            <button onclick="switchTab('equip')" class="nav-btn text-slate-500 flex flex-col items-center gap-1.5 w-16" data-tab="equip">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="text-[9px] font-medium tracking-wide">EQUIP</span>
            </button>
            <button onclick="switchTab('lives')" class="nav-btn text-slate-500 flex flex-col items-center gap-1.5 w-16" data-tab="lives">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="text-[9px] font-medium tracking-wide">LIVES</span>
            </button>
            <button onclick="switchTab('logs')" class="nav-btn text-slate-500 flex flex-col items-center gap-1.5 w-16" data-tab="logs">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="text-[9px] font-medium tracking-wide">LOGS</span>
            </button>
            <button onclick="switchTab('set')" class="nav-btn text-slate-500 flex flex-col items-center gap-1.5 w-16" data-tab="set">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="text-[9px] font-medium tracking-wide">SET</span>
            </button>
        </div>
    </nav>

    <div id="modal-equip" class="fixed inset-0 bg-ocean-deep/90 z-[200] hidden p-6 flex items-center justify-center backdrop-blur-md">
        <div class="card-glass w-full max-w-sm p-8 space-y-6">
            <h2 class="text-lg font-light text-white text-center">Add Equipment</h2>
            <input type="text" id="in-eq-name" class="input-elegant w-full" placeholder="Model Name">
            <select id="in-eq-cat" class="input-elegant w-full">
                <option value="Lighting">Lighting</option>
                <option value="Skimmer">Skimmer</option>
                <option value="Pump/Wave">Wavemaker</option>
                <option value="Filter">Filtration</option>
                <option value="Other">Other</option>
            </select>
            <input type="date" id="in-eq-date" class="input-elegant w-full">
            <div class="flex gap-4 pt-2">
                <button onclick="closeModal('modal-equip')" class="flex-1 h-12 rounded-xl border border-slate-600 text-slate-300 text-xs uppercase tracking-wider">Cancel</button>
                <button onclick="addEquipment()" class="flex-1 h-12 rounded-xl btn-ocean text-xs font-bold uppercase tracking-wider">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-lives" class="fixed inset-0 bg-ocean-deep/90 z-[200] hidden p-6 flex items-center justify-center backdrop-blur-md">
        <div class="card-glass w-full max-w-sm p-8 space-y-6">
            <h2 class="text-lg font-light text-white text-center">Add Livestock</h2>
            <input type="text" id="in-lv-name" class="input-elegant w-full" placeholder="Species Name">
            <select id="in-lv-cat" class="input-elegant w-full">
                <option value="FISH">Fish</option>
                <option value="CORAL">Coral</option>
                <option value="OTHER">Invertebrates / Other</option>
            </select>
            <div class="flex gap-4 pt-2">
                <button onclick="closeModal('modal-lives')" class="flex-1 h-12 rounded-xl border border-slate-600 text-slate-300 text-xs uppercase tracking-wider">Cancel</button>
                <button onclick="addLivestock()" class="flex-1 h-12 rounded-xl btn-ocean text-xs font-bold uppercase tracking-wider">Save</button>
            </div>
        </div>
    </div>

    <script type="importmap">
    { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let state = {
            settings: {
                apiKey: '',
                volume: 30,
                startDate: new Date().toISOString().split('T')[0],
                additiveNames: ['Foundation A', 'Foundation B', 'Foundation C']
            },
            equipment: [],
            livestock: [],
            logs: []
        };

        const save = () => { localStorage.setItem('aquaControlV5', JSON.stringify(state)); renderAll(); };
        const init = () => {
            const data = localStorage.getItem('aquaControlV5');
            if (data) state = JSON.parse(data);
            syncSettingsToUI();
            renderAll();
            switchTab('chat');
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-active', 'text-marine-blue');
                b.classList.add('text-slate-500');
                if(b.dataset.tab === tabId) {
                    b.classList.remove('text-slate-500');
                    b.classList.add('nav-active');
                }
            });
            window.scrollTo(0,0);
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- RENDER ---
        function renderAll() {
            renderEquipment();
            renderLivestock();
            renderLogs();
            renderCharts();
            updateAdditiveSelects();
        }

        function renderEquipment() {
            document.getElementById('equip-list').innerHTML = state.equipment.map((e, idx) => `
                <div class="card-glass p-4 flex justify-between items-center group">
                    <div>
                        <p class="text-[9px] text-marine-blue font-bold uppercase tracking-widest mb-1">${e.category}</p>
                        <p class="text-sm font-medium text-slate-200">${e.name}</p>
                    </div>
                    <button onclick="deleteItem('equipment', ${idx})" class="text-slate-600 hover:text-coral-pink transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="1.5"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function renderLivestock() {
            const priority = { 'FISH': 0, 'CORAL': 1, 'OTHER': 2 };
            const sorted = [...state.livestock].sort((a, b) => priority[a.category] - priority[b.category]);
            document.getElementById('lives-list').innerHTML = sorted.map((l, idx) => `
                <div class="card-glass p-3 flex items-center gap-3">
                    <div class="w-1 h-8 rounded-full ${l.category==='FISH'?'bg-coral-pink':l.category==='CORAL'?'bg-marine-blue':'bg-slate-500'}"></div>
                    <div class="flex-1">
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">${l.category}</p>
                        <p class="text-sm font-medium text-white">${l.name}</p>
                    </div>
                    <button onclick="deleteItem('livestock', ${state.livestock.indexOf(l)})" class="text-xs text-slate-600">×</button>
                </div>
            `).join('');
        }

        function renderLogs() {
            document.getElementById('logs-history').innerHTML = state.logs.slice().reverse().map((l, idx) => {
                let doseHtml = l.additives ? l.additives.map(a => `<span class="inline-block bg-marine-blue/10 text-marine-blue border border-marine-blue/20 text-[9px] px-2 py-0.5 rounded-full mr-1">${a.name} ${a.val}</span>`).join('') : '';
                return `
                <div class="card-glass p-4 space-y-2">
                    <div class="flex justify-between items-center border-b border-white/5 pb-2 mb-2">
                        <span class="text-[10px] text-slate-400 font-mono">${l.date}</span>
                        <button onclick="deleteItem('logs', ${state.logs.length - 1 - idx})" class="text-coral-pink/50 hover:text-coral-pink text-[10px] uppercase font-bold">Delete</button>
                    </div>
                    <div class="flex items-center gap-6">
                        ${l.sg ? `<div><span class="text-[9px] text-slate-500 uppercase block">Salinity</span><span class="text-coral-pink font-bold font-mono text-sm">${l.sg}</span></div>` : ''}
                        ${l.wc ? `<div><span class="text-[9px] text-slate-500 uppercase block">Water Change</span><span class="text-marine-blue font-bold font-mono text-sm">${l.wc}L</span></div>` : ''}
                    </div>
                    ${doseHtml ? `<div class="pt-1">${doseHtml}</div>` : ''}
                </div>`;
            }).join('');
        }

        function renderCharts() {
            const draw = (svg, data, min, max, color) => {
                svg.innerHTML = '';
                if(data.length === 0) return;
                const w = svg.clientWidth || 300;
                const h = svg.clientHeight || 150;
                const pad = 10;
                const range = max - min;
                
                // Grid
                svg.innerHTML += `<line x1="${pad}" y1="0" x2="${pad}" y2="${h}" stroke="#334155" stroke-width="0.5" stroke-dasharray="2,2"/>`;
                svg.innerHTML += `<line x1="${pad}" y1="${h}" x2="${w}" y2="${h}" stroke="#334155" stroke-width="0.5"/>`;

                const points = data.map((d, i) => {
                    const x = pad + (i / (Math.max(data.length-1, 1))) * (w - pad*2);
                    const val = Math.min(Math.max(parseFloat(d.val), min), max);
                    const y = h - ((val - min) / range) * h;
                    return {x, y, date: d.date.split(' ')[0]};
                });

                if(points.length > 1) {
                    const poly = points.map(p => `${p.x},${p.y}`).join(' ');
                    svg.innerHTML += `<polyline points="${poly}" fill="none" stroke="${color}" stroke-width="2" stroke-linejoin="round" />`;
                    // Gradient Fill Area
                    const area = `${points[0].x},${h} ` + poly + ` ${points[points.length-1].x},${h}`;
                    svg.innerHTML += `<polygon points="${area}" fill="${color}" fill-opacity="0.1" />`;
                }

                points.forEach(p => {
                    svg.innerHTML += `<circle cx="${p.x}" cy="${p.y}" r="3" fill="#0F172A" stroke="${color}" stroke-width="2" />`;
                    svg.innerHTML += `<text x="${p.x}" y="${h-5}" class="chart-label" text-anchor="middle" transform="rotate(-90, ${p.x}, ${h-5})" dy="-5">${p.date}</text>`;
                });
            };

            const logs = state.logs.slice(-10);
            draw(document.getElementById('svg-chart-sg'), logs.filter(l=>l.sg).map(l=>({val:l.sg, date:l.date})), 1.015, 1.035, '#FB7185'); // Coral
            draw(document.getElementById('svg-chart-wc'), logs.filter(l=>l.wc).map(l=>({val:l.wc, date:l.date})), 0, 15, '#38BDF8'); // Marine Blue
        }

        // --- ACTIONS ---
        window.saveLog = () => {
            const sg = document.getElementById('log-sg').value;
            const wc = document.getElementById('log-wc').value;
            const doses = [];
            for(let i=1; i<=3; i++) {
                const typeIdx = document.getElementById(`log-add-type-${i}`).value;
                const val = document.getElementById(`log-add-val-${i}`).value;
                if(val > 0) doses.push({ name: state.settings.additiveNames[typeIdx], val: parseInt(val) });
            }
            if(!sg && !wc && doses.length === 0) return;

            state.logs.push({
                date: new Date().toLocaleString('ja-JP', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
                sg: sg || null, wc: wc || null, additives: doses
            });

            ['log-sg', 'log-wc', 'log-add-val-1', 'log-add-val-2', 'log-add-val-3'].forEach(id => document.getElementById(id).value = "");
            save();
        };

        window.addEquipment = () => {
            const name = document.getElementById('in-eq-name').value;
            const cat = document.getElementById('in-eq-cat').value;
            if(!name) return;
            state.equipment.push({name, category:cat, date: document.getElementById('in-eq-date').value || new Date().toISOString().split('T')[0]});
            save(); closeModal('modal-equip'); document.getElementById('in-eq-name').value = "";
        };

        window.addLivestock = () => {
            const name = document.getElementById('in-lv-name').value;
            const cat = document.getElementById('in-lv-cat').value;
            if(!name) return;
            state.livestock.push({name, category:cat});
            save(); closeModal('modal-lives'); document.getElementById('in-lv-name').value = "";
        };

        window.deleteItem = (key, idx) => { if(confirm('Remove?')) { state[key].splice(idx, 1); save(); } };

        // --- SETTINGS ---
        function syncSettingsToUI() {
            document.getElementById('set-api-key').value = state.settings.apiKey;
            document.getElementById('set-volume').value = state.settings.volume;
            document.getElementById('set-start-date').value = state.settings.startDate;
            renderAdditiveConfig();
        }

        function renderAdditiveConfig() {
            document.getElementById('additive-inputs').innerHTML = state.settings.additiveNames.map((name, i) => `
                <div class="flex gap-2">
                    <input type="text" class="input-elegant flex-1 text-xs" value="${name}" onchange="updateAdditiveName(${i}, this.value)">
                    <button onclick="removeAdditive(${i})" class="text-coral-pink p-2">×</button>
                </div>
            `).join('');
            updateAdditiveSelects();
        }

        window.updateAdditiveName = (i, val) => { state.settings.additiveNames[i] = val; save(); };
        window.addAdditiveField = () => { state.settings.additiveNames.push('New Additive'); save(); renderAdditiveConfig(); };
        window.removeAdditive = (i) => { state.settings.additiveNames.splice(i, 1); save(); renderAdditiveConfig(); };

        function updateAdditiveSelects() {
            const opts = state.settings.additiveNames.map((n, i) => `<option value="${i}">${n}</option>`).join('');
            [1,2,3].forEach(i => {
                const el = document.getElementById(`log-add-type-${i}`);
                const v = el.value;
                el.innerHTML = `<option value="">Select...</option>` + opts;
                el.value = v;
            });
        }

        ['set-api-key', 'set-volume', 'set-start-date'].forEach(id => {
            document.getElementById(id).onchange = (e) => {
                const k = id.replace('set-', '').replace('api-key', 'apiKey').replace('start-date', 'startDate');
                state.settings[k] = e.target.value; save();
            };
        });

        // --- GEMINI ---
        window.handleChat = async () => {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !state.settings.apiKey) return;
            
            const history = document.getElementById('chat-history');
            history.innerHTML += `<div class="flex justify-end"><div class="bg-marine-blue text-ocean-deep p-3 rounded-2xl rounded-br-sm text-sm font-medium max-w-[85%] shadow-lg">${txt}</div></div>`;
            input.value = "";
            
            const aiId = 'ai-' + Date.now();
            history.innerHTML += `<div class="flex justify-start"><div id="${aiId}" class="card-glass p-4 rounded-2xl rounded-bl-sm text-sm text-slate-200 max-w-[90%] stream-cursor leading-relaxed">...</div></div>`;
            history.scrollTop = history.scrollHeight;

            try {
                const genAI = new GoogleGenerativeAI(state.settings.apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                const ctx = `Marine Aquarium Expert. Data: Vol ${state.settings.volume}L, Equip ${JSON.stringify(state.equipment)}, Lives ${JSON.stringify(state.livestock)}, Logs ${JSON.stringify(state.logs.slice(-5))}. Reply in JP politely.`;
                const res = await model.generateContentStream([ctx, txt]);
                const el = document.getElementById(aiId); el.innerText = "";
                let full = "";
                for await (const chunk of res.stream) { full += chunk.text(); el.innerText = full; history.scrollTop = history.scrollHeight; }
                el.classList.remove('stream-cursor');
            } catch (e) { document.getElementById(aiId).innerText = "Error: Check API Key."; }
        };

        window.exportData = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(state)],{type:'application/json'}));
            a.download = 'aqua_backup.json'; a.click();
        };
        window.clearAllData = () => { if(confirm('Reset all?')) { localStorage.clear(); location.reload(); } };

        init();
        window.addEventListener('resize', renderCharts);
    </script>
</body>
</html>
