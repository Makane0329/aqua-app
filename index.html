<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- iPhone PWA / Full Screen Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AQUA PRO">
    <meta name="theme-color" content="#000000">
    <title>RS AQUA PRO</title>

    <!-- External CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --rs-red: #e11d48;
            --rs-bg: #000000;
            --rs-card: #0c0c0c;
        }
        
        /* iPhoneのダイナミックビューポート対応 */
        html, body {
            height: 100dvh;
            margin: 0;
            padding: 0;
            background-color: var(--rs-bg);
            color: #f1f5f9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* 全体スクロールを禁止し、mainのみスクロール */
        }

        /* セーフエリア対応のヘッダー */
        header {
            padding-top: env(safe-area-inset-top);
            background-color: #000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* セーフエリア対応のナビゲーション */
        nav {
            padding-bottom: env(safe-area-inset-bottom);
            background-color: rgba(8, 8, 8, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 100;
        }

        .glass-card {
            background-color: var(--rs-card);
            border: 1px solid #1a1a1a;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(225, 29, 72, 0.4); border-radius: 10px; }

        /* ナビゲーションの活性状態 */
        .nav-item.active { color: #ffffff; }
        .nav-item.active .nav-icon-bg {
            background-color: var(--rs-red);
            box-shadow: 0 0 20px rgba(225, 29, 72, 0.5);
        }

        /* タブコンテンツの表示制御 */
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* チャット入力欄の浮遊配置 */
        #chat-input-container {
            position: fixed;
            bottom: calc(5.5rem + env(safe-area-inset-bottom));
            left: 0;
            right: 0;
            z-index: 90;
            display: none;
            padding: 0 1rem;
        }
        #chat-input-container.active { display: block; }
    </style>
</head>
<body class="flex flex-col">

    <!-- HEADER -->
    <header class="shrink-0">
        <div class="px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black flex items-center gap-2 tracking-tighter text-white uppercase">
                <span class="text-[#e11d48]">RS</span> AQUA PRO
            </h1>
            <div id="tank-volume-badge" class="px-3 py-1 bg-white/5 rounded-full border border-white/10 text-[10px] font-black text-slate-500 uppercase">
                TANK: 25L
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="main-scroll" class="flex-1 overflow-y-auto custom-scrollbar">
        
        <!-- Tab: Chat -->
        <section id="tab-chat" class="tab-content active p-5">
            <div id="chat-messages" class="space-y-6 pb-32">
                <div class="flex justify-start">
                    <div class="max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed bg-white/5 border border-white/10 rounded-tl-none shadow-lg">
                        System Ready. 写真を送っていただければ詳細を解析します。
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Equip -->
        <section id="tab-equip" class="tab-content p-6 space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-white tracking-widest uppercase">EQUIPMENT</h2>
                <button onclick="toggleForm('equip-form')" class="bg-white/5 border border-white/10 px-4 py-1.5 rounded-lg text-xs font-bold">ADD</button>
            </div>
            <div id="equip-form" class="hidden glass-card p-6 border-[#e11d48]/40 mb-8 animate-in">
                <div class="space-y-4">
                    <input id="eq-name" placeholder="製品名・型番" class="w-full bg-black border border-white/10 p-4 rounded-xl text-sm outline-none text-white">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="eq-cat" class="bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                            <option>スキマー</option><option>ポンプ</option><option>照明</option><option>ろ過装置</option>
                            <option>ヒーター</option><option>クーラー</option><option>ライブロック</option><option>その他</option>
                        </select>
                        <input id="eq-date" type="date" class="bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                    </div>
                    <button onclick="addEquipment()" class="w-full bg-[#e11d48] py-4 rounded-xl font-bold uppercase tracking-widest">Register Device</button>
                </div>
            </div>
            <div id="equip-list" class="space-y-4 pb-20"></div>
        </section>

        <!-- Tab: Livestock -->
        <section id="tab-live" class="tab-content p-6 space-y-10">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-white tracking-widest uppercase">LIVESTOCK</h2>
                <button onclick="toggleForm('live-form')" class="bg-white/5 border border-white/10 px-4 py-1.5 rounded-lg text-xs font-bold">ADD</button>
            </div>
            <div id="live-form" class="hidden glass-card p-6 border-[#e11d48]/40 mb-8 animate-in">
                <div class="space-y-4">
                    <input id="lv-name" placeholder="個体名称" class="w-full bg-black border border-white/10 p-4 rounded-xl text-sm outline-none text-white">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="lv-cat" class="bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                            <option value="FISH">FISH</option><option value="CORALS">CORALS</option><option value="OTHERS">OTHERS</option>
                        </select>
                        <input id="lv-date" type="date" class="bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                    </div>
                    <button onclick="addLivestock()" class="w-full bg-[#e11d48] py-4 rounded-xl font-bold uppercase tracking-widest">Register Life</button>
                </div>
            </div>
            <div id="live-list-fish" class="space-y-4"></div>
            <div id="live-list-corals" class="space-y-4"></div>
            <div id="live-list-others" class="space-y-4 pb-20"></div>
        </section>

        <!-- Tab: Logs -->
        <section id="tab-logs" class="tab-content p-6 space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-white tracking-widest uppercase">WATER LOGS</h2>
                <button onclick="toggleForm('log-form')" class="bg-white/5 border border-white/10 px-4 py-1.5 rounded-lg text-xs font-bold">ENTRY</button>
            </div>

            <div id="log-form" class="hidden glass-card p-6 border-[#e11d48]/50 mb-8 animate-in">
                <div class="space-y-6">
                    <div class="text-center">
                        <label class="text-[10px] font-black tracking-widest text-[#e11d48] mb-2 block uppercase">Density (SG)</label>
                        <input id="log-sg" type="number" step="0.001" value="1.025" class="w-full bg-black border border-white/5 p-6 rounded-3xl text-4xl font-mono text-white text-center outline-none">
                    </div>
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/10 space-y-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3 text-cyan-400 font-bold uppercase text-xs">水換え実施</div>
                            <input type="checkbox" id="log-wc-check" class="w-6 h-6 rounded bg-black border-white/20">
                        </div>
                        <input id="log-wc-vol" type="number" placeholder="換水量 (L)" class="w-full bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                    </div>
                    <div id="log-additives" class="space-y-3"></div>
                    <button onclick="addLog()" class="w-full bg-[#e11d48] py-4 rounded-2xl font-bold tracking-widest uppercase shadow-lg">Submit Data</button>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-card p-6 bg-black border-white/5">
                    <div class="text-[10px] font-black text-[#e11d48] mb-6 tracking-widest uppercase text-center">Specific Gravity (比重)</div>
                    <div id="chart-sg" class="h-32 w-full relative"></div>
                    <div class="flex justify-between text-[8px] mt-6 text-slate-700 font-black uppercase"><span>1.020</span><span>Ideal</span><span>1.030</span></div>
                </div>
                <div class="glass-card p-6 bg-black border-white/5 relative">
                    <div class="text-[10px] font-black text-cyan-400 mb-6 tracking-widest uppercase text-center">Water Change (0-15L Scale)</div>
                    <div id="chart-wc" class="h-32 w-full relative"></div>
                </div>
            </div>

            <div id="log-list" class="space-y-4 pb-20"></div>
        </section>

        <!-- Tab: Settings -->
        <section id="tab-set" class="tab-content p-6 space-y-12">
            <h2 class="text-xl font-black text-white tracking-widest uppercase">SETTINGS</h2>
            <div class="space-y-4">
                <label class="text-[10px] font-black tracking-widest text-slate-700 uppercase">System Total Volume (L)</label>
                <div class="flex gap-4">
                    <input id="set-tank-vol" type="number" class="flex-1 bg-black border border-white/10 p-5 rounded-2xl font-mono text-2xl text-[#e11d48]">
                    <button onclick="saveTankSettings()" class="bg-[#e11d48] px-8 rounded-xl font-bold uppercase">Save</button>
                </div>
            </div>
            <div class="space-y-4">
                <label class="text-[10px] font-black tracking-widest text-slate-700 uppercase">Additives Database</label>
                <div class="glass-card p-6 border-white/5 space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="add-name" placeholder="名称" class="bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                        <input id="add-dose" type="number" step="0.1" placeholder="ml/10L" class="bg-black border border-white/10 p-4 rounded-xl text-sm text-white">
                    </div>
                    <button onclick="addAdditiveToDB()" class="w-full bg-[#e11d48] py-4 rounded-xl text-sm font-bold uppercase">Update Database</button>
                    <div id="additive-db-list" class="space-y-3 pt-6 border-t border-white/5"></div>
                </div>
            </div>
            <div class="p-8 bg-white/5 rounded-3xl border border-white/5 mb-20 flex gap-5 text-[10px] italic text-slate-600 leading-relaxed shadow-inner">
                <i data-lucide="shield-alert" class="text-[#e11d48] shrink-0 w-6 h-6"></i>
                <p>Telemetry & Configuration. iPhoneから写真を撮影してAI相談が可能です。水槽情報に基づき管理をサポートします。</p>
            </div>
        </section>
    </main>

    <!-- FOOTER NAV -->
    <nav class="fixed bottom-0 left-0 right-0 border-t border-white/5 flex justify-around items-center pt-4">
        <button onclick="switchTab('chat')" class="nav-item flex flex-col items-center gap-1.5 flex-1 transition-all duration-300 active" data-tab="chat">
            <div class="nav-icon-bg p-2.5 rounded-2xl transition-all mb-1"><i data-lucide="message-square" class="w-6 h-6"></i></div>
            <span class="text-[9px] font-black tracking-tighter">CHAT</span>
        </button>
        <button onclick="switchTab('equip')" class="nav-item flex flex-col items-center gap-1.5 flex-1 transition-all duration-300" data-tab="equip">
            <div class="nav-icon-bg p-2.5 rounded-2xl transition-all mb-1"><i data-lucide="wrench" class="w-6 h-6"></i></div>
            <span class="text-[9px] font-black tracking-tighter">EQUIP</span>
        </button>
        <button onclick="switchTab('live')" class="nav-item flex flex-col items-center gap-1.5 flex-1 transition-all duration-300" data-tab="live">
            <div class="nav-icon-bg p-2.5 rounded-2xl transition-all mb-1"><i data-lucide="fish" class="w-6 h-6"></i></div>
            <span class="text-[9px] font-black tracking-tighter">LIVE</span>
        </button>
        <button onclick="switchTab('logs')" class="nav-item flex flex-col items-center gap-1.5 flex-1 transition-all duration-300" data-tab="logs">
            <div class="nav-icon-bg p-2.5 rounded-2xl transition-all mb-1"><i data-lucide="line-chart" class="w-6 h-6"></i></div>
            <span class="text-[9px] font-black tracking-tighter">LOGS</span>
        </button>
        <button onclick="switchTab('set')" class="nav-item flex flex-col items-center gap-1.5 flex-1 transition-all duration-300" data-tab="set">
            <div class="nav-icon-bg p-2.5 rounded-2xl transition-all mb-1"><i data-lucide="settings" class="w-6 h-6"></i></div>
            <span class="text-[9px] font-black tracking-tighter">SET</span>
        </button>
    </nav>

    <!-- FLOATING CHAT INPUT -->
    <div id="chat-input-container" class="max-w-2xl mx-auto active">
        <div class="flex gap-3 bg-black/90 p-2 rounded-3xl border border-white/10 shadow-2xl backdrop-blur-md">
            <button onclick="document.getElementById('chat-file').click()" class="p-4 bg-white/5 border border-white/10 rounded-2xl text-slate-500 active:text-white">
                <i data-lucide="camera" class="w-6 h-6"></i>
            </button>
            <input id="chat-file" type="file" class="hidden" accept="image/*">
            <input id="chat-input-text" type="text" placeholder="AIへ相談..." class="flex-1 bg-transparent px-4 text-sm outline-none text-white">
            <button onclick="sendMessage()" class="bg-[#e11d48] px-6 rounded-2xl shadow-lg"><i data-lucide="send" class="w-6 h-6 text-white"></i></button>
        </div>
    </div>

    <!-- MODULE SCRIPTS -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, query, onSnapshot, 
            deleteDoc, doc, updateDoc, Timestamp, setDoc 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const configRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(configRaw);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aquarium-manager-rs-final';
        const apiKey = ""; 

        let state = {
            user: null,
            equipment: [],
            livestock: [],
            logs: [],
            additives: [],
            tankSettings: { volume: 25 }
        };

        // --- Core Functions ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            const chatInput = document.getElementById('chat-input-container');
            if (tabId === 'chat') chatInput.classList.add('active');
            else chatInput.classList.remove('active');

            window.lucide.createIcons();
            document.getElementById('main-scroll').scrollTop = 0;
        };

        window.toggleForm = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        };

        // --- Data Handling ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                initListeners();
            } else {
                await signInAnonymously(auth);
            }
        });

        function initListeners() {
            const uid = state.user.uid;
            
            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'equipment')), s => {
                state.equipment = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderEquipment();
            });

            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'livestock')), s => {
                state.livestock = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderLivestock();
            });

            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'salinity_logs')), s => {
                state.logs = s.docs.map(d => ({id: d.id, ...d.data(), date: d.data().date?.toDate() || new Date()}))
                                .sort((a,b) => b.date - a.date);
                renderLogs();
            });

            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'additive_list')), s => {
                state.additives = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderLogs(); // To update additive dropdowns
                renderSettings();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'settings', 'tank'), d => {
                if (d.exists()) {
                    state.tankSettings = d.data();
                    document.getElementById('tank-volume-badge').innerText = `SYS: ${state.tankSettings.volume}L`;
                    document.getElementById('set-tank-vol').value = state.tankSettings.volume;
                }
            });
        }

        // --- Renderers ---
        function renderEquipment() {
            const list = document.getElementById('equip-list');
            list.innerHTML = state.equipment.map(e => `
                <div class="glass-card p-4 flex justify-between items-center group active:bg-white/5 transition-colors">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="p-3 bg-white/5 rounded-xl text-[#e11d48]"><i data-lucide="box" class="w-5 h-5"></i></div>
                        <div class="overflow-hidden">
                            <div class="text-[9px] font-black text-[#e11d48] uppercase tracking-widest">${e.category}</div>
                            <div class="font-bold text-white truncate leading-tight">${e.name}</div>
                            <div class="text-[9px] text-slate-500 font-bold mt-0.5 uppercase">SINCE: ${e.installDate}</div>
                        </div>
                    </div>
                    <button onclick="deleteDoc('equipment', '${e.id}')" class="p-3 text-slate-800 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('');
            window.lucide.createIcons();
        }

        function renderLivestock() {
            const categories = ["FISH", "CORALS", "OTHERS"];
            categories.forEach(cat => {
                const list = document.getElementById(`live-list-${cat.toLowerCase()}`);
                const items = state.livestock.filter(l => (cat === 'OTHERS' && !['FISH', 'CORALS'].includes(l.type)) || l.type === cat);
                list.innerHTML = `
                    <div class="flex items-center gap-4 my-4">
                        <span class="text-[10px] font-black tracking-[0.4em] text-slate-700 uppercase">${cat}</span>
                        <div class="h-px flex-1 bg-white/5"></div>
                    </div>
                    ${items.map(l => `
                        <div class="glass-card p-4 flex justify-between items-center active:bg-white/5">
                            <div class="flex items-center gap-3">
                                <div class="p-3 rounded-xl border ${cat==='CORALS'?'border-cyan-500/20 text-cyan-400':'border-[#e11d48]/20 text-[#e11d48]'}">
                                    <i data-lucide="fish" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-white truncate leading-tight">${l.name}</div>
                                    <div class="text-[9px] text-slate-500 font-bold uppercase mt-1">EST: ${l.installDate}</div>
                                </div>
                            </div>
                            <button onclick="deleteDoc('livestock', '${l.id}')" class="p-3 text-slate-800 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    `).join('')}
                `;
            });
            window.lucide.createIcons();
        }

        function renderLogs() {
            const list = document.getElementById('log-list');
            const recent = [...state.logs].slice(0, 14).reverse();

            // Chart SG
            const sgChart = document.getElementById('chart-sg');
            if (recent.length >= 2) {
                const points = recent.map((l, i) => `${(i/(recent.length-1))*100},${100-((l.value-1.020)/0.01)*100}`).join(' ');
                sgChart.innerHTML = `
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full">
                        <polyline fill="none" stroke="#e11d48" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" points="${points}" style="filter: drop-shadow(0 0 8px rgba(225,29,72,0.5))" />
                    </svg>
                `;
            }

            // Chart WC
            const wcChart = document.getElementById('chart-wc');
            wcChart.innerHTML = `
                <div class="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-20">
                    <div class="border-t border-cyan-400 w-full flex justify-end pr-1 pt-1"><span class="text-[6px] font-black text-cyan-400">15L</span></div>
                    <div class="border-t border-cyan-400 w-full opacity-50 flex justify-end pr-1 pt-1"><span class="text-[6px] font-black text-cyan-400">7.5L</span></div>
                    <div class="border-t border-cyan-400 w-full opacity-20"></div>
                </div>
                <div class="flex items-end gap-1 h-full px-1 relative z-10">
                    ${recent.map(l => {
                        const h = (Math.min(l.waterChangeVolume || 0, 15) / 15) * 100;
                        return `<div class="bg-cyan-500/40 flex-1 rounded-t-sm transition-all active:bg-cyan-400" style="height: ${h}%"></div>`;
                    }).join('')}
                </div>
            `;

            // List
            list.innerHTML = state.logs.map(l => `
                <div class="glass-card p-5 bg-white/[0.01]">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-[9px] text-slate-700 font-mono tracking-widest mb-2 uppercase">${l.date.toLocaleString()}</div>
                            <div class="flex items-center gap-4">
                                <div class="text-2xl font-mono font-black ${l.value >= 1.024 && l.value <= 1.026 ? 'text-white' : 'text-amber-500'}">${l.value.toFixed(3)}</div>
                                ${l.waterChange ? `<div class="px-2 py-1 bg-cyan-500/10 text-cyan-400 text-[9px] font-black rounded-lg border border-cyan-500/20">WC: ${l.waterChangeVolume}L</div>` : ''}
                            </div>
                        </div>
                        <button onclick="deleteDoc('salinity_logs', '${l.id}')" class="text-slate-800 hover:text-red-600 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                    ${l.additiveEntries?.length ? `
                        <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-white/5">
                            ${l.additiveEntries.map(ae => `<div class="text-[10px] text-slate-400 font-bold bg-white/5 px-2 py-1 rounded">${ae.name}: <span class="text-[#e11d48]">${ae.ml}ml</span></div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // Additive slots in form
            const addForm = document.getElementById('log-additives');
            if (addForm) {
                addForm.innerHTML = [0,1,2].map(idx => `
                    <div class="grid grid-cols-2 gap-3">
                        <select id="log-add-name-${idx}" class="bg-black border border-white/10 p-3 rounded-xl text-xs text-white">
                            <option value="">None</option>
                            ${state.additives.map(a => `<option value="${a.name}">${a.name}</option>`).join('')}
                        </select>
                        <input id="log-add-drop-${idx}" type="number" placeholder="Drops" class="bg-black border border-white/10 p-3 rounded-xl text-xs text-white">
                    </div>
                `).join('');
            }

            window.lucide.createIcons();
        }

        function renderSettings() {
            const list = document.getElementById('additive-db-list');
            list.innerHTML = state.additives.map(a => `
                <div class="flex justify-between items-center p-5 bg-white/[0.01] rounded-2xl border border-white/5">
                    <div>
                        <div class="text-sm font-bold text-white tracking-tight">${a.name}</div>
                        <div class="text-[10px] text-[#e11d48] font-black tracking-widest uppercase mt-2">Dose: ${a.dosePer10L}ml / 10L</div>
                    </div>
                    <button onclick="deleteDoc('additive_list', '${a.id}')" class="text-slate-800 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('');
            window.lucide.createIcons();
        }

        // --- Interaction Handlers ---
        window.addEquipment = async () => {
            const name = document.getElementById('eq-name').value;
            const category = document.getElementById('eq-cat').value;
            const installDate = document.getElementById('eq-date').value;
            if(!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'equipment'), { name, category, installDate, dateAdded: Timestamp.now() });
            document.getElementById('equip-form').classList.add('hidden');
            document.getElementById('eq-name').value = '';
        };

        window.addLivestock = async () => {
            const name = document.getElementById('lv-name').value;
            const type = document.getElementById('lv-cat').value;
            const installDate = document.getElementById('lv-date').value;
            if(!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'livestock'), { name, type, installDate, dateAdded: Timestamp.now() });
            document.getElementById('live-form').classList.add('hidden');
            document.getElementById('lv-name').value = '';
        };

        window.addLog = async () => {
            const value = parseFloat(document.getElementById('log-sg').value);
            const waterChange = document.getElementById('log-wc-check').checked;
            const waterChangeVolume = parseFloat(document.getElementById('log-wc-vol').value) || 0;
            const DROP_TO_ML = 0.05;
            
            const entries = [0,1,2].map(idx => ({
                name: document.getElementById(`log-add-name-${idx}`).value,
                drops: parseInt(document.getElementById(`log-add-drop-${idx}`).value) || 0
            })).filter(e => e.name);

            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'salinity_logs'), {
                value, waterChange, waterChangeVolume,
                additiveEntries: entries.map(e => ({...e, ml: (e.drops * DROP_TO_ML).toFixed(2)})),
                date: Timestamp.now()
            });
            document.getElementById('log-form').classList.add('hidden');
            document.getElementById('log-wc-check').checked = false;
            document.getElementById('log-wc-vol').value = '';
        };

        window.saveTankSettings = async () => {
            const volume = parseFloat(document.getElementById('set-tank-vol').value);
            await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'tank'), { volume });
        };

        window.addAdditiveToDB = async () => {
            const name = document.getElementById('add-name').value;
            const dosePer10L = parseFloat(document.getElementById('add-dose').value);
            if(!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'additive_list'), { name, dosePer10L });
            document.getElementById('add-name').value = '';
            document.getElementById('add-dose').value = '';
        };

        window.deleteDoc = async (col, id) => {
            if(!confirm("削除しますか？")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, col, id));
        };

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input-text');
            const text = input.value.trim();
            if(!text) return;

            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `<div class="flex justify-end"><div class="max-w-[85%] p-4 rounded-2xl text-sm bg-[#e11d48] text-white font-bold rounded-tr-none shadow-lg">${text}</div></div>`;
            input.value = '';

            const typingId = 'typing-' + Date.now();
            chatBox.innerHTML += `<div id="${typingId}" class="text-[10px] font-mono text-[#e11d48] animate-pulse uppercase ml-2">Analyzing...</div>`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text }] }],
                        systemInstruction: { parts: [{ text: "プロのアクアリストとして、Red Sea製などの機材や比重データに基づき日本語で回答してください。" }] }
                    })
                });
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "エラーが発生しました。";
                document.getElementById(typingId).remove();
                chatBox.innerHTML += `<div class="flex justify-start"><div class="max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed bg-white/5 border border-white/10 rounded-tl-none">${aiText}</div></div>`;
            } catch(e) {
                document.getElementById(typingId).innerText = "ERROR.";
            }
            window.lucide.createIcons();
            document.getElementById('main-scroll').scrollTop = document.getElementById('main-scroll').scrollHeight;
        };

        window.addEventListener('DOMContentLoaded', () => {
            window.lucide.createIcons();
        });
    </script>
</body>
</html>
