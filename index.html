<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Aqua Control Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --rs-red: #ff0033;
            --rs-red-dark: #cc0029;
            --rs-cyan: #00ffff;
            --rs-black: #020617;
            --rs-gray: #111827;
        }
        body {
            background-color: var(--rs-black);
            color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .glass {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .active-tab { color: var(--rs-red); }
        .active-tab svg { filter: drop-shadow(0 0 4px var(--rs-red)); }
        
        .content-area {
            height: calc(100dvh - 64px - 64px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            overflow-y: auto;
            scrollbar-width: none;
        }
        .content-area::-webkit-scrollbar { display: none; }

        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        
        input, select, textarea {
            background: #1f2937;
            border: 1px solid #374151;
            color: white;
            padding: 12px;
            border-radius: 12px;
            outline: none;
            width: 100%;
        }
        input:focus { border-color: var(--rs-cyan); }

        .card {
            background: linear-gradient(145deg, #111827, #0f172a);
            border: 1px solid #1e293b;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 16px;
        }

        .ai-gradient {
            background: linear-gradient(135deg, #4f46e5, #9333ea, #db2777);
            background-size: 200% 200%;
            animation: moveGradient 4s ease infinite;
        }

        @keyframes moveGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #modal-container { transition: opacity 0.3s ease; }
        #modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="safe-top safe-bottom">

    <header class="px-6 py-4 flex justify-between items-center glass border-b border-white/5 sticky top-0 z-50">
        <div>
            <h1 class="text-xs font-black tracking-[0.2em] text-gray-500 uppercase">Marine System</h1>
            <div class="text-xl font-bold tracking-tighter flex items-center gap-1">
                <span style="color: var(--rs-red);">AQUA</span>
                <span>CONTROL</span>
                <span class="text-[10px] bg-red-600 px-1 rounded text-white ml-1">PRO</span>
            </div>
        </div>
        <div id="tank-name-display" class="text-[10px] text-cyan-400 font-mono bg-cyan-950/30 px-3 py-1 rounded-full border border-cyan-800/50">--</div>
    </header>

    <main id="app-content" class="content-area px-5 py-6">
        <!-- JS injects here -->
    </main>

    <!-- Modal Overlay -->
    <div id="modal-container" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div id="modal-content" class="absolute bottom-0 left-0 right-0 glass rounded-t-3xl border-t border-white/10 p-8 transform translate-y-full max-h-[95dvh] overflow-y-auto">
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-around items-center safe-bottom z-50 h-20">
        <button onclick="router('CHAT')" id="nav-CHAT" class="flex flex-col items-center flex-1 py-2 text-gray-500 btn-press">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            <span class="text-[9px] font-bold mt-1 tracking-widest">CHAT</span>
        </button>
        <button onclick="router('EQUIP')" id="nav-EQUIP" class="flex flex-col items-center flex-1 py-2 text-gray-500 btn-press">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            <span class="text-[9px] font-bold mt-1 tracking-widest">EQUIP</span>
        </button>
        <button onclick="router('LIVES')" id="nav-LIVES" class="flex flex-col items-center flex-1 py-2 text-gray-500 btn-press">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            <span class="text-[9px] font-bold mt-1 tracking-widest">LIVES</span>
        </button>
        <button onclick="router('LOGS')" id="nav-LOGS" class="flex flex-col items-center flex-1 py-2 text-gray-500 btn-press">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            <span class="text-[9px] font-bold mt-1 tracking-widest">LOGS</span>
        </button>
        <button onclick="router('SET')" id="nav-SET" class="flex flex-col items-center flex-1 py-2 text-gray-500 btn-press">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
            <span class="text-[9px] font-bold mt-1 tracking-widest">SET</span>
        </button>
    </nav>

    <script>
        const DEFAULT_STATE = {
            settings: { 
                tankName: "30cm Cube", 
                volume: 27,
                additives: ["カルシウム", "マグネシウム", "KHアップ"]
            },
            equipment: [
                { id: 1, name: "ReefLED 50", category: "LIGHT", date: "2025-01-10" },
                { id: 2, name: "ライブロック", category: "ROCK", date: "2025-01-10" }
            ],
            lives: [
                { id: 1, name: "カクレクマノミ", category: "FISH", note: "ペア" }
            ],
            logs: [
                { id: 1, date: "2026-01-20", salinity: 1.023, waterChange: 5, additives: [] },
                { id: 2, date: "2026-01-23", salinity: 1.024, waterChange: 0, additives: [{name: "カルシウム", drops: 20}] },
                { id: 3, date: "2026-01-25", salinity: 1.025, waterChange: 8, additives: [] }
            ],
            chatHistory: []
        };

        let state = JSON.parse(localStorage.getItem('aqua_pro_v6')) || DEFAULT_STATE;
        let currentPage = 'LOGS';
        const apiKey = "";
        let isAiThinking = false;
        let selectedImageBase64 = null;

        // --- Core Helpers ---
        function save() {
            localStorage.setItem('aqua_pro_v6', JSON.stringify(state));
            document.getElementById('tank-name-display').innerText = `${state.settings.tankName} / ${state.settings.volume}L`;
        }

        async function callGemini(prompt, systemPrompt = "", imageBase64 = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        ...(imageBase64 ? [{ inlineData: { mimeType: "image/png", data: imageBase64.split(',')[1] } }] : [])
                    ]
                }],
                systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined
            };

            const fetchWithRetry = async (retries = 5, delay = 1000) => {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(retries - 1, delay * 2);
                    }
                    throw error;
                }
            };

            const data = await fetchWithRetry();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "回答を生成できませんでした。";
        }

        function openModal(contentHtml) {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-body').innerHTML = contentHtml;
            container.classList.remove('hidden');
            setTimeout(() => {
                container.style.opacity = '1';
                content.style.transform = 'translateY(0)';
            }, 10);
        }

        function closeModal() {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            container.style.opacity = '0';
            content.style.transform = 'translateY(100%)';
            setTimeout(() => container.classList.add('hidden'), 300);
        }

        function router(page) {
            currentPage = page;
            render();
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab'));
            document.getElementById(`nav-${page}`).classList.add('active-tab');
        }

        function render() {
            const container = document.getElementById('app-content');
            container.innerHTML = '';
            switch(currentPage) {
                case 'CHAT': renderChat(container); break;
                case 'EQUIP': renderEquip(container); break;
                case 'LIVES': renderLives(container); break;
                case 'LOGS': renderLogs(container); break;
                case 'SET': renderSettings(container); break;
            }
        }

        // --- Pages ---

        function renderChat(el) {
            el.innerHTML = `
                <div class="flex flex-col h-full relative">
                    <div id="chat-messages" class="flex-1 space-y-6 pb-32">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center flex-shrink-0 text-xs font-bold">AI</div>
                            <div class="bg-white/5 p-4 rounded-2xl rounded-tl-none text-sm leading-relaxed border border-white/5">
                                こんにちは。アクアリウムに関するお悩みは何でもお任せください。
                            </div>
                        </div>
                        ${state.chatHistory.map(m => `
                            <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} gap-3">
                                ${m.role === 'model' ? '<div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center flex-shrink-0 text-xs font-bold">AI</div>' : ''}
                                <div class="p-4 rounded-2xl ${m.role === 'user' ? 'bg-red-600 rounded-tr-none' : 'bg-white/5 rounded-tl-none border border-white/5'} text-sm leading-relaxed max-w-[85%]">
                                    ${m.image ? `<img src="${m.image}" class="rounded-lg mb-2 max-h-48">` : ''}
                                    ${m.text}
                                </div>
                            </div>
                        `).join('')}
                        ${isAiThinking ? `
                            <div class="flex gap-3 loading-pulse">
                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0 text-xs font-bold">AI</div>
                                <div class="bg-white/5 p-4 rounded-2xl rounded-tl-none text-xs border border-white/5 italic text-gray-400">分析中...</div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="fixed bottom-24 left-5 right-5 z-40">
                        ${selectedImageBase64 ? `
                            <div class="relative inline-block mb-2">
                                <img src="${selectedImageBase64}" class="w-16 h-16 rounded-lg border-2 border-cyan-400 object-cover">
                                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-600 rounded-full w-5 h-5 text-[10px] flex items-center justify-center">×</button>
                            </div>
                        ` : ''}
                        <div class="glass p-2 rounded-2xl border border-white/10 flex gap-2 shadow-2xl">
                            <input type="file" id="image-upload" class="hidden" accept="image/*" onchange="handleImageSelect(event)">
                            <button onclick="document.getElementById('image-upload').click()" class="w-12 h-12 rounded-xl flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            </button>
                            <input id="chat-input" type="text" class="flex-1 bg-transparent border-none p-3 text-sm" placeholder="AIに相談する...">
                            <button onclick="sendChat()" class="bg-red-600 w-12 h-12 rounded-xl flex items-center justify-center btn-press">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            const box = document.getElementById('chat-messages');
            box.scrollTop = box.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text && !selectedImageBase64) return;
            const currentImg = selectedImageBase64;
            state.chatHistory.push({ role: 'user', text: text || "画像を分析してください", image: currentImg });
            input.value = ''; selectedImageBase64 = null;
            isAiThinking = true; renderChat(document.getElementById('app-content'));
            const systemPrompt = `水槽コンシェルジュ。水槽: ${state.settings.tankName}, ${state.settings.volume}L. 丁寧な敬語。`;
            try {
                const response = await callGemini(text || "分析中...", systemPrompt, currentImg);
                state.chatHistory.push({ role: 'model', text: response });
                save();
            } catch (e) { state.chatHistory.push({ role: 'model', text: "エラーが発生しました。" }); }
            finally { isAiThinking = false; renderChat(document.getElementById('app-content')); }
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (re) => { selectedImageBase64 = re.target.result; renderChat(document.getElementById('app-content')); };
            reader.readAsDataURL(file);
        }

        function clearImage() { selectedImageBase64 = null; renderChat(document.getElementById('app-content')); }

        function renderEquip(el) {
            el.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-end">
                        <h2 class="text-2xl font-bold tracking-tight">EQUIPMENT</h2>
                        <button onclick="aiSetupReview()" class="ai-gradient px-4 py-2 rounded-xl text-[10px] font-bold tracking-widest uppercase flex items-center gap-2">✨ 診断</button>
                    </div>
                    <div class="grid gap-4">
                        ${state.equipment.map(e => `
                            <div class="card p-4 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center border border-white/5">
                                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <div><div class="font-bold">${e.name}</div><div class="text-[10px] text-gray-500 uppercase">${e.category}</div></div>
                                </div>
                                <button onclick="deleteItem('equipment', ${e.id})" class="text-gray-700 hover:text-red-500 p-2">×</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="showAddEquipModal()" class="w-full bg-white text-black py-4 rounded-2xl font-bold tracking-widest text-xs btn-press">+ ADD SYSTEM</button>
                </div>
            `;
        }

        async function aiSetupReview() {
            openModal(`<div class="loading-pulse py-8 text-center text-xs">分析中...</div>`);
            const prompt = `水量${state.settings.volume}L, 設備${state.equipment.map(e=>e.name)}.`;
            try {
                const response = await callGemini(prompt, "システムレビュー担当。");
                openModal(`<div class="space-y-4"><h3 class="text-lg font-bold">✨ AI診断</h3><div class="text-sm text-gray-300 whitespace-pre-wrap">${response}</div><button onclick="closeModal()" class="w-full bg-white/10 py-4 rounded-xl font-bold mt-4">閉じる</button></div>`);
            } catch (e) { closeModal(); }
        }

        function renderLives(el) {
            el.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-end">
                        <h2 class="text-2xl font-bold tracking-tight">LIVES</h2>
                        <button onclick="aiCompatibilityCheck()" class="ai-gradient px-4 py-2 rounded-xl text-[10px] font-bold tracking-widest uppercase">✨ 相性診断</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${state.lives.map(l => `
                            <div class="card p-5 relative">
                                <div class="text-[9px] text-cyan-400 font-bold mb-1 opacity-70 uppercase tracking-tighter">${l.category}</div>
                                <div class="font-bold text-lg leading-tight mb-2">${l.name}</div>
                                <div class="flex items-center justify-between mt-auto">
                                    <button onclick="aiLifeProfile(${l.id})" class="text-[9px] font-bold text-gray-400 hover:text-white uppercase border border-white/10 px-2 py-1 rounded">✨ ガイド</button>
                                    <button onclick="deleteItem('lives', ${l.id})" class="text-red-900 p-1">×</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="showAddLiveModal()" class="w-full bg-white text-black py-4 rounded-2xl font-bold tracking-widest text-xs btn-press">+ ADD BIOTA</button>
                </div>
            `;
        }

        async function aiLifeProfile(id) {
            const life = state.lives.find(l=>l.id===id);
            openModal(`<div class="loading-pulse py-8 text-center text-xs">検索中...</div>`);
            try {
                const response = await callGemini(`${life.name}の飼育ガイド。`, "海洋生物学者として回答。");
                openModal(`<div class="space-y-4"><h3 class="text-lg font-bold">✨ ${life.name} ガイド</h3><div class="text-sm text-gray-300 whitespace-pre-wrap">${response}</div><button onclick="closeModal()" class="w-full bg-white/10 py-4 rounded-xl font-bold mt-4">閉じる</button></div>`);
            } catch (e) { closeModal(); }
        }

        async function aiCompatibilityCheck() {
            openModal(`<div class="loading-pulse py-8 text-center text-xs">診断中...</div>`);
            try {
                const response = await callGemini(`生体リスト: ${state.lives.map(l=>l.name).join(', ')}.`, "相性分析。");
                openModal(`<div class="space-y-4"><h3 class="text-lg font-bold">相性診断</h3><div class="text-sm text-gray-300 whitespace-pre-wrap">${response}</div><button onclick="closeModal()" class="w-full bg-white/10 py-4 rounded-xl font-bold mt-4">閉じる</button></div>`);
            } catch (e) { closeModal(); }
        }

        function renderLogs(el) {
            const maxSal = 1.030, minSal = 1.020;
            const logData = [...state.logs].sort((a,b) => new Date(a.date) - new Date(b.date));
            const recentLogs = logData.slice(-7);
            const points = recentLogs.map((l, i) => {
                const x = (i / 6) * 100;
                const y = 100 - ((l.salinity - minSal) / (maxSal - minSal) * 100);
                return `${x},${y}`;
            }).join(' ');

            el.innerHTML = `
                <div class="space-y-8">
                    <!-- Prominent New Log Button at top -->
                    <button onclick="showLogForm()" class="w-full bg-red-600 py-5 rounded-2xl font-black tracking-[0.3em] text-sm btn-press shadow-2xl shadow-red-600/20 sticky top-0 z-10 uppercase">
                        + NEW LOG ENTRY
                    </button>

                    <div class="flex justify-between items-end">
                        <h2 class="text-2xl font-bold tracking-tight">ANALYTICS</h2>
                        <button onclick="aiMaintenancePlan()" class="ai-gradient px-4 py-2 rounded-xl text-[10px] font-bold tracking-widest uppercase">✨ トレンド分析</button>
                    </div>

                    <div class="space-y-4">
                        <div class="card p-6 h-40 relative">
                            <svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full overflow-visible">
                                <path d="M ${points}" fill="none" stroke="var(--rs-cyan)" stroke-width="2" vector-effect="non-scaling-stroke" />
                                ${recentLogs.map((l, i) => `<circle cx="${(i/6)*100}" cy="${100 - ((l.salinity - minSal) / (maxSal - minSal) * 100)}" r="1.5" fill="white" />`).join('')}
                            </svg>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center"><h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Maintenance History</h3></div>
                        <div class="space-y-3">
                            ${state.logs.slice().reverse().map(l => `
                                <div class="card p-4 flex justify-between items-center" onclick="showLogForm(${l.id})">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-1"><span class="text-xs font-bold text-gray-400 font-mono">${l.date}</span><span class="text-xs px-2 py-0.5 rounded bg-cyan-900/30 text-cyan-400 font-bold">SG ${l.salinity}</span></div>
                                        <div class="flex flex-wrap gap-2 text-[10px]">
                                            ${l.waterChange > 0 ? `<span class="text-red-400">WC: ${l.waterChange}L</span>` : ''}
                                            ${l.additives?.map(a => `<span class="text-gray-500">${a.name}: ${a.drops}滴 (${(a.drops * 0.05).toFixed(2)}ml)</span>`).join('') || ''}
                                        </div>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        async function aiMaintenancePlan() {
            openModal(`<div class="loading-pulse py-8 text-center text-xs text-gray-500 uppercase">Analyzing trends...</div>`);
            try {
                const response = await callGemini(`水量${state.settings.volume}L, ログ${JSON.stringify(state.logs.slice(-3))}.`, "メンテ担当。");
                openModal(`<div class="space-y-4"><h3 class="text-lg font-bold">✨ トレンド診断</h3><div class="text-sm text-gray-300 whitespace-pre-wrap">${response}</div><button onclick="closeModal()" class="w-full bg-white/10 py-4 rounded-xl font-bold mt-4">了解</button></div>`);
            } catch (e) { closeModal(); }
        }

        // --- Log Form ---
        function showLogForm(id = null) {
            const entry = id ? state.logs.find(l => l.id === id) : { date: new Date().toISOString().split('T')[0], salinity: 1.024, waterChange: 0, additives: [] };
            const ads = entry.additives || [];
            
            openModal(`
                <h3 class="text-xl font-bold mb-6 tracking-tight">${id ? 'Edit Entry' : 'New Maintenance Log'}</h3>
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase block mb-1 tracking-widest">Date</label><input type="date" id="l-date" value="${entry.date}"></div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase block mb-1 tracking-widest">Salinity SG</label><input type="number" id="l-sal" step="0.001" value="${entry.salinity}"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase block mb-1 tracking-widest">Water Change (L)</label><input type="number" id="l-wc" value="${entry.waterChange}"></div>
                    
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-gray-500 uppercase block tracking-widest">Additives (3 Slots)</label>
                        ${[0, 1, 2].map(i => `
                            <div class="flex gap-2 items-center">
                                <select id="l-an-${i}" class="flex-1">
                                    <option value="">- 選択 -</option>
                                    ${state.settings.additives.map(name => `<option value="${name}" ${ads[i]?.name === name ? 'selected' : ''}>${name}</option>`).join('')}
                                </select>
                                <div class="w-32 relative">
                                    <input type="number" id="l-av-${i}" placeholder="滴" class="pr-8" value="${ads[i]?.drops || ''}" oninput="updateMlHint(${i})">
                                    <span class="absolute right-3 top-3 text-[10px] text-gray-500">滴</span>
                                </div>
                            </div>
                            <div id="ml-hint-${i}" class="text-[9px] text-right text-gray-600 mt-[-8px]">
                                ${ads[i] ? (ads[i].drops * 0.05).toFixed(2) + ' ml' : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex gap-3 pt-4">
                        ${id ? `<button onclick="deleteItem('logs', ${id}); closeModal();" class="flex-1 bg-red-900/50 text-red-500 py-4 rounded-xl font-bold text-xs uppercase tracking-widest">Delete</button>` : ''}
                        <button onclick="saveLog(${id})" class="flex-[2] bg-red-600 py-4 rounded-xl font-bold text-xs uppercase tracking-widest btn-press">Record Entry</button>
                    </div>
                </div>
            `);
        }

        function updateMlHint(i) {
            const drops = document.getElementById(`l-av-${i}`).value;
            const hint = document.getElementById(`ml-hint-${i}`);
            if(drops) {
                hint.innerText = (parseFloat(drops) * 0.05).toFixed(2) + ' ml';
            } else {
                hint.innerText = '';
            }
        }

        function saveLog(id) {
            const date = document.getElementById('l-date').value, sal = parseFloat(document.getElementById('l-sal').value), wc = parseFloat(document.getElementById('l-wc').value), additives = [];
            for(let i=0; i<3; i++){
                const name = document.getElementById(`l-an-${i}`).value, drops = parseFloat(document.getElementById(`l-av-${i}`).value);
                if(name && !isNaN(drops)) additives.push({ name, drops });
            }
            if(id) { const idx = state.logs.findIndex(l => l.id === id); state.logs[idx] = { id, date, salinity: sal, waterChange: wc, additives }; }
            else { state.logs.push({ id: Date.now(), date, salinity: sal, waterChange: wc, additives }); }
            save(); closeModal(); render();
        }

        function renderSettings(el) {
            el.innerHTML = `
                <div class="space-y-8 pb-20">
                    <h2 class="text-2xl font-bold tracking-tight uppercase">Settings</h2>
                    <div class="card p-6 space-y-6">
                        <div class="space-y-4">
                            <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Tank Identifier</label><input type="text" id="set-name" value="${state.settings.tankName}"></div>
                            <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Total Volume (L)</label><input type="number" id="set-vol" value="${state.settings.volume}"></div>
                        </div>
                        <button onclick="updateSettings()" class="w-full bg-cyan-600 py-4 rounded-2xl font-bold tracking-widest text-xs btn-press">SYNC CONFIG</button>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Additives Management</h3>
                        <div class="card p-4 space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="new-additive-name" placeholder="添加剤名 (例: KH)" class="flex-1">
                                <button onclick="addAdditiveType()" class="bg-white text-black px-4 rounded-xl text-xs font-bold">ADD</button>
                            </div>
                            <div class="space-y-2">
                                ${state.settings.additives.map((name, idx) => `
                                    <div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0">
                                        <span class="text-sm">${name}</span>
                                        <button onclick="removeAdditiveType(${idx})" class="text-red-900 p-1 text-xs">Remove</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="pt-10 text-center"><button onclick="resetData()" class="text-red-900 text-[10px] font-bold tracking-[0.3em]">Purge System Data</button></div>
                </div>
            `;
        }

        function addAdditiveType() {
            const name = document.getElementById('new-additive-name').value.trim();
            if(name) {
                state.settings.additives.push(name);
                save(); render();
            }
        }

        function removeAdditiveType(idx) {
            state.settings.additives.splice(idx, 1);
            save(); render();
        }

        function updateSettings() { state.settings.tankName = document.getElementById('set-name').value; state.settings.volume = parseFloat(document.getElementById('set-vol').value); save(); render(); alert('UPDATED'); }

        function showAddEquipModal() {
            openModal(`<h3 class="text-xl font-bold mb-6">New Equipment</h3><div class="space-y-4"><input type="text" id="m-name" placeholder="Device Name"><select id="m-cat"><option value="LIGHT">LIGHTING</option><option value="PUMP">WATER FLOW</option><option value="FILTER">FILTRATION</option><option value="ROCK">AQUASCAPE</option><option value="OTHER">OTHERS</option></select><button onclick="addEquipAction()" class="w-full bg-red-600 py-4 rounded-xl font-bold mt-4">CONFIRM</button></div>`);
        }

        function addEquipAction() {
            const name = document.getElementById('m-name').value, cat = document.getElementById('m-cat').value;
            if(!name) return;
            state.equipment.push({ id: Date.now(), name, category: cat, date: new Date().toISOString().split('T')[0] });
            save(); closeModal(); render();
        }

        function showAddLiveModal() {
            openModal(`<h3 class="text-xl font-bold mb-6">Add Biota</h3><div class="space-y-4"><input type="text" id="m-name" placeholder="Species Name"><select id="m-cat"><option value="FISH">FISH</option><option value="CORAL">CORALS</option><option value="INVERTS">INVERTEBRATES</option></select><textarea id="m-note" placeholder="Note..." class="h-24"></textarea><button onclick="addLiveAction()" class="w-full bg-red-600 py-4 rounded-xl font-bold mt-4">ADD TO SYSTEM</button></div>`);
        }

        function addLiveAction() {
            const name = document.getElementById('m-name').value, cat = document.getElementById('m-cat').value, note = document.getElementById('m-note').value;
            if(!name) return;
            state.lives.push({ id: Date.now(), name, category: cat, note });
            save(); closeModal(); render();
        }

        function deleteItem(type, id) { state[type] = state[type].filter(i => i.id !== id); save(); render(); }
        function resetData() { if(confirm('PURGE DATA?')) { localStorage.clear(); location.reload(); } }
        window.onload = () => { router('LOGS'); save(); };
    </script>
</body>
</html>
