<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cosme Genius Pro v10.5</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap');

:root {
  --bg-color: #f2f2f0;
  --card-bg: #ffffff;
  --text-main: #333333;
  --text-sub: #555555;
  --accent-color: #a89f91;
  --accent-dark: #8d8579;
  --header-bg: #e6e5e3;
  --line-color: #e0e0e0;
  
  --font-serif: 'Cormorant Garamond', serif;
  --font-sans: 'Zen Kaku Gothic New', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-bottom: env(safe-area-inset-bottom);
  --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
  --shadow-float: 0 8px 30px rgba(0, 0, 0, 0.08);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { overflow-x: hidden; -webkit-text-size-adjust: 100%; height: 100%; }
body {
  font-family: var(--font-sans);
  background-color: var(--bg-color);
  margin: 0; padding: 0;
  color: var(--text-main);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  width: 100%;
  overscroll-behavior-y: none;
  min-height: 100%;
  padding-bottom: var(--safe-bottom);
}

::-webkit-scrollbar { display: none; }

/* === Header === */
.header-area {
  padding: 50px 20px 30px;
  background: linear-gradient(to bottom, #e6e5e3, #f2f2f0);
  position: relative;
  z-index: 10;
  text-align: center;
}
.brand-title {
  font-family: var(--font-serif);
  font-size: 2.2rem;
  font-weight: 500;
  letter-spacing: 0.05em;
  margin: 0;
  color: var(--text-main);
  text-transform: uppercase;
}
.brand-subtitle {
  font-family: var(--font-sans);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  color: var(--text-sub);
  margin-top: 8px;
  display: block;
  font-weight: 400;
}

/* === Tabs === */
.tabs-sticky-wrapper {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(242, 242, 240, 0.95);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 15px;
  max-width: 600px;
  margin: 0 auto;
  padding: 0 10px;
}
.tab-btn {
  background: transparent;
  border: none;
  font-family: var(--font-sans);
  font-size: 0.85rem;
  color: #888;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  font-weight: 500;
}
.tab-btn.active {
  color: var(--text-main);
  font-weight: 700;
}
.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 20px;
  height: 2px;
  background-color: var(--accent-color);
}

/* === Container === */
.container {
  max-width: 600px;
  width: 100%;
  margin: 0 auto;
  padding: 20px 20px 120px; /* ãƒãƒ£ãƒƒãƒˆæ¬„å¯¾ç­–ã§ä¸‹éƒ¨ä½™ç™½å¢— */
}

/* === Components === */
.section-title {
  font-family: var(--font-serif);
  font-size: 1.3rem;
  color: var(--text-main);
  margin: 40px 0 20px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--accent-color);
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}
.card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 4px;
  box-shadow: var(--shadow-soft);
  margin-bottom: 20px;
}

.input-group { margin-bottom: 20px; }
label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; }

input, select, textarea {
  width: 100%;
  padding: 14px 12px;
  border: 1px solid #ddd;
  background: #fafafa;
  border-radius: 4px;
  font-family: var(--font-sans);
  font-size: 1rem;
  color: var(--text-main);
  transition: all 0.3s;
  appearance: none; -webkit-appearance: none;
}
select {
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat;
  background-position: right 12px top 50%;
  background-size: 10px auto;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent-color);
  background: #fff;
}
input::placeholder, textarea::placeholder { color: #bbb; }

button {
  width: 100%;
  padding: 16px;
  background: var(--text-main);
  color: #fff;
  border: none;
  font-family: var(--font-sans);
  font-weight: 500;
  font-size: 0.95rem;
  letter-spacing: 0.05em;
  cursor: pointer;
  transition: opacity 0.3s, transform 0.2s;
  border-radius: 4px;
  margin-top: 10px;
  position: relative;
  overflow: hidden;
}
button:active { transform: scale(0.98); }
button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

.btn-secondary { background: transparent !important; color: var(--text-main) !important; border: 1px solid #ccc !important; }
.btn-accent { background: var(--accent-color) !important; color: #fff !important; border: none !important; }
.btn-text {
  background: transparent !important; border: none !important; padding: 5px 10px !important;
  color: var(--accent-dark) !important; width: auto !important; margin: 0 !important; font-size: 0.8rem;
}

/* === List Items === */
.filter-tabs {
  display: flex; gap: 5px; margin-bottom: 15px; background: #e0e0e0; padding: 4px; border-radius: 6px;
}
.filter-tab {
  flex: 1; text-align: center; padding: 8px 0; font-size: 0.8rem; cursor: pointer; border-radius: 4px; color: #666; transition: 0.3s;
}
.filter-tab.active { background: #fff; color: var(--text-main); font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

.item-card-details {
  background: #fff;
  border: 1px solid rgba(0,0,0,0.05);
  margin-bottom: 8px;
  border-radius: 4px;
  transition: all 0.3s ease;
}
.item-card-details[open] { box-shadow: var(--shadow-soft); border-color: transparent; margin-bottom: 15px; }
.item-card-details summary {
  padding: 18px 15px; cursor: pointer; list-style: none; display: flex; flex-direction: column; gap: 8px;
}
.item-card-details summary::-webkit-details-marker { display: none; }

.summary-top-row { display: flex; align-items: flex-start; justify-content: space-between; width: 100%; }
.summary-bottom-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }

.item-brand { font-size: 0.7rem; color: #666; font-weight: 500; letter-spacing: 0.05em; margin-bottom: 2px; }
.item-name {
  font-size: 1.05rem; font-weight: 600; color: var(--text-main);
  white-space: normal; word-break: break-all; line-height: 1.4;
}

.item-badges { display: flex; gap: 5px; flex-shrink: 0; align-items: center; flex-wrap: wrap; }
.badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 2px; font-weight: 600; }
.badge.morning { background: #fff8e1; color: #f39c12; border: 1px solid #ffe0b2; }
.badge.night { background: #e8eaf6; color: #3f51b5; border: 1px solid #c5cae9; }
.badge.both { background: #f3e5f5; color: #9c27b0; border: 1px solid #e1bee7; }
.badge.category { background: #eee; color: #444; border: 1px solid #ddd; }
.badge.finished { background: #cfd8dc; color: #455a64; border: 1px solid #b0bec5; }

.item-content { padding: 0 20px 20px; font-size: 0.9rem; color: var(--text-sub); border-top: 1px solid #f5f5f5; margin-top: 10px; padding-top: 15px; }
.ingredients-box {
  background: #f9f9f9; padding: 10px; border-radius: 4px; font-size: 0.8rem; color: #555;
  margin-top: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #eee;
}

/* === Cospa === */
.cospa-card {
  background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eee;
  position: relative;
}
.cospa-header { display: flex; justify-content: space-between; align-items: baseline; padding-right: 30px; }
.cospa-price { font-family: var(--font-serif); font-size: 1.6rem; color: var(--text-main); font-weight: 600; }
.cospa-unit { font-size: 0.8rem; color: #999; margin-left: 3px; }
.cospa-bar-bg { width: 100%; height: 4px; background: #eee; margin-top: 12px; border-radius: 2px; overflow: hidden; position: relative; }
.cospa-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--text-main)); position: absolute; left: 0; top: 0; }
.cospa-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top: 8px; }

.cospa-delete-btn {
  position: absolute; top: 15px; right: 15px;
  width: 24px; height: 24px; padding: 0; margin: 0;
  background: transparent; color: #ccc; border: none; font-size: 1.1rem;
  display: flex; align-items: center; justify-content: center;
}
.cospa-delete-btn:hover { color: #d32f2f; }

/* === Chat UI (Fast & Readable) === */
.chat-area { padding-bottom: 90px; display: flex; flex-direction: column; gap: 20px; }
.msg-row { display: flex; width: 100%; }
.msg-row.user { justify-content: flex-end; }
.msg-row.ai { justify-content: flex-start; }

.msg-bubble {
  max-width: 90%; 
  padding: 18px 22px; 
  font-size: 1rem; 
  line-height: 1.8; 
  border-radius: 12px;
  white-space: pre-wrap; 
  word-break: break-word;
  box-shadow: 0 3px 8px rgba(0,0,0,0.06);
}

/* User Bubble */
.msg-row.user .msg-bubble {
  background: #3a3a3a;
  color: #f0f0f0;
  border-bottom-right-radius: 2px;
  font-weight: 400;
}

/* AI Bubble */
.msg-row.ai .msg-bubble {
  background: #fcfbf9;
  border: 1px solid #dcdcdc;
  color: #333;
  border-bottom-left-radius: 2px;
  font-weight: 500;
  letter-spacing: 0.02em;
}

/* Typing Indicator */
.typing-indicator {
  display: flex; gap: 4px; padding: 12px 16px; background: #fcfbf9; border: 1px solid #dcdcdc; border-radius: 12px; border-bottom-left-radius: 2px; width: fit-content;
}
.typing-indicator span {
  width: 6px; height: 6px; background: #888; border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out both;
}
.typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
.typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

/* Chat Input */
.chat-footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(242, 242, 240, 0.98);
  backdrop-filter: blur(10px);
  padding: 12px 15px;
  padding-bottom: calc(15px + var(--safe-bottom));
  border-top: 1px solid rgba(0,0,0,0.05);
  display: flex; gap: 10px; align-items: flex-end;
  z-index: 2000;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
}
.chat-input {
  flex: 1; border: 1px solid #ccc; background: #fff;
  border-radius: 20px; padding: 12px 16px; font-size: 16px;
  min-height: 48px; max-height: 120px;
  margin: 0; transition: border-color 0.2s;
  resize: none; line-height: 1.5; color: #333;
}
.chat-input:focus { border-color: var(--accent-color); }
.send-btn {
  width: 48px; height: 48px; border-radius: 50%; padding: 0; margin: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; background: var(--text-main); flex-shrink: 0; color: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* === Photo Action Sheet === */
.photo-trigger-btn {
  background: #fff; color: var(--text-main); border: 1px solid #ccc;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  position: relative;
}
.photo-trigger-btn::after {
  content: 'â–¼'; font-size: 10px; color: #999; margin-left: 5px;
}

#photoSheet {
  display: none; position: fixed; inset: 0; z-index: 2500;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
  animation: fadeInBg 0.3s forwards;
}
#photoSheetContent {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: #f2f2f0;
  border-radius: 16px 16px 0 0;
  padding: 20px 20px calc(20px + var(--safe-bottom));
  transform: translateY(100%);
  animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
}
@keyframes slideUp { to { transform: translateY(0); } }
@keyframes fadeInBg { from { opacity: 0; } to { opacity: 1; } }

.sheet-title { text-align: center; color: #888; font-size: 0.8rem; margin-bottom: 15px; font-weight: 600; }
.sheet-btn {
  width: 100%; padding: 18px; background: #fff; border: none;
  font-size: 1rem; color: var(--text-main); font-weight: 500;
  margin-bottom: 10px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}
.sheet-btn:active { background: #eee; transform: scale(0.99); }
.sheet-cancel {
  margin-top: 10px; background: #e0e0e0; color: #333; font-weight: 600;
}

/* === Utils === */
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

.flex-row { display: flex; gap: 10px; align-items: center; }
.text-center { text-align: center; }
.alert-box { background: #fff3e0; padding: 15px; font-size: 0.85rem; color: #e65100; border-radius: 4px; margin-bottom: 20px; border: 1px solid #ffe0b2; }
.code-display { font-family: monospace; font-size: 0.75rem; color: #666; background: #eee; padding: 4px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; }

.progress-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.85); z-index: 3000;
  display:none; flex-direction:column; align-items:center; justify-content:center;
}
.progress-spinner {
  width: 40px; height: 40px; border: 3px solid #ddd; border-top-color: var(--accent-color);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px;
}
@keyframes spin { to {transform: rotate(360deg);} }

</style>
</head>
<body>

<!-- Header -->
<div class="header-area">
  <h1 class="brand-title">COSME GENIUS</h1>
  <span class="brand-subtitle">PRO EDITION v10.5</span>
</div>

<!-- Tabs -->
<div class="tabs-sticky-wrapper">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('register')" id="btn-register">ç™»éŒ²</button>
    <button class="tab-btn" onclick="switchTab('chat')" id="btn-chat">ç›¸è«‡</button>
    <button class="tab-btn" onclick="switchTab('cospa')" id="btn-cospa">ã‚³ã‚¹ãƒ‘</button>
    <button class="tab-btn" onclick="switchTab('settings')" id="btn-settings">è¨­å®š</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">

  <!-- ================= REGISTER TAB ================= -->
  <div id="tab-register" class="tab-content active">
    <div class="section-title">
      <span>ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²</span>
    </div>

    <!-- Photo Trigger Button -->
    <button class="photo-trigger-btn" onclick="showPhotoSheet()">
      <span>ğŸ“· å†™çœŸã§AIç™»éŒ²ã™ã‚‹</span>
    </button>

    <!-- Bottom Action Sheet -->
    <div id="photoSheet" onclick="hidePhotoSheet()">
      <div id="photoSheetContent" onclick="event.stopPropagation()">
        <div class="sheet-title">å†™çœŸã‚’é¸æŠ</div>
        <label class="sheet-btn">
          <span>ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</span>
          <input type="file" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(event)">
        </label>
        <label class="sheet-btn">
          <span>ğŸ–¼ï¸ ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸æŠ</span>
          <input type="file" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
        </label>
        <button class="sheet-btn sheet-cancel" onclick="hidePhotoSheet()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <!-- Manual Input Form -->
    <div class="card" style="margin-top:20px;">
      <div class="input-group flex-row">
        <input type="text" id="itemName" placeholder="å•†å“å (å¿…é ˆ)">
        <button onclick="triggerManualAISearch()" id="btn-ai-search" class="btn-accent" style="width:auto; padding:0 20px; font-size:0.8rem; margin:0; white-space:nowrap;">AIè‡ªå‹•å…¥åŠ›</button>
      </div>
      <div class="input-group"><input type="text" id="brand" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰å"></div>
      <div class="input-group">
        <select id="categorySelect">
          <option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
          <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
          <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
          <option value="ä¹³æ¶²">ä¹³æ¶²</option>
          <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
          <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div class="input-group"><textarea id="description" rows="2" placeholder="èª¬æ˜ãƒ»ãƒ¡ãƒ¢"></textarea></div>
      <div class="input-group">
        <label>å…¨æˆåˆ† (AIç™»éŒ²ã§è‡ªå‹•å–å¾—)</label>
        <textarea id="ingredients" rows="3" placeholder="æ°´, ã‚°ãƒªã‚»ãƒªãƒ³..."></textarea>
      </div>
      <div class="input-group flex-row">
        <input type="text" id="releaseDate" placeholder="ç™ºå£²æ—¥">
        <input type="number" id="itemPrice" placeholder="ä¾¡æ ¼ (å††)">
      </div>
      <div class="input-group">
        <label>ä½¿ç”¨é–‹å§‹æ—¥</label>
        <input type="date" id="openDate">
      </div>
      <div class="input-group">
        <select id="timeTag">
          <option value="æœ">æœç”¨</option>
          <option value="æ™©">å¤œç”¨</option>
          <option value="æœæ™©">æœæ™©å…¼ç”¨</option>
        </select>
      </div>
      <button onclick="addItem()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <div class="section-title" style="margin-top:50px; border:none; padding-bottom:0; display:block;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span>ç™»éŒ²ãƒªã‚¹ãƒˆ</span>
        <select id="sortSelect" onchange="render()" style="width:auto; border:none; background:transparent; font-size:0.8rem; text-align:right; color:var(--text-sub);">
          <option value="newest">æ–°ç€é †</option>
          <option value="time">æœãƒ»å¤œåˆ¥</option>
          <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
          <option value="brand">ãƒ–ãƒ©ãƒ³ãƒ‰é †</option>
        </select>
      </div>
      <!-- Filters -->
      <div class="filter-tabs">
        <div class="filter-tab active" id="filter-active" onclick="setFilter('active')">ä½¿ç”¨ä¸­</div>
        <div class="filter-tab" id="filter-finished" onclick="setFilter('finished')">ä½¿ã„åˆ‡ã‚Š</div>
        <div class="filter-tab" id="filter-all" onclick="setFilter('all')">å…¨ã¦</div>
      </div>
    </div>
    <div id="routineArea"></div>
  </div>

  <!-- ================= CHAT TAB ================= -->
  <div id="tab-chat" class="tab-content">
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:20px;">
      <button class="btn-text" onclick="createNewChat()">ï¼‹ æ–°è¦ãƒãƒ£ãƒƒãƒˆ</button>
      <button class="btn-text" onclick="toggleChatHistory()">å±¥æ­´ã‚’è¡¨ç¤º</button>
    </div>
    
    <div id="chatHistoryContainer" style="display:none; background:#fff; margin-bottom:20px; padding:10px; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.05);"></div>

    <div id="chatHistory" class="chat-area"></div>

    <div class="chat-footer">
      <textarea id="chatInput" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1" oninput="adjustChatHeight(this)"></textarea>
      <button onclick="sendChatMessage()" class="send-btn">â¤</button>
    </div>
  </div>

  <!-- ================= COSPA TAB ================= -->
  <div id="tab-cospa" class="tab-content">
    <div class="section-title"><span>ã‚³ã‚¹ãƒ‘åˆ†æ</span></div>
    <div id="cospaTopSummary" style="margin-bottom:30px; text-align:center;"></div>
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
      <select id="cospaCategory" onchange="renderCospa()" style="font-size:0.85rem; width:48%;">
        <option value="all">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
        <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
        <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
        <option value="ä¹³æ¶²">ä¹³æ¶²</option>
        <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
        <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
      </select>
      <select id="cospaSort" onchange="renderCospa()" style="font-size:0.85rem; width:48%;">
        <option value="cost_asc">å®‰ã„é † (æ—¥å‰²ã‚Š)</option>
        <option value="cost_desc">é«˜ã„é † (æ—¥å‰²ã‚Š)</option>
        <option value="days_desc">é•·ãä½¿ã£ã¦ã„ã‚‹é †</option>
        <option value="days_asc">ä½¿ç”¨æœŸé–“ãŒçŸ­ã„é †</option>
      </select>
    </div>
    <div id="cospaList"></div>
  </div>

  <!-- ================= SETTINGS TAB ================= -->
  <div id="tab-settings" class="tab-content">
    <div class="section-title"><span>è¨­å®š</span></div>
    <div class="alert-box">APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</div>
    <div class="card">
      <div class="input-group">
        <label>Gemini API ã‚­ãƒ¼</label>
        <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
      </div>
      <div class="input-group" style="margin-top:30px;">
        <label>ãƒãƒ£ãƒƒãƒˆç”¨ãƒ¢ãƒ‡ãƒ«</label>
        <select id="chatModelSelect" onchange="updateModelCodeDisplay()">
          <option value="gemini-3-flash-preview">Gemini 3 Flash (æ¨å¥¨)</option>
          <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
          <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
        <div class="code-display">Code: <span id="chatModelCodeDisplay"></span></div>
      </div>
      <div class="input-group">
        <label>æ¤œç´¢ãƒ»ç™»éŒ²ç”¨ãƒ¢ãƒ‡ãƒ«</label>
        <select id="fastModelSelect" onchange="updateModelCodeDisplay()">
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (æœ€é€Ÿ)</option>
          <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
        <div class="code-display">Code: <span id="fastModelCodeDisplay"></span></div>
      </div>
      <button onclick="saveSettings()" class="btn-accent">è¨­å®šã‚’ä¿å­˜</button>
      <button onclick="clearApiKey()" class="btn-secondary" style="margin-top:20px; color:#c62828!important; border-color:#ef9a9a!important;">APIã‚­ãƒ¼ã‚’å‰Šé™¤</button>
    </div>
    <div class="section-title" style="margin-top:50px;"><span>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span></div>
    <div class="card">
      <button onclick="exportData()" class="btn-secondary">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (JSON)</button>
      <button onclick="importData()" class="btn-secondary">ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ (JSON)</button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
    </div>
  </div>
</div>

<!-- Global Overlay -->
<div id="progressOverlay" class="progress-overlay">
  <div class="progress-spinner"></div>
  <div id="progressText" style="font-family:var(--font-serif); font-size:1.1rem; color:#555;">å‡¦ç†ä¸­...</div>
</div>
<canvas id="compressionCanvas" style="display:none;"></canvas>

<script>
let cosmeData = JSON.parse(localStorage.getItem('cosmeData_v8')) || [];
let chatHistories = JSON.parse(localStorage.getItem('chatHistories_v1')) || [];
let currentChatId = null;
let isRequesting = false;
let lastRequestTime = 0;
let currentFilter = 'active';

const DEFAULT_CHAT_MODEL = 'gemini-3-flash-preview';
const DEFAULT_FAST_MODEL = 'gemini-2.5-flash-lite';
const IMAGE_MODEL = 'gemini-2.5-flash'; 

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('openDate').valueAsDate = new Date();
  document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey_v1') || '';
  loadModelSettings();
  if(chatHistories.length > 0) { currentChatId = chatHistories[0].id; loadChat(currentChatId); }
  else { createNewChat(); }
  render(); renderCospa();
});

function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  document.getElementById('btn-' + tabId).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  if(tabId === 'cospa') renderCospa();
  if(tabId === 'chat') setTimeout(scrollToBottom, 100);
}
function scrollToBottom() { window.scrollTo(0, document.body.scrollHeight); }

function validateApiKey() {
  var k = localStorage.getItem('geminiApiKey_v1');
  if(!k || k.length < 10) { alert('è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'); switchTab('settings'); return false; }
  return true;
}
function getApiUrl(isFast) {
  var model = isFast ? document.getElementById('fastModelSelect').value : document.getElementById('chatModelSelect').value;
  return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${localStorage.getItem('geminiApiKey_v1')}`;
}
function getImageApiUrl() {
  return `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:generateContent?key=${localStorage.getItem('geminiApiKey_v1')}`;
}

async function waitForRateLimit() {
  var now = Date.now();
  if (now - lastRequestTime < 2000) await new Promise(r => setTimeout(r, 2000 - (now - lastRequestTime)));
  lastRequestTime = Date.now();
}

/* UI Helpers */
function showOverlay(txt) {
  document.getElementById('progressOverlay').style.display = 'flex';
  document.getElementById('progressText').textContent = txt;
}
function hideOverlay() { document.getElementById('progressOverlay').style.display = 'none'; }
function setBtnLoading(btnId, isLoading, text='AIè‡ªå‹•å…¥åŠ›') {
  var btn = document.getElementById(btnId);
  if(!btn) return;
  if(isLoading) {
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-inline"></span>æ¤œç´¢ä¸­...`;
  } else {
    btn.disabled = false;
    btn.innerHTML = text;
  }
}

function parseAIJson(text) {
  try { return JSON.parse(text); } catch(e) {}
  var clean = text.replace(/```json\s*|\s*```/g, '').trim();
  try { return JSON.parse(clean); } catch(e) {}
  var start = clean.indexOf('{');
  var end = clean.lastIndexOf('}');
  if(start !== -1 && end !== -1) {
    try { return JSON.parse(clean.substring(start, end + 1)); } catch(e) {}
  }
  return null;
}

/* Image Search */
async function handleImageSelect(e) {
  if(!validateApiKey() || isRequesting) return;
  var file = e.target.files[0];
  if(!file) return;
  hidePhotoSheet();
  isRequesting = true; showOverlay("ç”»åƒã‚’è§£æä¸­...");

  try {
    var base64 = (await compressImage(file)).split(',')[1];
    await waitForRateLimit();
    var p1 = 'ã“ã®åŒ–ç²§å“ã®ãƒ–ãƒ©ãƒ³ãƒ‰åã¨å•†å“åã‚’ç‰¹å®šã—JSONã§å‡ºåŠ›: {"itemName":"","brandName":""}';
    var r1 = await fetch(getImageApiUrl(), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: p1 }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    var d1 = await r1.json();
    var j1 = parseAIJson(d1.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
    
    if(j1 && j1.itemName) document.getElementById('itemName').value = j1.itemName;
    if(j1 && j1.brandName) document.getElementById('brand').value = j1.brandName;

    if(j1 && j1.itemName) {
      document.getElementById('progressText').textContent = "è©³ç´°ã‚’å–å¾—ä¸­...";
      await waitForRateLimit();
      var p2 = `åŒ–ç²§å“ã€Œ${j1.brandName} ${j1.itemName}ã€ã®è©³ç´°JSON: {"category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–","ingredients":"å…¨æˆåˆ†ãƒªã‚¹ãƒˆ","description":"","price":0,"releaseDate":""}`;
      var r2 = await fetch(getApiUrl(true), {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: p2 }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      var d2 = await r2.json();
      var j2 = parseAIJson(d2.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
      if(j2) {
        if(j2.category) document.getElementById('categorySelect').value = j2.category;
        if(j2.description) document.getElementById('description').value = j2.description;
        if(j2.ingredients) document.getElementById('ingredients').value = j2.ingredients;
        if(j2.price) document.getElementById('itemPrice').value = j2.price;
      }
    }
  } catch(e) {
    alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
  } finally {
    isRequesting = false; hideOverlay(); e.target.value = '';
  }
}
function compressImage(file) {
  return new Promise(r => {
    var fr = new FileReader();
    fr.onload = e => {
      var img = new Image();
      img.onload = () => {
        var c = document.getElementById('compressionCanvas');
        var scale = Math.min(1000/img.width, 1);
        c.width = img.width * scale; c.height = img.height * scale;
        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
        r(c.toDataURL('image/jpeg', 0.8));
      };
      img.src = e.target.result;
    };
    fr.readAsDataURL(file);
  });
}

/* Text Search */
async function triggerManualAISearch() {
  if(!validateApiKey() || isRequesting) return;
  var name = document.getElementById('itemName').value;
  if(!name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  isRequesting = true;
  setBtnLoading('btn-ai-search', true);
  
  try {
    await waitForRateLimit();
    var p = `åŒ–ç²§å“ã€Œ${name}ã€ã®è©³ç´°æƒ…å ±ã‚’æ¤œç´¢ã—JSONã§å‡ºåŠ›: {"brand":"","category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–","ingredients":"å…¨æˆåˆ†","description":"","price":0,"releaseDate":""}`;
    var res = await fetch(getApiUrl(true), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: p }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    var d = await res.json();
    var text = d.candidates?.[0]?.content?.parts?.[0]?.text;
    var j = parseAIJson(text || "{}");
    
    if(!j) throw new Error("æƒ…å ±ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ");

    if(j.brand) document.getElementById('brand').value = j.brand;
    if(j.category) document.getElementById('categorySelect').value = j.category;
    if(j.description) document.getElementById('description').value = j.description;
    if(j.ingredients) document.getElementById('ingredients').value = j.ingredients;
    if(j.price) document.getElementById('itemPrice').value = j.price;
    if(j.releaseDate) document.getElementById('releaseDate').value = j.releaseDate;
    
  } catch(e) {
    alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + e.message);
  } finally {
    isRequesting = false;
    setBtnLoading('btn-ai-search', false);
  }
}

/* Data Logic */
function addItem() {
  var item = {
    id: Date.now(),
    name: document.getElementById('itemName').value,
    brand: document.getElementById('brand').value,
    category: document.getElementById('categorySelect').value,
    description: document.getElementById('description').value,
    ingredients: document.getElementById('ingredients').value,
    releaseDate: document.getElementById('releaseDate').value,
    price: document.getElementById('itemPrice').value,
    openDate: document.getElementById('openDate').value,
    tag: document.getElementById('timeTag').value
  };
  if(!item.name) return alert('å•†å“åã¯å¿…é ˆã§ã™');
  cosmeData.unshift(item);
  saveData(); render(); renderCospa();
  document.getElementById('itemName').value = '';
  document.getElementById('ingredients').value = '';
  document.getElementById('description').value = '';
  document.getElementById('itemPrice').value = '';
  alert('è¿½åŠ ã—ã¾ã—ãŸ');
}
function saveData() { localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData)); }
function removeItem(id) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { cosmeData = cosmeData.filter(i => i.id !== id); saveData(); render(); renderCospa(); } }
function removeCospaItem(id) { if(confirm('ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { cosmeData = cosmeData.filter(i => i.id !== id); saveData(); render(); renderCospa(); } }
function markFinished(id) {
  var i = cosmeData.find(x => x.id === id);
  if(i) { i.finishDate = i.finishDate ? null : new Date().toISOString().split('T')[0]; saveData(); render(); renderCospa(); }
}
function saveEdit(id, key, val) { var i = cosmeData.find(x => x.id === id); if(i) { i[key] = val; saveData(); renderCospa(); } }

function setFilter(type) {
  currentFilter = type;
  document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('filter-' + type).classList.add('active');
  render();
}

function render() {
  var type = document.getElementById('sortSelect').value;
  var d = cosmeData.filter(item => {
    if(currentFilter === 'active') return !item.finishDate;
    if(currentFilter === 'finished') return item.finishDate;
    return true; 
  });

  if (type === 'time') d.sort((a,b) => (a.tag||'').localeCompare(b.tag||''));
  else if (type === 'category') d.sort((a,b) => (a.category||'').localeCompare(b.category||''));
  else if (type === 'brand') d.sort((a,b) => (a.brand||'').localeCompare(b.brand||''));
  
  var html = '';
  d.forEach(item => {
    var badgeClass = item.tag === 'æœ' ? 'morning' : (item.tag === 'æ™©' ? 'night' : 'both');
    var badgeLabel = item.tag === 'æœ' ? 'æœ' : (item.tag === 'æ™©' ? 'å¤œ' : 'æœå¤œ');
    var categoryLabel = item.category || 'ãã®ä»–';
    
    html += `
    <details class="item-card-details">
      <summary>
        <div class="summary-top-row">
          <div style="display:flex; flex-direction:column; width:100%; padding-right:10px;">
            <div class="item-brand">${escapeHtml(item.brand)}</div>
            <div class="item-name" style="${item.finishDate?'text-decoration:line-through;opacity:0.6':''}">${escapeHtml(item.name)}</div>
          </div>
        </div>
        <div class="summary-bottom-row" style="margin-top:5px;">
           <div class="item-badges">
             <span class="badge category">${categoryLabel}</span>
             <span class="badge ${badgeClass}">${badgeLabel}</span>
             ${item.finishDate ? '<span class="badge finished">ä½¿ã„åˆ‡ã‚Š</span>' : ''}
           </div>
        </div>
      </summary>
      <div class="item-content">
        <p style="margin:5px 0;">${escapeHtml(item.description || 'èª¬æ˜ãªã—')}</p>
        ${item.ingredients ? `<div class="ingredients-box"><b>å…¨æˆåˆ†:</b><br>${escapeHtml(item.ingredients)}</div>` : ''}
        <div class="flex-row" style="margin-top:15px;">
           <input type="number" value="${item.price}" placeholder="ä¾¡æ ¼" onchange="saveEdit(${item.id},'price',this.value)" style="font-size:0.9rem;">
           <input type="date" value="${item.openDate}" onchange="saveEdit(${item.id},'openDate',this.value)" style="font-size:0.9rem;">
        </div>
        <div class="flex-row" style="margin-top:10px;">
          <button class="btn-secondary" onclick="markFinished(${item.id})">${item.finishDate?'ä½¿ã„åˆ‡ã‚Šè§£é™¤':'ä½¿ã„åˆ‡ã‚Šã«ã™ã‚‹'}</button>
          <button class="btn-secondary" onclick="removeItem(${item.id})" style="color:red!important;border-color:#ffcccc!important;">å‰Šé™¤</button>
        </div>
      </div>
    </details>`;
  });
  document.getElementById('routineArea').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:50px;font-size:0.9rem;">è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}

function renderCospa() {
  var cat = document.getElementById('cospaCategory').value;
  var sort = document.getElementById('cospaSort').value;
  var list = cosmeData.filter(i => (cat==='all'||i.category===cat) && i.price && i.openDate);
  list.sort((a,b) => {
    var da = getDaily(a), db = getDaily(b);
    var daysA = getDays(a), daysB = getDays(b);
    if(sort === 'cost_asc') return da - db;
    if(sort === 'cost_desc') return db - da;
    if(sort === 'days_desc') return daysB - daysA;
    if(sort === 'days_asc') return daysA - daysB;
    return 0;
  });
  var html = '', totalDaily = 0;
  list.forEach(item => {
    var days = getDays(item);
    var daily = Math.round(getDaily(item));
    totalDaily += daily;
    var barWidth = Math.min(100, (daily / 150) * 100);
    html += `
    <div class="cospa-card">
      <button class="cospa-delete-btn" onclick="removeCospaItem(${item.id})">ğŸ—‘ï¸</button>
      <div class="cospa-header">
        <div><div style="font-size:0.75rem;color:#888;">${escapeHtml(item.brand)}</div><div style="font-weight:500;">${escapeHtml(item.name)}</div></div>
        <div><span class="cospa-price">Â¥${daily}</span><span class="cospa-unit">/æ—¥</span></div>
      </div>
      <div class="cospa-bar-bg"><div class="cospa-bar-fill" style="width:${barWidth}%"></div></div>
      <div class="cospa-meta"><span>Â¥${item.price}</span><span>${days}æ—¥ ${item.finishDate?'(å®Œ)':''}</span></div>
    </div>`;
  });
  document.getElementById('cospaList').innerHTML = html || '<div class="text-center" style="margin-top:40px;color:#ccc;">ãƒ‡ãƒ¼ã‚¿ä¸è¶³</div>';
  if(list.length > 0) {
    document.getElementById('cospaTopSummary').innerHTML = `<div style="font-size:0.9rem; color:#888; font-family:var(--font-serif);">1æ—¥ã‚ãŸã‚Šã®åˆè¨ˆ</div><div style="font-size:3rem; line-height:1; font-family:var(--font-serif); color:var(--text-main);">Â¥${Math.round(totalDaily)}</div>`;
  }
}
function getDays(i) {
  var start = new Date(i.openDate);
  var end = i.finishDate ? new Date(i.finishDate) : new Date();
  return Math.max(1, Math.floor((end - start) / 86400000));
}
function getDaily(i) { return i.price / getDays(i); }

function createNewChat() {
  var id = 'chat_' + Date.now();
  chatHistories.unshift({ id: id, title: 'æ–°è¦ãƒãƒ£ãƒƒãƒˆ', date: new Date().toISOString(), messages: [{ type: 'ai', text: 'ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã‚³ã‚¹ãƒ¡ã«åŸºã¥ã„ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¾ã™ã€‚ä½•ã§ã‚‚èã„ã¦ãã ã•ã„âœ¨' }] });
  saveChatHistories(); loadChat(id);
}
function loadChat(id) {
  currentChatId = id;
  var chat = chatHistories.find(c => c.id === id);
  var area = document.getElementById('chatHistory');
  area.innerHTML = '';
  chat.messages.forEach(m => appendMsg(m.type, m.text, false));
  renderChatList();
}

function appendMsg(type, text, animate = false) {
  var div = document.createElement('div');
  div.className = `msg-row ${type}`;
  var bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  
  if (animate && type === 'ai') {
    div.appendChild(bubble);
    document.getElementById('chatHistory').appendChild(div);
    typeWriter(bubble, text);
  } else {
    bubble.textContent = text;
    div.appendChild(bubble);
    document.getElementById('chatHistory').appendChild(div);
  }
}

// Geminié¢¨ã®é«˜é€Ÿã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼è¡¨ç¤º
function typeWriter(element, text) {
  element.textContent = '';
  let i = 0;
  const charsPerFrame = 3; // ä¸€åº¦ã«è¿½åŠ ã™ã‚‹æ–‡å­—æ•°
  const delay = 5; // æ›´æ–°é–“éš”(ms)

  function type() {
    if (i < text.length) {
      element.textContent += text.substring(i, i + charsPerFrame);
      i += charsPerFrame;
      scrollToBottom();
      setTimeout(type, delay);
    }
  }
  type();
}

function showTypingIndicator() {
  var div = document.createElement('div');
  div.className = 'msg-row ai';
  div.id = 'typing-indicator-row';
  div.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
  document.getElementById('chatHistory').appendChild(div);
  scrollToBottom();
}
function removeTypingIndicator() {
  var el = document.getElementById('typing-indicator-row');
  if(el) el.remove();
}

function adjustChatHeight(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

async function sendChatMessage() {
  if(!validateApiKey() || isRequesting) return;
  var input = document.getElementById('chatInput');
  var txt = input.value.trim();
  if(!txt) return;
  
  input.value = '';
  input.style.height = 'auto'; 
  isRequesting = true;
  appendMsg('user', txt);
  scrollToBottom();

  var chat = chatHistories.find(c => c.id === currentChatId);
  chat.messages.push({ type: 'user', text: txt });
  if(chat.messages.length === 2) chat.title = txt.substring(0, 20);
  saveChatHistories();

  showTypingIndicator();

  try {
    await waitForRateLimit();
    var context = JSON.stringify(cosmeData.map(c => ({n:c.name, b:c.brand, c:c.category, ing:c.ingredients})));
    var prompt = `å½¹å‰²:ç¾å®¹éƒ¨å“¡ã€‚æ–‡è„ˆ:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€æŒã‚³ã‚¹ãƒ¡=${context}ã€‚è³ªå•:${txt}`;
    
    var res = await fetch(getApiUrl(false), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    var d = await res.json();
    var ans = d.candidates?.[0]?.content?.parts?.[0]?.text || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    
    removeTypingIndicator();
    appendMsg('ai', ans, true);
    
    chat.messages.push({ type: 'ai', text: ans });
    saveChatHistories();
  } catch(e) {
    removeTypingIndicator();
    appendMsg('ai', "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message);
  } finally {
    isRequesting = false;
    scrollToBottom();
  }
}
function saveChatHistories() { localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories)); }
function renderChatList() {
  var h = '';
  chatHistories.forEach(c => {
    h += `<div onclick="loadChat('${c.id}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; background:${c.id===currentChatId?'#f9f9f9':'#fff'}"><div style="font-weight:600; font-size:0.9rem; color:var(--text-main);">${escapeHtml(c.title)}</div><div style="font-size:0.75rem; color:#999;">${new Date(c.date).toLocaleDateString()}</div></div>`;
  });
  document.getElementById('chatHistoryContainer').innerHTML = h;
}
function toggleChatHistory() {
  var el = document.getElementById('chatHistoryContainer');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
  renderChatList();
}

function loadModelSettings() {
  var cm = localStorage.getItem('chatModel_v1') || DEFAULT_CHAT_MODEL;
  var fm = localStorage.getItem('fastModel_v1') || DEFAULT_FAST_MODEL;
  document.getElementById('chatModelSelect').value = cm;
  document.getElementById('fastModelSelect').value = fm;
  updateModelCodeDisplay();
}
function updateModelCodeDisplay() {
  document.getElementById('chatModelCodeDisplay').textContent = document.getElementById('chatModelSelect').value;
  document.getElementById('fastModelCodeDisplay').textContent = document.getElementById('fastModelSelect').value;
}
function saveSettings() {
  localStorage.setItem('geminiApiKey_v1', document.getElementById('geminiApiKey').value.trim());
  localStorage.setItem('chatModel_v1', document.getElementById('chatModelSelect').value);
  localStorage.setItem('fastModel_v1', document.getElementById('fastModelSelect').value);
  alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function clearApiKey() { localStorage.removeItem('geminiApiKey_v1'); alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); }
function exportData() {
  var b = new Blob([JSON.stringify({data:cosmeData, chats:chatHistories})], {type:'application/json'});
  var a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='cosme_backup.json'; a.click();
}
function importData(){ document.getElementById('importFile').click(); }
function handleImport(e){
  var r=new FileReader(); r.onload=function(ev){ try{ var d=JSON.parse(ev.target.result); cosmeData=d.data||[]; chatHistories=d.chats||[]; saveData(); saveChatHistories(); render(); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(x){alert('ã‚¨ãƒ©ãƒ¼');} }; r.readAsText(e.target.files[0]);
}
function showPhotoSheet(){ document.getElementById('photoSheet').style.display='block'; }
function hidePhotoSheet(){ document.getElementById('photoSheet').style.display='none'; }
function escapeHtml(text) { if(text == null) return ''; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
</script>
</body>
</html>
