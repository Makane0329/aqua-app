<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cosme Genius Pro v9.9</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap');

:root {
  --bg-color: #f7f7f5; /* „Çè„Åö„Åã„Å´Ê∏©„Åã„Åø„ÅÆ„ÅÇ„Çã„Ç∞„É¨„Éº */
  --card-bg: #ffffff;
  --text-main: #111111;
  --text-sub: #666666;
  --accent: #2b2b2b;
  --line-color: #e0e0e0;
  --font-serif: 'Cormorant Garamond', serif;
  --font-sans: 'Zen Kaku Gothic New', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { overflow-x: hidden; -webkit-text-size-adjust: 100%; height: 100%; }
body {
  font-family: var(--font-sans);
  background-color: var(--bg-color);
  margin: 0; padding: 0;
  color: var(--text-main);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  width: 100%;
  overscroll-behavior-y: none;
  min-height: 100%;
  padding-bottom: var(--safe-bottom);
}

/* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÈùûË°®Á§∫ */
::-webkit-scrollbar { display: none; }

/* === Header Design === */
.header-area {
  padding: 60px 20px 20px;
  background: var(--bg-color);
  position: relative;
  z-index: 10;
}
.brand-title {
  font-family: var(--font-serif);
  font-size: 2.8rem;
  font-weight: 300;
  line-height: 0.9;
  letter-spacing: -0.02em;
  margin: 0;
  color: var(--text-main);
  transform: translateX(-2px); /* Ë¶ñË¶öË™øÊï¥ */
}
.brand-subtitle {
  font-family: var(--font-sans);
  font-size: 0.75rem;
  letter-spacing: 0.1em;
  color: var(--text-sub);
  margin-top: 10px;
  text-transform: uppercase;
  display: block;
}

/* === Navigation Tabs === */
.tabs-sticky-wrapper {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(247, 247, 245, 0.85); /* ÂçäÈÄèÊòéËÉåÊôØ */
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.03);
}
.tabs {
  display: flex;
  justify-content: space-around;
  max-width: 600px;
  margin: 0 auto;
  padding: 0 10px;
}
.tab-btn {
  background: transparent;
  border: none;
  font-family: var(--font-serif);
  font-size: 1.1rem;
  font-style: italic;
  color: #999;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative;
}
.tab-btn.active {
  color: var(--text-main);
  font-weight: 600;
  font-style: normal;
  transform: scale(1.05);
}
.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  background: var(--text-main);
  border-radius: 50%;
}

/* === Main Container === */
.container {
  max-width: 600px;
  width: 100%;
  margin: 0 auto;
  padding: 20px 20px 100px; /* ‰∏ãÈÉ®‰ΩôÁôΩÂ§ö„ÇÅ */
}

/* === Animations === */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in {
  animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* === Cards & Inputs === */
.section-title {
  font-family: var(--font-serif);
  font-size: 1.5rem;
  font-weight: 400;
  margin: 40px 0 20px;
  border-bottom: 1px solid var(--text-main);
  padding-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.input-group {
  margin-bottom: 24px;
}
input, select, textarea {
  width: 100%;
  padding: 12px 0;
  border: none;
  border-bottom: 1px solid #ccc;
  background: transparent;
  border-radius: 0;
  font-family: var(--font-sans);
  font-size: 1rem;
  color: var(--text-main);
  transition: border-color 0.3s;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-bottom-color: var(--text-main);
}
input::placeholder, textarea::placeholder {
  color: #aaa;
  font-weight: 300;
}

/* Button Reset & Style */
button {
  width: 100%;
  padding: 16px;
  border: 1px solid var(--text-main);
  background: var(--text-main);
  color: #fff;
  font-family: var(--font-sans);
  font-weight: 500;
  font-size: 0.9rem;
  letter-spacing: 0.05em;
  cursor: pointer;
  transition: all 0.3s;
  border-radius: 4px; /* Slightly rounded */
  margin-top: 10px;
}
button:active {
  transform: scale(0.98);
}
.btn-secondary {
  background: transparent !important;
  color: var(--text-main) !important;
  border: 1px solid #ccc !important;
}
.btn-text {
  background: transparent !important;
  border: none !important;
  padding: 8px !important;
  color: var(--text-sub) !important;
  text-decoration: underline;
  width: auto !important;
  margin: 0 !important;
}

/* === List Items (Accordion Style) === */
.item-card-details {
  border-bottom: 1px solid var(--line-color);
  background: transparent;
  margin-bottom: 0;
  transition: background 0.3s;
}
.item-card-details[open] {
  background: #fff;
  margin-bottom: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.04);
  border-bottom: none;
}
.item-card-details summary {
  padding: 20px 10px;
  cursor: pointer;
  list-style: none;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
}
.item-card-details summary::-webkit-details-marker { display: none; }

.item-summ-left { display: flex; align-items: baseline; gap: 10px; overflow: hidden; }
.item-brand { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-sub); }
.item-name { font-size: 1rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.item-badges { display: flex; gap: 5px; margin-left: auto; padding-left: 10px; flex-shrink: 0; }

.badge {
  font-size: 0.65rem; padding: 2px 6px; border: 1px solid #ddd;
  border-radius: 2px; color: #666; font-weight: 400;
}
.badge.morning { border-color: #f39c12; color: #f39c12; }
.badge.night { border-color: #34495e; color: #34495e; }

.item-content {
  padding: 0 20px 20px;
  font-size: 0.9rem;
  color: var(--text-sub);
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

/* === Cospa Style === */
.cospa-card {
  background: #fff;
  padding: 20px;
  margin-bottom: 15px;
  border-radius: 2px;
  position: relative;
  border-left: 3px solid var(--text-main);
  box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.cospa-header {
  display: flex; justify-content: space-between; align-items: baseline;
}
.cospa-price {
  font-family: var(--font-serif);
  font-size: 1.8rem;
  color: var(--text-main);
}
.cospa-unit { font-size: 0.8rem; color: #999; margin-left: 2px; font-family: var(--font-sans); }
.cospa-bar-bg {
  width: 100%; height: 2px; background: #eee; margin-top: 15px; position: relative;
}
.cospa-bar-fill {
  height: 100%; background: var(--text-main); position: absolute; left: 0; top: 0;
}
.cospa-meta {
  display: flex; justify-content: space-between; font-size: 0.75rem; color: #999; margin-top: 8px;
}

/* === Chat Style (Refined) === */
.chat-area {
  padding-bottom: 80px;
  display: flex; flex-direction: column; gap: 20px;
}
.msg-row { display: flex; width: 100%; }
.msg-row.user { justify-content: flex-end; }
.msg-row.ai { justify-content: flex-start; }

.msg-bubble {
  max-width: 85%;
  padding: 14px 18px;
  font-size: 0.95rem;
  line-height: 1.6;
  position: relative;
}
.msg-row.user .msg-bubble {
  background: var(--text-main);
  color: #fff;
  border-radius: 12px 12px 2px 12px;
}
.msg-row.ai .msg-bubble {
  background: #fff;
  color: var(--text-main);
  border: 1px solid #eee;
  border-radius: 12px 12px 12px 2px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}
.chat-footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  padding: 10px 15px calc(10px + var(--safe-bottom));
  border-top: 1px solid rgba(0,0,0,0.05);
  display: flex; gap: 10px; z-index: 200;
}
.chat-input {
  flex: 1; border: 1px solid #ddd; background: #fff;
  border-radius: 24px; padding: 10px 16px; font-size: 16px;
  height: 44px; margin: 0; transition: all 0.2s;
}
.chat-input:focus { border-color: var(--text-main); }
.send-btn {
  width: 44px; height: 44px; border-radius: 50%; padding: 0; margin: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
}

/* === Settings & Utils === */
.tab-content { display: none; }
.tab-content.active { display: block; }
.flex-row { display: flex; gap: 10px; align-items: center; }
.text-center { text-align: center; }
.alert-box {
  background: #f0f0f0; padding: 15px; font-size: 0.85rem; color: #555; border-radius: 4px; margin-bottom: 20px;
}
.file-upload-label {
  display: block; border: 1px dashed #ccc; padding: 30px; text-align: center;
  margin-bottom: 20px; cursor: pointer; transition: 0.3s; color: #888;
}
.file-upload-label:hover { border-color: #333; color: #333; }

/* Progress */
.progress-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.9); z-index: 3000;
  display:none; flex-direction:column; align-items:center; justify-content:center;
}
.progress-spinner {
  width: 40px; height: 40px; border: 3px solid #eee; border-top-color: #333;
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px;
}
@keyframes spin { to {transform: rotate(360deg);} }

</style>
</head>
<body>

<!-- Header -->
<div class="header-area">
  <h1 class="brand-title">COSME<br>GENIUS</h1>
  <span class="brand-subtitle">Pro Edition v9.9</span>
</div>

<!-- Tabs -->
<div class="tabs-sticky-wrapper">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('register')" id="btn-register">Register</button>
    <button class="tab-btn" onclick="switchTab('chat')" id="btn-chat">Chat</button>
    <button class="tab-btn" onclick="switchTab('cospa')" id="btn-cospa">Value</button>
    <button class="tab-btn" onclick="switchTab('settings')" id="btn-settings">Settings</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">

  <!-- ================= REGISTER TAB ================= -->
  <div id="tab-register" class="tab-content active fade-in">
    <div class="section-title">
      <span>New Entry</span>
      <button class="btn-text" onclick="showPhotoSheet()">üì∑ Scan Photo</button>
    </div>

    <!-- Scan Overlay -->
    <div id="photoSheet" style="display:none;position:fixed;inset:0;z-index:2500;background:rgba(0,0,0,0.6);backdrop-filter:blur(2px);" onclick="hidePhotoSheet()">
      <div style="position:absolute;bottom:0;left:0;right:0;background:var(--bg-color);padding:30px 20px;border-radius:20px 20px 0 0;" onclick="event.stopPropagation()">
        <p class="text-center" style="margin-bottom:20px;font-family:var(--font-serif);font-size:1.2rem;">Select Source</p>
        <label class="file-upload-label" style="background:#fff;border-style:solid;border-width:1px;border-color:#eee;">
          <span>üì∑ Take Photo</span>
          <input type="file" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(event)">
        </label>
        <label class="file-upload-label" style="background:#fff;border-style:solid;border-width:1px;border-color:#eee;">
          <span>üñºÔ∏è Photo Library</span>
          <input type="file" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
        </label>
        <button onclick="hidePhotoSheet()" class="btn-secondary">Cancel</button>
      </div>
    </div>

    <!-- Manual Input Form -->
    <div style="background:#fff; padding:30px 20px; border-radius:2px; box-shadow:0 10px 40px rgba(0,0,0,0.03);">
      <div class="input-group flex-row">
        <input type="text" id="itemName" placeholder="Item Name (Required)">
        <button onclick="triggerManualAISearch()" style="width:auto; padding:8px 15px; font-size:0.8rem;">‚ú® Auto</button>
      </div>
      <div class="input-group"><input type="text" id="brand" placeholder="Brand Name"></div>
      <div class="input-group">
        <select id="categorySelect">
          <option value="" disabled selected>Category</option>
          <option value="Ê¥óÈ°îÊñô">Face Wash</option>
          <option value="ÂåñÁ≤ßÊ∞¥">Lotion</option>
          <option value="‰π≥Ê∂≤">Emulsion</option>
          <option value="ÁæéÂÆπÊ∂≤">Serum</option>
          <option value="„ÇØ„É™„Éº„É†">Cream</option>
          <option value="„Åù„ÅÆ‰ªñ">Other</option>
        </select>
      </div>
      <div class="input-group"><textarea id="description" rows="2" placeholder="Description / Ingredients"></textarea></div>
      <div class="input-group flex-row">
        <input type="text" id="releaseDate" placeholder="Release Date">
        <input type="number" id="itemPrice" placeholder="Price (¬•)">
      </div>
      <div class="input-group">
        <label style="font-size:0.8rem; color:#999;">Open Date</label>
        <input type="date" id="openDate">
      </div>
      <div class="input-group">
        <select id="timeTag">
          <option value="Êúù">Morning Use</option>
          <option value="Êô©">Night Use</option>
          <option value="ÊúùÊô©">Both</option>
        </select>
      </div>
      <button onclick="addItem()">ADD TO LIST</button>
    </div>

    <!-- List -->
    <div class="section-title" style="margin-top:60px;">
      <span>Collection</span>
      <select id="sortSelect" onchange="render()" style="width:auto; border:none; font-size:0.8rem; text-align:right;">
        <option value="newest">Newest</option>
        <option value="time">Time</option>
        <option value="category">Category</option>
        <option value="brand">Brand</option>
      </select>
    </div>
    <div id="routineArea"></div>
  </div>

  <!-- ================= CHAT TAB ================= -->
  <div id="tab-chat" class="tab-content fade-in">
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:20px;">
      <button class="btn-text" onclick="createNewChat()">New Chat</button>
      <button class="btn-text" onclick="toggleChatHistory()">History</button>
    </div>
    
    <div id="chatHistoryContainer" style="display:none; background:#fff; margin-bottom:20px; padding:10px;"></div>

    <div id="chatHistory" class="chat-area">
      <!-- Chat bubbles go here -->
    </div>

    <div class="chat-footer">
      <textarea id="chatInput" class="chat-input" placeholder="Ask your beauty advisor..." rows="1"></textarea>
      <button onclick="sendChatMessage()" class="send-btn">‚û§</button>
    </div>
  </div>

  <!-- ================= COSPA TAB ================= -->
  <div id="tab-cospa" class="tab-content fade-in">
    <div class="section-title">
      <span>Cost Performance</span>
    </div>

    <div id="cospaTopSummary" style="margin-bottom:30px; text-align:center;"></div>

    <div style="display:flex; gap:10px; margin-bottom:20px;">
      <select id="cospaCategory" onchange="renderCospa()" style="font-size:0.85rem;">
        <option value="all">All Items</option>
        <option value="Ê¥óÈ°îÊñô">Face Wash</option>
        <option value="ÂåñÁ≤ßÊ∞¥">Lotion</option>
        <option value="‰π≥Ê∂≤">Emulsion</option>
        <option value="ÁæéÂÆπÊ∂≤">Serum</option>
        <option value="„ÇØ„É™„Éº„É†">Cream</option>
      </select>
      <select id="cospaSort" onchange="renderCospa()" style="font-size:0.85rem;">
        <option value="cost_asc">Cost: Low to High</option>
        <option value="cost_desc">Cost: High to Low</option>
        <option value="days_desc">Days: Longest</option>
        <option value="days_asc">Days: Shortest</option>
      </select>
    </div>

    <div id="cospaList"></div>
  </div>

  <!-- ================= SETTINGS TAB ================= -->
  <div id="tab-settings" class="tab-content fade-in">
    <div class="section-title"><span>Settings</span></div>
    
    <div class="alert-box">
      API keys are stored locally in your browser.
    </div>
    
    <div class="input-group">
      <label style="font-size:0.8rem; font-weight:600;">Gemini API Key</label>
      <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
    </div>

    <div class="input-group" style="margin-top:30px;">
      <label style="font-size:0.8rem; font-weight:600;">Chat Model</label>
      <select id="chatModelSelect">
        <option value="gemini-3-flash-preview">Gemini 3 Flash (Rec.)</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
      </select>
    </div>

    <div class="input-group">
      <label style="font-size:0.8rem; font-weight:600;">Search Model (Fast)</label>
      <select id="fastModelSelect">
        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (Rec.)</option>
        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
      </select>
    </div>

    <button onclick="saveSettings()">Save Configuration</button>
    <button onclick="clearApiKey()" class="btn-secondary" style="margin-top:20px; border-color:red!important; color:red!important;">Clear API Key</button>

    <div class="section-title" style="margin-top:50px;"><span>Data Management</span></div>
    <button onclick="exportData()" class="btn-secondary">Export JSON</button>
    <button onclick="importData()" class="btn-secondary">Import JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
  </div>

</div>

<!-- Progress Overlay -->
<div id="progressOverlay" class="progress-overlay">
  <div class="progress-spinner"></div>
  <div id="progressText" style="font-family:var(--font-serif); font-size:1.2rem;">Processing...</div>
</div>

<canvas id="compressionCanvas" style="display:none;"></canvas>

<script>
/* ================= LOGIC START ================= */
let cosmeData = JSON.parse(localStorage.getItem('cosmeData_v8')) || [];
let chatHistories = JSON.parse(localStorage.getItem('chatHistories_v1')) || [];
let currentChatId = null;
let isRequesting = false;
let lastRequestTime = 0;

const DEFAULT_CHAT_MODEL = 'gemini-3-flash-preview';
const DEFAULT_FAST_MODEL = 'gemini-2.5-flash-lite';

/* Initialization */
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('openDate').valueAsDate = new Date();
  document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey_v1') || '';
  
  // Model Settings
  var cm = localStorage.getItem('chatModel_v1');
  var fm = localStorage.getItem('fastModel_v1');
  if(!cm) cm = DEFAULT_CHAT_MODEL;
  if(!fm) fm = DEFAULT_FAST_MODEL;
  document.getElementById('chatModelSelect').value = cm;
  document.getElementById('fastModelSelect').value = fm;

  if(chatHistories.length > 0) {
    currentChatId = chatHistories[0].id;
    loadChat(currentChatId);
  } else {
    createNewChat();
  }
  
  render();
  renderCospa();

  // Chat Enter Key
  document.getElementById('chatInput').addEventListener('keydown', function(e) {
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
  });
});

/* Tabs */
function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  document.getElementById('btn-' + tabId).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  if(tabId === 'cospa') renderCospa();
  if(tabId === 'chat') setTimeout(scrollToBottom, 100);
}

function scrollToBottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

/* API Utils */
function validateApiKey() {
  var k = localStorage.getItem('geminiApiKey_v1');
  if(!k || k.length < 10) { alert('Please set your API Key in Settings.'); switchTab('settings'); return false; }
  return true;
}
function getApiUrl(isFast) {
  var model = isFast ? document.getElementById('fastModelSelect').value : document.getElementById('chatModelSelect').value;
  return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${localStorage.getItem('geminiApiKey_v1')}`;
}
async function waitForRateLimit() {
  var now = Date.now();
  if (now - lastRequestTime < 2000) await new Promise(r => setTimeout(r, 2000 - (now - lastRequestTime)));
  lastRequestTime = Date.now();
}
function showProgress(txt) {
  document.getElementById('progressOverlay').style.display = 'flex';
  document.getElementById('progressText').textContent = txt;
}
function hideProgress() { document.getElementById('progressOverlay').style.display = 'none'; }

/* AI Helper */
function parseAIJson(text) {
  try { return JSON.parse(text); } catch(e) {}
  var clean = text.replace(/```json\s*|\s*```/g, '').trim();
  try { return JSON.parse(clean); } catch(e) {}
  var m = clean.match(/\{[\s\S]*\}/);
  if(m) return JSON.parse(m[0]);
  throw new Error("Failed to parse JSON");
}

/* Image Handling */
async function handleImageSelect(e) {
  if(!validateApiKey() || isRequesting) return;
  var file = e.target.files[0];
  if(!file) return;
  hidePhotoSheet();
  isRequesting = true; showProgress("Analyzing Image...");

  try {
    var base64 = (await compressImage(file)).split(',')[1];
    await waitForRateLimit();
    
    // Step 1: Identify
    var p1 = 'Identify brand and product name. Output JSON only: {"itemName":"","brandName":""}';
    var r1 = await fetch(getApiUrl(true), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: p1 }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    var d1 = await r1.json();
    var j1 = parseAIJson(d1.candidates[0].content.parts[0].text);
    
    if(j1.itemName) document.getElementById('itemName').value = j1.itemName;
    if(j1.brandName) document.getElementById('brand').value = j1.brandName;

    // Step 2: Details
    if(j1.itemName) {
      document.getElementById('progressText').textContent = "Getting Details...";
      await waitForRateLimit();
      var p2 = `Provide details for cosmetics "${j1.brandName} ${j1.itemName}" in JSON: {"category":"Ê¥óÈ°îÊñô/ÂåñÁ≤ßÊ∞¥/‰π≥Ê∂≤/ÁæéÂÆπÊ∂≤/„ÇØ„É™„Éº„É†/„Åù„ÅÆ‰ªñ","ingredients":"","description":"","price":0,"releaseDate":""}`;
      var r2 = await fetch(getApiUrl(true), {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: p2 }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      var d2 = await r2.json();
      var j2 = parseAIJson(d2.candidates[0].content.parts[0].text);
      if(j2.category) document.getElementById('categorySelect').value = j2.category;
      if(j2.description) document.getElementById('description').value = j2.description;
      if(j2.price) document.getElementById('itemPrice').value = j2.price;
    }
  } catch(e) {
    alert("Error: " + e.message);
  } finally {
    isRequesting = false; hideProgress(); e.target.value = '';
  }
}
function compressImage(file) {
  return new Promise(r => {
    var fr = new FileReader();
    fr.onload = e => {
      var img = new Image();
      img.onload = () => {
        var c = document.getElementById('compressionCanvas');
        var scale = Math.min(1000/img.width, 1);
        c.width = img.width * scale; c.height = img.height * scale;
        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
        r(c.toDataURL('image/jpeg', 0.8));
      };
      img.src = e.target.result;
    };
    fr.readAsDataURL(file);
  });
}

/* Manual AI Search */
async function triggerManualAISearch() {
  if(!validateApiKey() || isRequesting) return;
  var name = document.getElementById('itemName').value;
  if(!name) return alert("Please enter Item Name");
  isRequesting = true; showProgress("Searching...");
  try {
    await waitForRateLimit();
    var p = `Search cosmetic "${name}". Return JSON: {"brand":"","category":"Ê¥óÈ°îÊñô/ÂåñÁ≤ßÊ∞¥/‰π≥Ê∂≤/ÁæéÂÆπÊ∂≤/„ÇØ„É™„Éº„É†/„Åù„ÅÆ‰ªñ","description":"","price":0,"releaseDate":""}`;
    var res = await fetch(getApiUrl(true), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: p }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    var d = await res.json();
    var j = parseAIJson(d.candidates[0].content.parts[0].text);
    if(j.brand) document.getElementById('brand').value = j.brand;
    if(j.category) document.getElementById('categorySelect').value = j.category;
    if(j.description) document.getElementById('description').value = j.description;
    if(j.price) document.getElementById('itemPrice').value = j.price;
    if(j.releaseDate) document.getElementById('releaseDate').value = j.releaseDate;
  } catch(e) { alert(e.message); }
  finally { isRequesting = false; hideProgress(); }
}

/* Data Management */
function addItem() {
  var item = {
    id: Date.now(),
    name: document.getElementById('itemName').value,
    brand: document.getElementById('brand').value,
    category: document.getElementById('categorySelect').value,
    description: document.getElementById('description').value,
    releaseDate: document.getElementById('releaseDate').value,
    price: document.getElementById('itemPrice').value,
    openDate: document.getElementById('openDate').value,
    tag: document.getElementById('timeTag').value
  };
  if(!item.name) return alert('Name is required');
  cosmeData.unshift(item);
  saveData(); render(); renderCospa();
  document.getElementById('itemName').value = '';
  alert('Added to collection');
}
function saveData() { localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData)); }
function removeItem(id) {
  if(confirm('Delete this item?')) {
    cosmeData = cosmeData.filter(i => i.id !== id);
    saveData(); render(); renderCospa();
  }
}
function markFinished(id) {
  var i = cosmeData.find(x => x.id === id);
  if(i) {
    i.finishDate = i.finishDate ? null : new Date().toISOString().split('T')[0];
    saveData(); render(); renderCospa();
  }
}
function saveEdit(id, key, val) {
  var i = cosmeData.find(x => x.id === id);
  if(i) { i[key] = val; saveData(); renderCospa(); }
}

/* Rendering */
function render() {
  var type = document.getElementById('sortSelect').value;
  var d = [...cosmeData];
  if (type === 'time') d.sort((a,b) => (a.tag||'').localeCompare(b.tag||''));
  else if (type === 'category') d.sort((a,b) => (a.category||'').localeCompare(b.category||''));
  else if (type === 'brand') d.sort((a,b) => (a.brand||'').localeCompare(b.brand||''));
  
  var html = '';
  d.forEach(item => {
    var badgeClass = item.tag === 'Êúù' ? 'morning' : (item.tag === 'Êô©' ? 'night' : 'both');
    var badgeLabel = item.tag === 'Êúù' ? 'SUN' : (item.tag === 'Êô©' ? 'MOON' : 'BOTH');
    
    html += `
    <details class="item-card-details">
      <summary>
        <div class="item-summ-left">
          <span class="item-brand">${escapeHtml(item.brand)}</span>
          <span class="item-name" style="${item.finishDate?'text-decoration:line-through;opacity:0.5':''}">${escapeHtml(item.name)}</span>
        </div>
        <div class="item-badges">
           ${item.finishDate ? '<span>‚úÖ</span>' : ''}
           <span class="badge ${badgeClass}">${badgeLabel}</span>
        </div>
      </summary>
      <div class="item-content">
        <p style="margin:5px 0;">${escapeHtml(item.description || 'No description')}</p>
        <div class="flex-row" style="margin-top:15px;">
           <input type="number" value="${item.price}" placeholder="Price" onchange="saveEdit(${item.id},'price',this.value)" style="font-size:0.9rem;">
           <input type="date" value="${item.openDate}" onchange="saveEdit(${item.id},'openDate',this.value)" style="font-size:0.9rem;">
        </div>
        <div class="flex-row" style="margin-top:10px;">
          <button class="btn-secondary" onclick="markFinished(${item.id})">${item.finishDate?'Restore':'Finish'}</button>
          <button class="btn-secondary" onclick="removeItem(${item.id})" style="color:red!important;border-color:#ffcccc!important;">Delete</button>
        </div>
      </div>
    </details>`;
  });
  document.getElementById('routineArea').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:50px;">No items registered.</div>';
}

/* Cospa Logic Update */
function renderCospa() {
  var cat = document.getElementById('cospaCategory').value;
  var sort = document.getElementById('cospaSort').value;
  
  var list = cosmeData.filter(i => (cat==='all'||i.category===cat) && i.price && i.openDate);
  
  // Sorting Logic Updated
  list.sort((a,b) => {
    var da = getDaily(a), db = getDaily(b);
    var daysA = getDays(a), daysB = getDays(b);
    
    if(sort === 'cost_asc') return da - db;
    if(sort === 'cost_desc') return db - da; // Added
    if(sort === 'days_desc') return daysA - daysB; // Logic flip (Longest use = High days = Low Cost effectively?) No, literally days count.
    // Correction: "Days Descending" means Longest first.
    if(sort === 'days_desc') return daysB - daysA;
    if(sort === 'days_asc') return daysA - daysB; // Added
    return 0;
  });

  var html = '';
  var totalDaily = 0;
  
  list.forEach(item => {
    var days = getDays(item);
    var daily = Math.round(getDaily(item));
    totalDaily += daily;
    var barWidth = Math.min(100, (daily / 150) * 100); // 150yen benchmark
    
    html += `
    <div class="cospa-card">
      <div class="cospa-header">
        <div>
          <div style="font-size:0.75rem;color:#999;">${escapeHtml(item.brand)}</div>
          <div style="font-weight:500;">${escapeHtml(item.name)}</div>
        </div>
        <div>
          <span class="cospa-price">¬•${daily}</span><span class="cospa-unit">/day</span>
        </div>
      </div>
      <div class="cospa-bar-bg"><div class="cospa-bar-fill" style="width:${barWidth}%"></div></div>
      <div class="cospa-meta">
        <span>¬•${item.price} total</span>
        <span>Used: ${days} days ${item.finishDate?'(Done)':''}</span>
      </div>
    </div>`;
  });

  document.getElementById('cospaList').innerHTML = html || '<div class="text-center" style="margin-top:40px;color:#ccc;">Not enough data for calculation</div>';
  
  if(list.length > 0) {
    document.getElementById('cospaTopSummary').innerHTML = `
      <div style="font-size:0.9rem; color:#999; font-family:var(--font-serif); font-style:italic;">Total Daily Cost</div>
      <div style="font-size:3rem; line-height:1; font-family:var(--font-serif);">¬•${Math.round(totalDaily)}</div>
    `;
  } else {
    document.getElementById('cospaTopSummary').innerHTML = '';
  }
}

function getDays(i) {
  var start = new Date(i.openDate);
  var end = i.finishDate ? new Date(i.finishDate) : new Date();
  var diff = Math.floor((end - start) / 86400000);
  return Math.max(1, diff);
}
function getDaily(i) { return i.price / getDays(i); }

/* Chat Logic (Refined) */
function createNewChat() {
  var id = 'chat_' + Date.now();
  chatHistories.unshift({ id: id, title: 'New Conversation', date: new Date().toISOString(), messages: [{ type: 'ai', text: 'Hello! I am your beauty advisor. Ask me anything about your collection.' }] });
  saveChatHistories(); loadChat(id);
}
function loadChat(id) {
  currentChatId = id;
  var chat = chatHistories.find(c => c.id === id);
  var area = document.getElementById('chatHistory');
  area.innerHTML = '';
  chat.messages.forEach(m => appendMsg(m.type, m.text));
  renderChatList();
}
function appendMsg(type, text) {
  var div = document.createElement('div');
  div.className = `msg-row ${type}`;
  var bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
  div.appendChild(bubble);
  document.getElementById('chatHistory').appendChild(div);
}
async function sendChatMessage() {
  if(!validateApiKey() || isRequesting) return;
  var txt = document.getElementById('chatInput').value.trim();
  if(!txt) return;
  
  document.getElementById('chatInput').value = '';
  isRequesting = true;
  appendMsg('user', txt);
  scrollToBottom();

  // Save user msg
  var chat = chatHistories.find(c => c.id === currentChatId);
  chat.messages.push({ type: 'user', text: txt });
  if(chat.messages.length === 2) chat.title = txt.substring(0, 20);
  saveChatHistories();

  try {
    await waitForRateLimit();
    var context = JSON.stringify(cosmeData.map(c => ({n:c.name, b:c.brand, c:c.category})));
    var prompt = `Role: Beauty Advisor. Context: User owns ${context}. Question: ${txt}`;
    
    var res = await fetch(getApiUrl(false), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    var d = await res.json();
    var ans = d.candidates[0].content.parts[0].text;
    
    appendMsg('ai', ans);
    chat.messages.push({ type: 'ai', text: ans });
    saveChatHistories();
  } catch(e) {
    appendMsg('ai', "Error: " + e.message);
  } finally {
    isRequesting = false;
    scrollToBottom();
  }
}
function saveChatHistories() { localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories)); }
function renderChatList() {
  var h = '';
  chatHistories.forEach(c => {
    h += `<div onclick="loadChat('${c.id}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; background:${c.id===currentChatId?'#f9f9f9':'#fff'}">
      <div style="font-weight:600; font-size:0.9rem;">${escapeHtml(c.title)}</div>
      <div style="font-size:0.75rem; color:#999;">${new Date(c.date).toLocaleDateString()}</div>
    </div>`;
  });
  document.getElementById('chatHistoryContainer').innerHTML = h;
}
function toggleChatHistory() {
  var el = document.getElementById('chatHistoryContainer');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
  renderChatList();
}

/* Settings Utils */
function saveSettings() {
  localStorage.setItem('geminiApiKey_v1', document.getElementById('geminiApiKey').value.trim());
  localStorage.setItem('chatModel_v1', document.getElementById('chatModelSelect').value);
  localStorage.setItem('fastModel_v1', document.getElementById('fastModelSelect').value);
  alert('Settings Saved');
}
function clearApiKey() { localStorage.removeItem('geminiApiKey_v1'); alert('Key cleared'); }
function exportData() {
  var b = new Blob([JSON.stringify({data:cosmeData, chats:chatHistories})], {type:'application/json'});
  var a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='cosme_backup.json'; a.click();
}
function importData(){ document.getElementById('importFile').click(); }
function handleImport(e){
  var r=new FileReader(); r.onload=function(ev){
    try{ var d=JSON.parse(ev.target.result); cosmeData=d.data||[]; chatHistories=d.chats||[]; saveData(); saveChatHistories(); render(); alert('Imported'); }catch(x){alert('Error');}
  }; r.readAsText(e.target.files[0]);
}

function escapeHtml(text) {
  if(text == null) return '';
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
</script>
</body>
</html>
