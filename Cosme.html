<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cosme Genius Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap');

* {
box-sizing: border-box;
-webkit-tap-highlight-color: transparent;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Hiragino Sans', 'Yu Gothic', sans-serif;
background: #fafafa;
margin: 0;
padding: 0;
padding-bottom: 30px;
color: #1a1a1a;
line-height: 1.6;
-webkit-font-smoothing: antialiased;
overflow-x: hidden;
}

.container {
max-width: 500px;
margin: 0 auto;
padding: 0 20px 30px;
}

.header {
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
color: white;
padding: 25px 20px;
text-align: center;
font-family: 'Cormorant Garamond', serif;
letter-spacing: 4px;
font-weight: 300;
font-size: 1.4rem;
margin: 0 -20px 30px;
box-shadow: 0 4px 20px rgba(0,0,0,0.15);
position: relative;
overflow: hidden;
animation: headerSlideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

.header::before {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
animation: headerGlow 8s ease-in-out infinite;
}

@keyframes headerSlideDown {
from {
opacity: 0;
transform: translateY(-30px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

@keyframes headerGlow {
0%, 100% { transform: translate(0, 0); }
50% { transform: translate(30px, 30px); }
}

/* Tabs */
.tabs {
display: flex;
margin-bottom: 30px;
background: #ffffff;
border-radius: 12px;
overflow: hidden;
box-shadow: 0 2px 15px rgba(0,0,0,0.08);
animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
}

.tab-btn {
flex: 1;
background: transparent;
color: #666666;
border: none;
border-right: 1px solid #f0f0f0;
padding: 18px 10px;
cursor: pointer;
font-weight: 500;
font-size: 13px;
transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
letter-spacing: 0.5px;
position: relative;
}

.tab-btn:last-child { border-right: none; }

.tab-btn::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 3px;
background: #000000;
transform: scaleX(0);
transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

.tab-btn.active::before {
transform: scaleX(1);
}

.tab-btn:active {
transform: scale(0.95);
}

.tab-btn.active {
background: linear-gradient(to bottom, #fafafa 0%, #ffffff 100%);
color: #000000;
font-weight: 600;
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

/* Cards */
.card {
background: #ffffff;
padding: 30px;
margin-bottom: 25px;
border-radius: 16px;
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
animation: cardAppear 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
}

.card:hover {
box-shadow: 0 8px 30px rgba(0,0,0,0.12);
transform: translateY(-2px);
}

@keyframes cardAppear {
from {
opacity: 0;
transform: translateY(30px) scale(0.95);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

.card:nth-child(2) { animation-delay: 0.1s; }
.card:nth-child(3) { animation-delay: 0.2s; }

h2 {
font-size: 0.85rem;
font-family: 'Cormorant Garamond', serif;
color: #1a1a1a;
letter-spacing: 2px;
text-transform: uppercase;
font-weight: 600;
margin: 0 0 25px 0;
padding-bottom: 15px;
border-bottom: 2px solid #000000;
position: relative;
}

h2::after {
content: '';
position: absolute;
bottom: -2px;
left: 0;
width: 50px;
height: 2px;
background: #c9a97e;
animation: borderExpand 1s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes borderExpand {
from { width: 0; }
to { width: 50px; }
}

/* Form Elements */
input, select, button, textarea {
width: 100%;
padding: 14px 18px;
margin-top: 12px;
border: 2px solid #e5e5e5;
box-sizing: border-box;
font-size: 16px;
font-family: inherit;
background: white;
border-radius: 10px;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

input:focus, select:focus, textarea:focus {
outline: none;
border-color: #000000;
box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
transform: translateY(-1px);
}

button {
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
color: white;
border: none;
font-weight: 600;
cursor: pointer;
letter-spacing: 1px;
text-transform: uppercase;
font-size: 13px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
position: relative;
overflow: hidden;
}

button::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
border-radius: 50%;
background: rgba(255,255,255,0.2);
transform: translate(-50%, -50%);
transition: width 0.6s, height 0.6s;
}

button:hover::before {
width: 300px;
height: 300px;
}

button:hover {
box-shadow: 0 6px 25px rgba(0,0,0,0.3);
transform: translateY(-2px);
}

button:active {
transform: translateY(0);
box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

button:disabled {
background: #ccc;
cursor: not-allowed;
opacity: 0.5;
box-shadow: none;
}

textarea { resize: none; min-height: 90px; }

/* Progress Bar */
.progress-container {
background: linear-gradient(to bottom, #fafafa, #ffffff);
margin-bottom: 20px;
display: none;
padding: 20px;
border-radius: 12px;
box-shadow: 0 2px 15px rgba(0,0,0,0.08);
animation: fadeInUp 0.3s ease;
}

.progress-bar-bg {
width: 100%;
background: #e0e0e0;
height: 6px;
overflow: hidden;
margin-top: 12px;
border-radius: 10px;
}

.progress-bar-fill {
height: 100%;
width: 0%;
background: linear-gradient(90deg, #000000, #c9a97e);
transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
border-radius: 10px;
position: relative;
overflow: hidden;
}

.progress-bar-fill::after {
content: '';
position: absolute;
top: 0;
left: 0;
bottom: 0;
right: 0;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
0% { transform: translateX(-100%); }
100% { transform: translateX(100%); }
}

/* Chat Area */
.chat-area {
height: 420px;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
background: linear-gradient(to bottom, #f9f9f9, #ffffff);
padding: 20px;
border-radius: 12px;
box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
display: flex;
flex-direction: column;
gap: 12px;
margin-bottom: 15px;
}

.msg-user {
align-self: flex-end;
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
color: white;
padding: 14px 20px;
border-radius: 18px 18px 4px 18px;
max-width: 80%;
font-size: 15px;
word-wrap: break-word;
line-height: 1.5;
box-shadow: 0 2px 10px rgba(0,0,0,0.15);
animation: messageSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
transform-origin: bottom right;
}

.msg-ai {
align-self: flex-start;
background: white;
border: 2px solid #f0f0f0;
color: #1a1a1a;
padding: 16px 20px;
border-radius: 18px 18px 18px 4px;
max-width: 85%;
font-size: 15px;
line-height: 1.7;
word-wrap: break-word;
box-shadow: 0 2px 10px rgba(0,0,0,0.08);
animation: messageSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
transform-origin: bottom left;
}

/* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è£…é£¾ã‚¹ã‚¿ã‚¤ãƒ« */
.msg-ai strong,
.msg-ai b {
color: #000000;
font-weight: 700;
}

.msg-ai h3 {
font-size: 16px;
font-weight: 700;
color: #000000;
margin: 12px 0 8px 0;
border-bottom: 2px solid #c9a97e;
padding-bottom: 6px;
}

.msg-ai h4 {
font-size: 15px;
font-weight: 600;
color: #2c2c2c;
margin: 10px 0 6px 0;
}

.msg-ai em,
.msg-ai i {
color: #c9a97e;
font-style: italic;
}

.msg-ai code {
background: #f5f5f5;
border: 1px solid #e0e0e0;
padding: 2px 6px;
border-radius: 4px;
font-family: 'Courier New', monospace;
font-size: 14px;
color: #d32f2f;
}

.msg-ai ul,
.msg-ai ol {
margin: 8px 0;
padding-left: 24px;
}

.msg-ai li {
margin: 6px 0;
line-height: 1.6;
}

.msg-ai a {
color: #1976d2;
text-decoration: underline;
}

.msg-ai blockquote {
border-left: 4px solid #c9a97e;
padding-left: 16px;
margin: 12px 0;
color: #666;
font-style: italic;
}

.msg-ai .highlight {
background: linear-gradient(180deg, transparent 60%, rgba(201, 169, 126, 0.3) 60%);
padding: 0 4px;
font-weight: 600;
}

.msg-ai .emoji {
font-size: 18px;
}

@keyframes messageSlideIn {
from {
opacity: 0;
transform: scale(0.8) translateY(10px);
}
to {
opacity: 1;
transform: scale(1) translateY(0);
}
}

.msg-system {
color: #c62828;
background: linear-gradient(135deg, #ffebee, #fff5f5);
padding: 14px;
border-radius: 12px;
border: 2px solid #ef9a9a;
font-size: 13px;
animation: messageSlideIn 0.3s ease;
}

.chat-input-bar {
display: flex;
gap: 12px;
}

.chat-textarea {
flex-grow: 1;
height: 50px;
resize: none;
padding: 14px 18px;
}

.send-btn {
width: 50px;
height: 50px;
padding: 0;
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
font-size: 18px;
flex-shrink: 0;
border-radius: 12px;
}

/* Chat Controls */
.chat-controls {
display: flex;
gap: 12px;
margin-bottom: 15px;
}

.chat-controls button {
margin-top: 0;
padding: 12px 18px;
font-size: 12px;
}

/* Chat History List */
.chat-history-list {
margin-bottom: 20px;
max-height: 300px;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
}

.chat-history-item {
background: white;
border: 2px solid #f0f0f0;
padding: 14px 18px;
margin-bottom: 10px;
cursor: pointer;
display: flex;
justify-content: space-between;
align-items: center;
border-radius: 12px;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
animation: fadeInUp 0.3s ease both;
}

.chat-history-item:nth-child(1) { animation-delay: 0.05s; }
.chat-history-item:nth-child(2) { animation-delay: 0.1s; }
.chat-history-item:nth-child(3) { animation-delay: 0.15s; }

.chat-history-item:hover {
background: #fafafa;
border-color: #000000;
transform: translateX(4px);
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.chat-history-item.active {
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
color: white;
border-color: #000000;
box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.chat-history-info {
flex: 1;
}

.chat-history-title {
font-size: 13px;
font-weight: 600;
margin-bottom: 3px;
letter-spacing: 0.3px;
}

.chat-history-date {
font-size: 11px;
opacity: 0.7;
}

.chat-history-delete {
width: auto;
padding: 8px 14px;
font-size: 11px;
margin: 0;
background: #d32f2f;
box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
}

.chat-history-item.active .chat-history-delete {
background: white;
color: #000000;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Item Cards */
.item-card-details {
border: 2px solid #f0f0f0;
margin-top: 15px;
background: white;
overflow: hidden;
border-radius: 12px;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
animation: fadeInUp 0.4s ease both;
}

.item-card-details:hover {
box-shadow: 0 4px 20px rgba(0,0,0,0.08);
border-color: #000000;
}

.item-card-details[open] {
box-shadow: 0 6px 25px rgba(0,0,0,0.12);
}

.item-card-details summary {
padding: 20px;
cursor: pointer;
list-style: none;
font-weight: 600;
user-select: none;
font-size: 14px;
letter-spacing: 0.3px;
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
position: relative;
}

.item-card-details summary::after {
content: 'â–¼';
position: absolute;
right: 20px;
top: 50%;
transform: translateY(-50%) rotate(0deg);
transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
font-size: 12px;
opacity: 0.6;
}

.item-card-details[open] summary::after {
transform: translateY(-50%) rotate(180deg);
}

.item-card-details summary:hover {
background: linear-gradient(to right, #fafafa, #ffffff);
}

.item-card-details summary::-webkit-details-marker { display: none; }

.item-details-content {
padding: 25px;
font-size: 13px;
border-top: 2px solid #f5f5f5;
background: linear-gradient(to bottom, #fafafa, #ffffff);
line-height: 1.8;
animation: expandDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes expandDown {
from {
opacity: 0;
transform: translateY(-10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.item-details-content p {
margin: 10px 0;
color: #1a1a1a;
}

.item-details-content b {
color: #1a1a1a;
font-weight: 600;
letter-spacing: 0.5px;
}

/* Category Headers */
.category-header {
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
color: white;
padding: 18px 25px;
margin-top: 25px;
margin-bottom: 15px;
font-family: 'Cormorant Garamond', serif;
font-size: 14px;
letter-spacing: 2px;
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
border-radius: 10px;
box-shadow: 0 4px 15px rgba(0,0,0,0.15);
animation: fadeInUp 0.4s ease both;
}

.category-header:first-child {
margin-top: 0;
}

.category-count {
font-size: 11px;
background: rgba(255,255,255,0.2);
padding: 6px 12px;
letter-spacing: 1px;
border-radius: 20px;
backdrop-filter: blur(10px);
}

/* Pagination */
.pagination {
display: flex;
justify-content: center;
align-items: center;
gap: 15px;
margin-top: 25px;
}

.pagination button {
width: auto;
padding: 12px 22px;
font-size: 12px;
margin-top: 0;
}

.pagination span {
padding: 12px 22px;
background: white;
border: 2px solid #f0f0f0;
font-size: 13px;
letter-spacing: 0.5px;
border-radius: 10px;
font-weight: 600;
}

/* Sorting Controls */
.sort-controls {
display: flex;
gap: 12px;
margin-bottom: 20px;
}

.sort-controls select { margin-top: 0; }

/* Warnings */
.expire-warning {
background: linear-gradient(135deg, #fff3e0, #ffe0b2);
border: 2px solid #ffb74d;
color: #e65100;
padding: 12px 16px;
font-size: 12px;
margin-bottom: 15px;
letter-spacing: 0.3px;
border-radius: 10px;
font-weight: 500;
animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.02); }
}

.alert-box {
background: linear-gradient(135deg, #fff8e1, #ffecb3);
border: 2px solid #ffd54f;
padding: 18px;
margin-bottom: 20px;
font-size: 13px;
color: #f57f17;
line-height: 1.6;
border-radius: 12px;
box-shadow: 0 2px 15px rgba(245, 127, 23, 0.15);
}

.alert-box b {
display: block;
margin-bottom: 8px;
font-weight: 600;
}

/* Photo Input Buttons */
.photo-buttons {
display: flex;
gap: 12px;
margin-bottom: 25px;
}

.photo-input-label {
flex: 1;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
color: white;
padding: 16px;
font-weight: 600;
cursor: pointer;
letter-spacing: 0.5px;
font-size: 13px;
border-radius: 12px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
position: relative;
overflow: hidden;
}

.photo-input-label::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
border-radius: 50%;
background: rgba(255,255,255,0.2);
transform: translate(-50%, -50%);
transition: width 0.6s, height 0.6s;
}

.photo-input-label:active::before {
width: 300px;
height: 300px;
}

.photo-input-label:active {
box-shadow: 0 6px 25px rgba(0,0,0,0.3);
transform: translateY(-2px);
}

.btn-secondary {
background: linear-gradient(135deg, #c9a97e 0%, #b8976d 100%) !important;
color: white !important;
}

.btn-danger {
background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%) !important;
color: white !important;
}

.retry-notice {
background: linear-gradient(135deg, #e3f2fd, #bbdefb);
border: 2px solid #90caf9;
color: #1565c0;
padding: 14px;
margin-top: 15px;
font-size: 12px;
line-height: 1.6;
border-radius: 10px;
}

/* Flex utilities */
.flex-row {
display: flex;
gap: 10px;
}

.flex-between {
display: flex;
justify-content: space-between;
align-items: center;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
width: 8px;
height: 8px;
}

::-webkit-scrollbar-track {
background: #f0f0f0;
border-radius: 10px;
}

::-webkit-scrollbar-thumb {
background: linear-gradient(135deg, #c9a97e, #b8976d);
border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
background: linear-gradient(135deg, #b8976d, #a8866d);
}
</style>
</head>
<body>

<div class="header">
<span style="position: relative; z-index: 1;">COSME GENIUS PRO</span>
</div>

<div class="container">
<div class="tabs">
<button class="tab-btn active" id="btn-register" onclick="switchTab('register')">ğŸ’„ ç™»éŒ²</button>
<button class="tab-btn" id="btn-chat" onclick="switchTab('chat')">ğŸ’¬ ç›¸è«‡</button>
<button class="tab-btn" id="btn-settings" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
</div>

<div id="tab-register" class="tab-content active">
<div class="card">
<h2>âœ¨ ã‚³ã‚¹ãƒ¡ç™»éŒ²</h2>
<div class="photo-buttons">
<label for="cameraInput" class="photo-input-label">
<span style="position: relative; z-index: 1;">ğŸ“¸ ã‚«ãƒ¡ãƒ©</span>
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(event)">
</label>
<label for="albumInput" class="photo-input-label">
<span style="position: relative; z-index: 1;">ğŸ–¼ï¸ ã‚¢ãƒ«ãƒãƒ </span>
<input type="file" id="albumInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
</label>
</div>

<div id="progressContainer" class="progress-container">
<div id="progressText" style="font-size: 12px; color: #1a1a1a; text-align: center; font-weight: 500; letter-spacing: 0.5px;">ç”»åƒã‚’è§£æä¸­...</div>
<div class="progress-bar-bg"><div id="progressBar" class="progress-bar-fill"></div></div>
</div>

<div class="flex-row">
<input type="text" id="itemName" placeholder="å•†å“å" style="margin-top:0;">
<button onclick="triggerManualAISearch()" style="width: auto; white-space: nowrap; margin-top:0; padding:0 18px;"><span style="position: relative; z-index: 1;">âœ¨ AIæ¨æ¸¬</span></button>
</div>

<input type="text" id="brand" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰å">
<select id="categorySelect">
<option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
<option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
<option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
<option value="ä¹³æ¶²">ä¹³æ¶²</option>
<option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
<option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
<option value="ãã®ä»–">ãã®ä»–</option>
</select>
<input type="text" id="ingredient" placeholder="ä¸»è¦æˆåˆ†">
<textarea id="description" placeholder="å•†å“èª¬æ˜"></textarea>
<div class="flex-row">
<input type="text" id="releaseDate" placeholder="ç™ºå£²æ—¥">
<input type="number" id="itemPrice" placeholder="ä¾¡æ ¼">
</div>
<label style="font-size:12px; color:#666666; margin-top:12px; display:block; letter-spacing: 0.3px;">ä½¿ç”¨é–‹å§‹æ—¥</label>
<input type="date" id="openDate">
<select id="timeTag"><option value="æœ">æœç”¨</option><option value="æ™©">æ™©ç”¨</option><option value="æœæ™©">æœæ™©ä¸¡æ–¹</option></select>
<button onclick="addItem()" style="margin-top:20px; padding: 15px;"><span style="position: relative; z-index: 1;">ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹</span></button>
</div>

<div class="card">
<div class="flex-between" style="margin-bottom: 20px;">
<h2 style="margin: 0; border: none; padding: 0;">ğŸ“‹ ç™»éŒ²æ¸ˆã¿ã‚³ã‚¹ãƒ¡</h2>
<button onclick="exportData()" class="btn-secondary" style="width: auto; padding: 10px 15px; font-size: 11px; margin: 0;"><span style="position: relative; z-index: 1;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span></button>
</div>

<div class="sort-controls">
<select id="sortSelect" onchange="render()">
<option value="newest">æ–°ç€é †</option>
<option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
<option value="brand">ãƒ–ãƒ©ãƒ³ãƒ‰åˆ¥</option>
<option value="expiring">æœŸé™è¿‘ã„é †</option>
</select>
</div>

<div id="routineArea"></div>
<div id="paginationArea" class="pagination"></div>
</div>
</div>

<div id="tab-chat" class="tab-content">
<div class="card" style="padding: 20px;">
<h2>ğŸ’¬ ã‚³ã‚¹ãƒ¡ç›¸è«‡å®¤</h2>

<div class="chat-controls">
<button onclick="createNewChat()" style="flex: 1;"><span style="position: relative; z-index: 1;">â• æ–°è¦ãƒãƒ£ãƒƒãƒˆ</span></button>
<button onclick="toggleChatHistory()" id="historyToggleBtn" style="flex: 1;"><span style="position: relative; z-index: 1;">ğŸ“œ å±¥æ­´</span></button>
</div>

<div id="chatHistoryContainer" class="chat-history-list" style="display: none;"></div>

<div id="chatHistory" class="chat-area"><div class="msg-ai">ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã•ã‚ŒãŸã‚³ã‚¹ãƒ¡æƒ…å ±ã‚’å…ƒã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™âœ¨</div></div>
<div class="chat-input-bar">
<textarea id="chatInput" class="chat-textarea" placeholder="è³ªå•ã‚’å…¥åŠ›..."></textarea>
<button id="sendBtn" onclick="sendChatMessage()" class="send-btn"><span style="position: relative; z-index: 1;">â¤</span></button>
</div>
</div>
</div>

<div id="tab-settings" class="tab-content">
<div class="card">
<h2>âš™ï¸ ã‚¢ãƒ—ãƒªè¨­å®š</h2>

<div class="alert-box">
<b>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„</b>
APIã‚­ãƒ¼ã¯æš—å·åŒ–ã•ã‚Œãšã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å…±æœ‰ç«¯æœ«ã§ã¯ä½¿ç”¨å¾Œã«å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
</div>

<label style="font-weight:600; color:#1a1a1a; font-size:13px; letter-spacing: 0.5px; display: block; margin-bottom: 5px;">ğŸ¤– Gemini API ã‚­ãƒ¼</label>
<input type="password" id="geminiApiKey" placeholder="AIzaSy...">

<p style="font-size:12px; color:#666666; margin:15px 0 8px; letter-spacing: 0.3px;">ğŸ¤– ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«</p>
<select id="geminiModelSelect">
<option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨å¥¨)</option>
<option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
<option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
<option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
</select>

<div class="retry-notice">
ğŸ’¡ <b>ã‚¨ãƒ©ãƒ¼429å¯¾ç­–:</b> ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã‚‹å ´åˆã¯1åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚ç„¡æ–™æ ã®å ´åˆã¯1åˆ†ã‚ãŸã‚Š15ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸Šé™ã§ã™ã€‚
</div>

<button onclick="saveSettings()" style="margin-top: 20px; padding: 15px;"><span style="position: relative; z-index: 1;">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</span></button>
<button onclick="clearApiKey()" class="btn-danger" style="margin-top: 10px; padding: 15px;"><span style="position: relative; z-index: 1;">ğŸ—‘ï¸ APIã‚­ãƒ¼ã‚’å‰Šé™¤</span></button>

<hr style="margin: 25px 0; border: none; border-top: 1px solid #e5e5e5;">

<button onclick="importData()" class="btn-secondary" style="padding: 15px;"><span style="position: relative; z-index: 1;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</span></button>
<input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
</div>
</div>

</div>

<canvas id="compressionCanvas" style="display:none;"></canvas>

<script>
let cosmeData = JSON.parse(localStorage.getItem('cosmeData_v8')) || [];
let currentPage = 1;
const itemsPerPage = 10;
let isRequesting = false;
let lastRequestTime = 0;

// ãƒãƒ£ãƒƒãƒˆé–¢é€£ã®å¤‰æ•°
let chatHistories = JSON.parse(localStorage.getItem('chatHistories_v1')) || [];
let currentChatId = null;
let showingHistory = false;

document.addEventListener("DOMContentLoaded", function() {
document.getElementById('openDate').valueAsDate = new Date();
document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey_v1') || '';
document.getElementById('geminiModelSelect').value = localStorage.getItem('geminiModelName_v2') || 'gemini-2.5-flash';

document.getElementById('chatInput').addEventListener('keydown', function(e) {
if (e.key === 'Enter' && !e.shiftKey) {
e.preventDefault();
sendChatMessage();
}
});

// æœ€å¾Œã®ãƒãƒ£ãƒƒãƒˆã‚’å¾©å…ƒã¾ãŸã¯æ–°è¦ä½œæˆ
if(chatHistories.length > 0) {
currentChatId = chatHistories[0].id;
loadChat(currentChatId);
} else {
createNewChat();
}

render();
checkExpiredItems();
});

function switchTab(tabId) {
var contents = document.querySelectorAll('.tab-content');
for(var i = 0; i < contents.length; i++) {
contents[i].classList.remove('active');
}
var btns = document.querySelectorAll('.tab-btn');
for(var i = 0; i < btns.length; i++) {
btns[i].classList.remove('active');
}
document.getElementById('tab-' + tabId).classList.add('active');
document.getElementById('btn-' + tabId).classList.add('active');
}

// === ãƒãƒ£ãƒƒãƒˆå±¥æ­´ç®¡ç† ===

function createNewChat() {
var chatId = 'chat_' + Date.now();
var newChat = {
id: chatId,
title: 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ',
date: new Date().toISOString(),
messages: [{
type: 'ai',
text: 'ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã•ã‚ŒãŸã‚³ã‚¹ãƒ¡æƒ…å ±ã‚’å…ƒã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™âœ¨'
}]
};

chatHistories.unshift(newChat);
saveChatHistories();
currentChatId = chatId;
loadChat(chatId);

if(showingHistory) {
toggleChatHistory();
}
}

function loadChat(chatId) {
currentChatId = chatId;
var chat = chatHistories.find(function(c) { return c.id === chatId; });
if(!chat) return;

var chatHistory = document.getElementById('chatHistory');
chatHistory.innerHTML = '';

for(var i = 0; i < chat.messages.length; i++) {
var msg = chat.messages[i];
var msgClass = msg.type === 'user' ? 'msg-user' : (msg.type === 'ai' ? 'msg-ai' : 'msg-system');
var msgDiv = document.createElement('div');
msgDiv.className = msgClass;
msgDiv.innerHTML = formatMessage(msg.text, msg.type);
chatHistory.appendChild(msgDiv);
}

chatHistory.scrollTop = chatHistory.scrollHeight;
renderChatHistoryList();
}

function formatMessage(text, type) {
if(type === 'user' || type === 'system') {
return escapeHtml(text).replace(/\n/g, '<br>');
}

// AI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è£…é£¾å‡¦ç†
var formatted = escapeHtml(text);

// è¦‹å‡ºã—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³: ### è¦‹å‡ºã—3, ## è¦‹å‡ºã—2
formatted = formatted.replace(/###\s+(.+?)($|\n)/g, '<h4>$1</h4>');
formatted = formatted.replace(/##\s+(.+?)($|\n)/g, '<h3>$1</h3>');

// å¤ªå­—: **ãƒ†ã‚­ã‚¹ãƒˆ**
formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

// ã‚¤ã‚¿ãƒªãƒƒã‚¯: *ãƒ†ã‚­ã‚¹ãƒˆ*
formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');

// ã‚³ãƒ¼ãƒ‰: `ã‚³ãƒ¼ãƒ‰`
formatted = formatted.replace(/`(.+?)`/g, '<code>$1</code>');

// ãƒªã‚¹ãƒˆ: - ã¾ãŸã¯ â€¢ ã§å§‹ã¾ã‚‹è¡Œ
formatted = formatted.replace(/^[-â€¢]\s+(.+?)$/gm, '<li>$1</li>');
formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

// æ•°å­—ãƒªã‚¹ãƒˆ: 1. ã§å§‹ã¾ã‚‹è¡Œ
formatted = formatted.replace(/^\d+\.\s+(.+?)$/gm, '<li>$1</li>');
if(formatted.match(/<li>.*<\/li>/)) {
formatted = formatted.replace(/(<li>.*<\/li>)/s, function(match) {
if(!match.includes('<ul>')) {
return '<ol>' + match + '</ol>';
}
return match;
});
}

// æ”¹è¡Œ
formatted = formatted.replace(/\n/g, '<br>');

return formatted;
}

function toggleChatHistory() {
showingHistory = !showingHistory;
var container = document.getElementById('chatHistoryContainer');
var btn = document.getElementById('historyToggleBtn');

if(showingHistory) {
container.style.display = 'block';
btn.innerHTML = '<span style="position: relative; z-index: 1;">âœ• é–‰ã˜ã‚‹</span>';
renderChatHistoryList();
} else {
container.style.display = 'none';
btn.innerHTML = '<span style="position: relative; z-index: 1;">ğŸ“œ å±¥æ­´</span>';
}
}

function renderChatHistoryList() {
var container = document.getElementById('chatHistoryContainer');
var html = '';

for(var i = 0; i < chatHistories.length; i++) {
var chat = chatHistories[i];
var isActive = chat.id === currentChatId;
var date = new Date(chat.date).toLocaleString('ja-JP', {
month: 'short',
day: 'numeric',
hour: '2-digit',
minute: '2-digit'
});

html += '<div class="chat-history-item' + (isActive ? ' active' : '') + '" onclick="selectChat(\'' + chat.id + '\')">';
html += '<div class="chat-history-info">';
html += '<div class="chat-history-title">' + escapeHtml(chat.title) + '</div>';
html += '<div class="chat-history-date">' + date + '</div>';
html += '</div>';
html += '<button class="chat-history-delete" onclick="event.stopPropagation(); deleteChat(\'' + chat.id + '\')"><span style="position: relative; z-index: 1;">ğŸ—‘ï¸</span></button>';
html += '</div>';
}

if(html === '') {
html = '<div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
}

container.innerHTML = html;
}

function selectChat(chatId) {
loadChat(chatId);
}

function deleteChat(chatId) {
if(!confirm('ã“ã®ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

chatHistories = chatHistories.filter(function(c) { return c.id !== chatId; });
saveChatHistories();

if(currentChatId === chatId) {
if(chatHistories.length > 0) {
loadChat(chatHistories[0].id);
} else {
createNewChat();
}
} else {
renderChatHistoryList();
}
}

function saveChatHistories() {
localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories));
}

function updateChatTitle(chatId, firstMessage) {
var chat = chatHistories.find(function(c) { return c.id === chatId; });
if(!chat) return;

var title = firstMessage.length > 20 ? firstMessage.substring(0, 20) + '...' : firstMessage;
chat.title = title;
saveChatHistories();
renderChatHistoryList();
}

function addMessageToChat(chatId, type, text) {
var chat = chatHistories.find(function(c) { return c.id === chatId; });
if(!chat) return;

chat.messages.push({ type: type, text: text });

// æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
if(type === 'user' && chat.messages.filter(function(m) { return m.type === 'user'; }).length === 1) {
updateChatTitle(chatId, text);
}

saveChatHistories();
}

function saveSettings() {
localStorage.setItem('geminiApiKey_v1', document.getElementById('geminiApiKey').value.trim());
localStorage.setItem('geminiModelName_v2', document.getElementById('geminiModelSelect').value);
alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼âœ¨');
}

function clearApiKey() {
if(confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
localStorage.removeItem('geminiApiKey_v1');
document.getElementById('geminiApiKey').value = '';
alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}
}

function validateApiKey() {
var apiKey = localStorage.getItem('geminiApiKey_v1');
if (!apiKey || apiKey.length < 10) {
alert('âš ï¸ è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');
switchTab('settings');
return false;
}
return true;
}

async function waitForRateLimit() {
var now = Date.now();
var timeSinceLastRequest = now - lastRequestTime;
var minInterval = 4000;

if (timeSinceLastRequest < minInterval) {
var waitTime = minInterval - timeSinceLastRequest;
await new Promise(function(resolve) { setTimeout(resolve, waitTime); });
}
lastRequestTime = Date.now();
}

function getApiUrl(method) {
method = method || "generateContent";
var apiKey = localStorage.getItem('geminiApiKey_v1');
var modelName = localStorage.getItem('geminiModelName_v2') || 'gemini-2.5-flash';
var apiVersion = 'v1beta';
var action = method === "stream" ? "streamGenerateContent?alt=sse" : "generateContent";
return 'https://generativelanguage.googleapis.com/' + apiVersion + '/models/' + modelName + ':' + action + '?key=' + apiKey;
}

function parseAIJson(text) {
try {
var jsonText = text.replace(/```json\n?|```/g, '').trim();
return JSON.parse(jsonText);
} catch (e) {
console.error("JSON Parse Error:", e);
throw new Error("AIã®å¿œç­”å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
}
}

async function triggerManualAISearch() {
if(!validateApiKey()) return;
if(isRequesting) {
alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚');
return;
}

var name = document.getElementById('itemName').value.trim();
if (!name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

isRequesting = true;
startProgress("AIãŒè©³ç´°ã‚’æ¤œç´¢ä¸­...", 40);

try {
await waitForRateLimit();

var prompt = 'ã€Œ' + name + 'ã€ã®åŒ–ç²§å“æƒ…å ±ã‚’èª¿æŸ»ã—ã€ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚\n{"brand": "ãƒ–ãƒ©ãƒ³ãƒ‰å", "category": "æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–", "ingredients": "ä¸»è¦æˆåˆ†", "description": "çŸ­ã„èª¬æ˜", "price": æ•°å€¤, "releaseDate": "YYYY/MM/DD"}';

var resp = await fetch(getApiUrl(), {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
contents: [{ parts: [{ text: prompt }] }],
generationConfig: { temperature: 0.7 }
})
});

if(!resp.ok) {
var errorData = await resp.json().catch(function() { return {}; });
if(resp.status === 429) {
throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚1åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
}
if(resp.status === 404) {
throw new Error('ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã§åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼: ' + (errorData.error ? errorData.error.message : 'Unknown'));
}
throw new Error('API Error: ' + resp.status + ' - ' + (errorData.error ? errorData.error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
}

var data = await resp.json();
if(data.error) throw new Error(data.error.message);

var res = parseAIJson(data.candidates[0].content.parts[0].text);

document.getElementById('brand').value = res.brand || "";
document.getElementById('categorySelect').value = res.category || "";
document.getElementById('ingredient').value = res.ingredients || "";
document.getElementById('description').value = res.description || "";
document.getElementById('itemPrice').value = res.price || "";
document.getElementById('releaseDate').value = res.releaseDate || "";
finishProgress();
} catch (e) {
hideProgress();
alert("AIæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
} finally {
isRequesting = false;
}
}

async function handleImageSelect(event) {
if(!validateApiKey()) return;
if(isRequesting) {
alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚');
event.target.value = '';
return;
}

var file = event.target.files[0];
if (!file) return;

isRequesting = true;
startProgress("ç”»åƒã‚’è§£æä¸­...", 30);

try {
var base64Data = await compressImage(file);
updateProgress(60);
var base64 = base64Data.split(',')[1];

await waitForRateLimit();

var prompt = "ç”»åƒã‹ã‚‰åŒ–ç²§å“æƒ…å ±ã‚’èª­ã¿å–ã‚Šã€ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€‚ {itemName, brandName, category, ingredients, description, releaseDate, price}";

var resp = await fetch(getApiUrl(), {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
contents: [{
parts: [
{ text: prompt },
{ inlineData: { mimeType: "image/jpeg", data: base64 } }
]
}],
generationConfig: { temperature: 0.7 }
})
});

if(!resp.ok) {
var errorData = await resp.json().catch(function() { return {}; });
if(resp.status === 429) {
throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚1åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
}
if(resp.status === 404) {
throw new Error('ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã§åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼: ' + (errorData.error ? errorData.error.message : 'Unknown'));
}
throw new Error('API Error: ' + resp.status + ' - ' + (errorData.error ? errorData.error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
}

var data = await resp.json();
if(data.error) throw new Error(data.error.message);

var res = parseAIJson(data.candidates[0].content.parts[0].text);
document.getElementById('itemName').value = res.itemName || "";
document.getElementById('brand').value = res.brandName || "";
document.getElementById('ingredient').value = res.ingredients || "";
document.getElementById('releaseDate').value = res.releaseDate || "";
document.getElementById('itemPrice').value = res.price || "";
finishProgress();
} catch (e) {
hideProgress();
alert("è§£æã‚¨ãƒ©ãƒ¼: " + e.message);
} finally {
isRequesting = false;
event.target.value = '';
}
}

function compressImage(file) {
return new Promise(function(resolve) {
var r = new FileReader();
r.readAsDataURL(file);
r.onload = function(e) {
var img = new Image();
img.src = e.target.result;
img.onload = function() {
var c = document.getElementById('compressionCanvas');
var ctx = c.getContext('2d');
var scale = Math.min(600 / img.width, 1);
c.width = img.width * scale;
c.height = img.height * scale;
ctx.drawImage(img, 0, 0, c.width, c.height);
resolve(c.toDataURL('image/jpeg', 0.75));
};
};
});
}

async function sendChatMessage() {
if(!validateApiKey()) return;
if(isRequesting) {
alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚');
return;
}

var inputEl = document.getElementById('chatInput');
var sendBtn = document.getElementById('sendBtn');
var message = inputEl.value.trim();
if (!message) return;

isRequesting = true;
inputEl.disabled = true;
sendBtn.disabled = true;
var chatHistory = document.getElementById('chatHistory');

var userMsgDiv = document.createElement('div');
userMsgDiv.className = 'msg-user';
userMsgDiv.textContent = message;
chatHistory.appendChild(userMsgDiv);

addMessageToChat(currentChatId, 'user', message);

inputEl.value = '';
chatHistory.scrollTop = chatHistory.scrollHeight;

var loadingId = 'loading-' + Date.now();
var loadingDiv = document.createElement('div');
loadingDiv.id = loadingId;
loadingDiv.className = 'msg-ai';
loadingDiv.style.color = '#999';
loadingDiv.textContent = 'è€ƒãˆä¸­...';
chatHistory.appendChild(loadingDiv);

var cosmeListText = cosmeData.length > 0 ? JSON.stringify(cosmeData) : 'ç™»éŒ²ã‚³ã‚¹ãƒ¡ãªã—';
var promptText = 'ã‚ãªãŸã¯ç¾å®¹éƒ¨å“¡AIã§ã™ã€‚å›ç­”ã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯**å¤ªå­—**ã€ã‚«ãƒ†ã‚´ãƒªã‚„è¦‹å‡ºã—ã«ã¯##ã‚„###ã‚’ä½¿ã„ã€ãƒªã‚¹ãƒˆã¯-ã‚„æ•°å­—ã§æ•´ç†ã—ã¦ãã ã•ã„ã€‚\nã€ç™»éŒ²ã‚³ã‚¹ãƒ¡ã€‘: ' + cosmeListText + '\nã€è³ªå•ã€‘: ' + message;

try {
await waitForRateLimit();

var resp = await fetch(getApiUrl(), {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
contents: [{ role: "user", parts: [{ text: promptText }] }],
generationConfig: {
temperature: 0.8,
maxOutputTokens: 1024
}
})
});

if (!resp.ok) {
var errorData = await resp.json().catch(function() { return {}; });
var errorMsg = errorData.error ? errorData.error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
console.error('API Error:', errorData);

if(resp.status === 429) {
throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚1åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
}
if(resp.status === 404) {
throw new Error('ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã§åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
}
if(resp.status === 400) {
throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ã‚¨ãƒ©ãƒ¼: ' + errorMsg);
}
throw new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼(' + resp.status + '): ' + errorMsg);
}

var data = await resp.json();
console.log('API Response:', data);

if(data.error) {
throw new Error(data.error.message);
}

if(!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts) {
throw new Error('APIã‹ã‚‰ã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™');
}

var loadingEl = document.getElementById(loadingId);
if(loadingEl) loadingEl.remove();

var responseText = data.candidates[0].content.parts[0].text;
var aiMsgDiv = document.createElement('div');
aiMsgDiv.className = 'msg-ai';
aiMsgDiv.innerHTML = formatMessage(responseText, 'ai');
chatHistory.appendChild(aiMsgDiv);
chatHistory.scrollTop = chatHistory.scrollHeight;

addMessageToChat(currentChatId, 'ai', responseText);

} catch (e) {
console.error('Chat Error:', e);
var loadingEl = document.getElementById(loadingId);
if(loadingEl) loadingEl.remove();

var errorDiv = document.createElement('div');
errorDiv.className = 'msg-system';
errorDiv.textContent = 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + e.message;
chatHistory.appendChild(errorDiv);
chatHistory.scrollTop = chatHistory.scrollHeight;

addMessageToChat(currentChatId, 'system', 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + e.message);
} finally {
isRequesting = false;
inputEl.disabled = false;
sendBtn.disabled = false;
inputEl.focus();
}
}

function escapeHtml(text) {
var div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

function addItem() {
var item = {
name: document.getElementById('itemName').value.trim(),
brand: document.getElementById('brand').value.trim(),
category: document.getElementById('categorySelect').value,
ingredient: document.getElementById('ingredient').value.trim(),
description: document.getElementById('description').value.trim(),
releaseDate: document.getElementById('releaseDate').value,
price: document.getElementById('itemPrice').value,
openDate: document.getElementById('openDate').value,
tag: document.getElementById('timeTag').value,
id: Date.now()
};
if(!item.name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
cosmeData.unshift(item);
localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData));

document.getElementById('itemName').value = '';
document.getElementById('brand').value = '';
document.getElementById('categorySelect').value = '';
document.getElementById('ingredient').value = '';
document.getElementById('description').value = '';
document.getElementById('releaseDate').value = '';
document.getElementById('itemPrice').value = '';
document.getElementById('openDate').valueAsDate = new Date();

currentPage = 1;
render();
alert("ç™»éŒ²ã—ã¾ã—ãŸï¼âœ¨");
}

function checkExpiredItems() {
var today = new Date();
var expiringSoon = cosmeData.filter(function(item) {
if(!item.openDate) return false;
var openDate = new Date(item.openDate);
var monthsUsed = (today - openDate) / (1000 * 60 * 60 * 24 * 30);
return monthsUsed >= 5 && monthsUsed < 6;
});
}

function getDaysUsed(openDate) {
if(!openDate) return null;
var today = new Date();
var open = new Date(openDate);
return Math.floor((today - open) / (1000 * 60 * 60 * 24));
}

function sortData() {
var sortType = document.getElementById('sortSelect').value;
var sorted = cosmeData.slice();

if(sortType === 'newest') {
sorted.sort(function(a, b) { return b.id - a.id; });
} else if(sortType === 'category') {
sorted.sort(function(a, b) {
var catA = a.category || 'ãã®ä»–';
var catB = b.category || 'ãã®ä»–';
return catA.localeCompare(catB);
});
} else if(sortType === 'brand') {
sorted.sort(function(a, b) { return (a.brand || '').localeCompare(b.brand || ''); });
} else if(sortType === 'expiring') {
sorted.sort(function(a, b) {
var daysA = getDaysUsed(a.openDate) || -1;
var daysB = getDaysUsed(b.openDate) || -1;
return daysB - daysA;
});
}

return sorted;
}

function render() {
var sorted = sortData();
var sortType = document.getElementById('sortSelect').value;
var start = (currentPage - 1) * itemsPerPage;
var end = start + itemsPerPage;
var paginatedData = sorted.slice(start, end);

var area = document.getElementById('routineArea');
var html = '';

if(sortType === 'category') {
// ã‚«ãƒ†ã‚´ãƒªåˆ¥è¡¨ç¤º
var categories = {};
for(var i = 0; i < paginatedData.length; i++) {
var item = paginatedData[i];
var cat = item.category || 'ãã®ä»–';
if(!categories[cat]) categories[cat] = [];
categories[cat].push(item);
}

var categoryOrder = ['æ´—é¡”æ–™', 'åŒ–ç²§æ°´', 'ä¹³æ¶²', 'ç¾å®¹æ¶²', 'ã‚¯ãƒªãƒ¼ãƒ ', 'ãã®ä»–'];
for(var c = 0; c < categoryOrder.length; c++) {
var catName = categoryOrder[c];
if(!categories[catName]) continue;

html += '<div class="category-header">';
html += '<span>' + catName + '</span>';
html += '<span class="category-count">' + categories[catName].length + 'å€‹</span>';
html += '</div>';

for(var i = 0; i < categories[catName].length; i++) {
html += renderItemCard(categories[catName][i]);
}
}
} else {
// é€šå¸¸è¡¨ç¤º
for(var i = 0; i < paginatedData.length; i++) {
html += renderItemCard(paginatedData[i]);
}
}

area.innerHTML = html;
renderPagination(sorted.length);
}

function renderItemCard(item) {
var daysUsed = getDaysUsed(item.openDate);
var isExpiring = daysUsed && daysUsed >= 150 && daysUsed < 180;
var isExpired = daysUsed && daysUsed >= 180;

var warningHtml = '';
if(isExpired) {
warningHtml = '<div class="expire-warning">âš ï¸ ä½¿ç”¨é–‹å§‹ã‹ã‚‰6ãƒ¶æœˆçµŒéã—ã¦ã„ã¾ã™</div>';
} else if(isExpiring) {
warningHtml = '<div class="expire-warning" style="background:linear-gradient(135deg, #e3f2fd, #bbdefb); border-color:#90caf9; color:#1565c0;">ğŸ“… ä½¿ç”¨é–‹å§‹ã‹ã‚‰5ãƒ¶æœˆçµŒé</div>';
}

var html = '<details class="item-card-details">';
html += '<summary>' + (item.brand || '') + ' ' + item.name + ' [' + item.tag + ']</summary>';
html += '<div class="item-details-content">';
html += warningHtml;
html += '<p><b>ã‚«ãƒ†ã‚´ãƒª:</b> ' + (item.category || '-') + '</p>';
html += '<p><b>æˆåˆ†:</b> ' + (item.ingredient || '-') + '</p>';
html += '<p><b>èª¬æ˜:</b> ' + (item.description || '-') + '</p>';
html += '<p><b>ä¾¡æ ¼:</b> ' + (item.price ? item.price + 'å††' : '-') + ' / <b>ç™ºå£²æ—¥:</b> ' + (item.releaseDate || '-') + '</p>';
html += '<p><b>ä½¿ç”¨é–‹å§‹:</b> ' + (item.openDate || '-') + ' ' + (daysUsed ? '(' + daysUsed + 'æ—¥çµŒé)' : '') + '</p>';
html += '<button onclick="removeItem(' + item.id + ')" class="btn-danger" style="width:auto; padding:10px 15px; margin-top: 10px;"><span style="position: relative; z-index: 1;">ğŸ—‘ï¸ å‰Šé™¤</span></button>';
html += '</div>';
html += '</details>';

return html;
}

function renderPagination(totalItems) {
var totalPages = Math.ceil(totalItems / itemsPerPage);
var paginationArea = document.getElementById('paginationArea');

if(totalPages <= 1) {
paginationArea.innerHTML = '';
return;
}

var html = '';
if(currentPage > 1) {
html += '<button onclick="changePage(' + (currentPage - 1) + ')"><span style="position: relative; z-index: 1;">â—€ å‰ã¸</span></button>';
}
html += '<span>' + currentPage + ' / ' + totalPages + '</span>';
if(currentPage < totalPages) {
html += '<button onclick="changePage(' + (currentPage + 1) + ')"><span style="position: relative; z-index: 1;">æ¬¡ã¸ â–¶</span></button>';
}

paginationArea.innerHTML = html;
}

function changePage(page) {
currentPage = page;
render();
document.getElementById('routineArea').scrollIntoView({ behavior: 'smooth' });
}

function removeItem(id) {
if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
cosmeData = cosmeData.filter(function(i) { return i.id !== id; });
localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData));

var totalPages = Math.ceil(cosmeData.length / itemsPerPage);
if(currentPage > totalPages && currentPage > 1) {
currentPage = totalPages;
}

render();
}
}

function exportData() {
if(cosmeData.length === 0) {
alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
return;
}
var dataStr = JSON.stringify(cosmeData, null, 2);
var blob = new Blob([dataStr], {type: 'application/json'});
var url = URL.createObjectURL(blob);
var a = document.createElement('a');
a.href = url;
a.download = 'cosme-backup-' + new Date().toISOString().split('T')[0] + '.json';
a.click();
URL.revokeObjectURL(url);
alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
}

function importData() {
document.getElementById('importFile').click();
}

function handleImport(event) {
var file = event.target.files[0];
if(!file) return;

var reader = new FileReader();
reader.onload = function(e) {
try {
var importedData = JSON.parse(e.target.result);
if(!Array.isArray(importedData)) {
throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
}

if(confirm(importedData.length + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
cosmeData = importedData;
localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData));
currentPage = 1;
render();
switchTab('register');
alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
}
} catch(e) {
alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message);
}
};
reader.readAsText(file);
event.target.value = '';
}

function startProgress(t, p) {
document.getElementById('progressContainer').style.display='block';
document.getElementById('progressText').innerText=t;
updateProgress(p);
}
function updateProgress(p) {
document.getElementById('progressBar').style.width=p+'%';
}
function finishProgress() {
updateProgress(100);
setTimeout(function() {
document.getElementById('progressContainer').style.display='none';
}, 800);
}
function hideProgress() {
document.getElementById('progressContainer').style.display='none';
}
</script>

</body>
</html>
