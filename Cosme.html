<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cosme Genius Pro v10.0</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap');

:root {
  /* å‚è€ƒã‚µã‚¤ãƒˆã®ã‚ˆã†ãªã‚¦ã‚©ãƒ¼ãƒ ã‚°ãƒ¬ãƒ¼ã¨ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹æ„Ÿã®ãƒ‘ãƒ¬ãƒƒãƒˆ */
  --bg-color: #f2f2f0; /* æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ */
  --card-bg: #ffffff;
  --text-main: #333333; /* çœŸã£é»’ã§ã¯ãªãæ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
  --text-sub: #666666;
  --accent-color: #a89f91; /* ã‚°ãƒ¬ãƒ¼ã‚¸ãƒ¥/ãƒ–ãƒ­ãƒ³ã‚ºç³»ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
  --accent-dark: #5e5a55;
  --header-bg: #e6e5e3;
  --line-color: #e0e0e0;
  
  --font-serif: 'Cormorant Garamond', serif;
  --font-sans: 'Zen Kaku Gothic New', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-bottom: env(safe-area-inset-bottom);
  --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { overflow-x: hidden; -webkit-text-size-adjust: 100%; height: 100%; }
body {
  font-family: var(--font-sans);
  background-color: var(--bg-color);
  margin: 0; padding: 0;
  color: var(--text-main);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  width: 100%;
  overscroll-behavior-y: none;
  min-height: 100%;
  padding-bottom: var(--safe-bottom);
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
::-webkit-scrollbar { display: none; }

/* === Header Design (Rinnai-like) === */
.header-area {
  padding: 50px 20px 30px;
  background: linear-gradient(to bottom, #e6e5e3, #f2f2f0);
  position: relative;
  z-index: 10;
  text-align: center;
}
.brand-title {
  font-family: var(--font-serif);
  font-size: 2.2rem;
  font-weight: 500;
  letter-spacing: 0.05em;
  margin: 0;
  color: var(--text-main);
  text-transform: uppercase;
}
.brand-subtitle {
  font-family: var(--font-sans);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  color: var(--text-sub);
  margin-top: 8px;
  display: block;
  font-weight: 400;
}

/* === Navigation Tabs === */
.tabs-sticky-wrapper {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(242, 242, 240, 0.9); /* èƒŒæ™¯è‰²ã«åˆã‚ã›ãŸé€é */
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 15px;
  max-width: 600px;
  margin: 0 auto;
  padding: 0 10px;
}
.tab-btn {
  background: transparent;
  border: none;
  font-family: var(--font-sans);
  font-size: 0.85rem;
  color: #888;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  font-weight: 500;
}
.tab-btn.active {
  color: var(--text-main);
  font-weight: 600;
}
/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 20px;
  height: 2px;
  background-color: var(--accent-color);
}

/* === Main Container === */
.container {
  max-width: 600px;
  width: 100%;
  margin: 0 auto;
  padding: 20px 20px 100px;
}

/* === Animations === */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in {
  animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* === Cards & Typography === */
.section-title {
  font-family: var(--font-serif);
  font-size: 1.3rem;
  color: var(--text-main);
  margin: 40px 0 20px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--accent-color); /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã®ãƒ©ã‚¤ãƒ³ */
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}
.section-title span { letter-spacing: 0.05em; }

.card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 4px; /* è§’ä¸¸ã‚’å°‘ã—æŠ‘ãˆã¦ã‚·ãƒ£ãƒ¼ãƒ—ã« */
  box-shadow: var(--shadow-soft);
  margin-bottom: 20px;
}

/* Inputs */
.input-group { margin-bottom: 20px; }
label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; }

input, select, textarea {
  width: 100%;
  padding: 12px 10px;
  border: 1px solid #ddd;
  background: #fafafa;
  border-radius: 2px;
  font-family: var(--font-sans);
  font-size: 0.95rem;
  color: var(--text-main);
  transition: all 0.3s;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent-color);
  background: #fff;
}
input::placeholder, textarea::placeholder {
  color: #bbb;
}

/* Buttons */
button {
  width: 100%;
  padding: 15px;
  background: var(--text-main); /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
  color: #fff;
  border: none;
  font-family: var(--font-sans);
  font-weight: 500;
  font-size: 0.9rem;
  letter-spacing: 0.05em;
  cursor: pointer;
  transition: opacity 0.3s, transform 0.2s;
  border-radius: 2px;
  margin-top: 10px;
}
button:active { transform: scale(0.98); }

.btn-secondary {
  background: transparent !important;
  color: var(--text-main) !important;
  border: 1px solid #ccc !important;
}
.btn-accent {
  background: var(--accent-color) !important; /* ã‚°ãƒ¬ãƒ¼ã‚¸ãƒ¥ãƒœã‚¿ãƒ³ */
  color: #fff !important;
  border: none !important;
}
.btn-text {
  background: transparent !important;
  border: none !important;
  padding: 5px 10px !important;
  color: var(--accent-dark) !important;
  text-decoration: none;
  width: auto !important;
  margin: 0 !important;
  font-size: 0.8rem;
}
.btn-text:hover { opacity: 0.7; }

/* === List Items === */
.item-card-details {
  background: #fff;
  border: 1px solid rgba(0,0,0,0.05);
  margin-bottom: 8px;
  border-radius: 4px;
  transition: all 0.3s ease;
}
.item-card-details[open] {
  box-shadow: var(--shadow-soft);
  border-color: transparent;
  margin-bottom: 15px;
}
.item-card-details summary {
  padding: 18px 15px;
  cursor: pointer;
  list-style: none;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
}
.item-card-details summary::-webkit-details-marker { display: none; }

.item-summ-left { display: flex; align-items: center; gap: 12px; overflow: hidden; }
.item-brand { 
  font-size: 0.7rem; 
  background: #eee; 
  padding: 2px 6px; 
  border-radius: 2px; 
  color: #555;
  white-space: nowrap;
}
.item-name { 
  font-size: 1rem; 
  font-weight: 500; 
  color: var(--text-main);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
}
.item-badges { display: flex; gap: 5px; flex-shrink: 0; }

.badge {
  font-size: 0.65rem; padding: 2px 6px; 
  border-radius: 2px; font-weight: 500;
}
.badge.morning { background: #fff8e1; color: #f39c12; border: 1px solid #ffe0b2; }
.badge.night { background: #e8eaf6; color: #3f51b5; border: 1px solid #c5cae9; }
.badge.both { background: #f3e5f5; color: #9c27b0; border: 1px solid #e1bee7; }

.item-content {
  padding: 0 20px 20px;
  font-size: 0.9rem;
  color: var(--text-sub);
  border-top: 1px solid #f5f5f5;
  margin-top: 5px;
  padding-top: 15px;
}

/* === Cospa Style === */
.cospa-card {
  background: #fff;
  padding: 20px;
  margin-bottom: 15px;
  border-radius: 4px;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
  border: 1px solid #eee;
}
.cospa-header {
  display: flex; justify-content: space-between; align-items: baseline;
}
.cospa-price {
  font-family: var(--font-serif);
  font-size: 1.6rem;
  color: var(--text-main);
  font-weight: 600;
}
.cospa-unit { font-size: 0.8rem; color: #999; margin-left: 3px; }
.cospa-bar-bg {
  width: 100%; height: 4px; background: #eee; margin-top: 12px; position: relative; border-radius: 2px; overflow: hidden;
}
.cospa-bar-fill {
  height: 100%; 
  background: linear-gradient(90deg, var(--accent-color), var(--text-main)); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§é‡‘å±æ„Ÿ */
  position: absolute; left: 0; top: 0;
}
.cospa-meta {
  display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top: 8px;
}

/* === Chat Style === */
.chat-area {
  padding-bottom: 90px;
  display: flex; flex-direction: column; gap: 20px;
}
.msg-row { display: flex; width: 100%; }
.msg-row.user { justify-content: flex-end; }
.msg-row.ai { justify-content: flex-start; }

.msg-bubble {
  max-width: 85%;
  padding: 14px 18px;
  font-size: 0.95rem;
  line-height: 1.6;
  position: relative;
  border-radius: 12px;
}
.msg-row.user .msg-bubble {
  background: var(--text-main);
  color: #fff;
  border-bottom-right-radius: 2px;
}
.msg-row.ai .msg-bubble {
  background: #fff;
  color: var(--text-main);
  border: 1px solid #e0e0e0;
  border-bottom-left-radius: 2px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.chat-footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(242, 242, 240, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 15px calc(12px + var(--safe-bottom));
  border-top: 1px solid rgba(0,0,0,0.05);
  display: flex; gap: 10px; z-index: 200;
}
.chat-input {
  flex: 1; border: 1px solid #ccc; background: #fff;
  border-radius: 24px; padding: 10px 16px; font-size: 16px;
  height: 48px; margin: 0; transition: all 0.2s;
}
.chat-input:focus { border-color: var(--accent-color); }
.send-btn {
  width: 48px; height: 48px; border-radius: 50%; padding: 0; margin: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; background: var(--text-main);
}

/* === Utils === */
.tab-content { display: none; }
.tab-content.active { display: block; }
.flex-row { display: flex; gap: 10px; align-items: center; }
.text-center { text-align: center; }
.alert-box {
  background: #fff3e0; padding: 15px; font-size: 0.85rem; color: #e65100; border-radius: 4px; margin-bottom: 20px;
  border: 1px solid #ffe0b2;
}

/* File Upload */
.file-upload-label {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  border: 1px dashed #aaa; padding: 25px; 
  background: #fafafa; border-radius: 4px;
  margin-bottom: 15px; cursor: pointer; transition: 0.3s; color: #666;
}
.file-upload-label:hover { border-color: var(--text-main); background: #fff; }

/* Code Display in Settings */
.code-display {
  font-family: monospace;
  font-size: 0.75rem;
  color: #666;
  background: #eee;
  padding: 4px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

/* Progress */
.progress-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.9); z-index: 3000;
  display:none; flex-direction:column; align-items:center; justify-content:center;
}
.progress-spinner {
  width: 40px; height: 40px; border: 3px solid #eee; border-top-color: var(--accent-color);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px;
}
@keyframes spin { to {transform: rotate(360deg);} }

</style>
</head>
<body>

<!-- Header -->
<div class="header-area">
  <h1 class="brand-title">COSME GENIUS</h1>
  <span class="brand-subtitle">PRO EDITION v10.0</span>
</div>

<!-- Tabs -->
<div class="tabs-sticky-wrapper">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('register')" id="btn-register">ç™»éŒ²</button>
    <button class="tab-btn" onclick="switchTab('chat')" id="btn-chat">ç›¸è«‡</button>
    <button class="tab-btn" onclick="switchTab('cospa')" id="btn-cospa">ã‚³ã‚¹ãƒ‘</button>
    <button class="tab-btn" onclick="switchTab('settings')" id="btn-settings">è¨­å®š</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">

  <!-- ================= REGISTER TAB ================= -->
  <div id="tab-register" class="tab-content active fade-in">
    <div class="section-title">
      <span>ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²</span>
      <button class="btn-text" onclick="showPhotoSheet()">ğŸ“· å†™çœŸã§AIç™»éŒ²</button>
    </div>

    <!-- Scan Overlay -->
    <div id="photoSheet" style="display:none;position:fixed;inset:0;z-index:2500;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);" onclick="hidePhotoSheet()">
      <div style="position:absolute;bottom:0;left:0;right:0;background:var(--bg-color);padding:30px 20px;border-radius:20px 20px 0 0;" onclick="event.stopPropagation()">
        <p class="text-center" style="margin-bottom:20px;font-family:var(--font-serif);font-size:1.1rem;color:var(--text-main);">å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <label class="file-upload-label">
          <span style="font-size:1.5rem;margin-bottom:5px;">ğŸ“¸</span>
          <span>ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</span>
          <input type="file" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(event)">
        </label>
        <label class="file-upload-label">
          <span style="font-size:1.5rem;margin-bottom:5px;">ğŸ–¼ï¸</span>
          <span>ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸æŠ</span>
          <input type="file" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
        </label>
        <button onclick="hidePhotoSheet()" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <!-- Manual Input Form -->
    <div class="card">
      <div class="input-group flex-row">
        <input type="text" id="itemName" placeholder="å•†å“å (å¿…é ˆ)">
        <button onclick="triggerManualAISearch()" class="btn-accent" style="width:auto; padding:0 20px; font-size:0.8rem; margin:0;">AIè‡ªå‹•å…¥åŠ›</button>
      </div>
      <div class="input-group"><input type="text" id="brand" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰å"></div>
      <div class="input-group">
        <select id="categorySelect">
          <option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
          <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
          <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
          <option value="ä¹³æ¶²">ä¹³æ¶²</option>
          <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
          <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div class="input-group"><textarea id="description" rows="2" placeholder="èª¬æ˜ãƒ»ãƒ¡ãƒ¢"></textarea></div>
      <div class="input-group flex-row">
        <input type="text" id="releaseDate" placeholder="ç™ºå£²æ—¥">
        <input type="number" id="itemPrice" placeholder="ä¾¡æ ¼ (å††)">
      </div>
      <div class="input-group">
        <label>ä½¿ç”¨é–‹å§‹æ—¥</label>
        <input type="date" id="openDate">
      </div>
      <div class="input-group">
        <select id="timeTag">
          <option value="æœ">æœç”¨</option>
          <option value="æ™©">å¤œç”¨</option>
          <option value="æœæ™©">æœæ™©å…¼ç”¨</option>
        </select>
      </div>
      <button onclick="addItem()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <!-- List -->
    <div class="section-title" style="margin-top:50px;">
      <span>ç™»éŒ²ãƒªã‚¹ãƒˆ</span>
      <select id="sortSelect" onchange="render()" style="width:auto; border:none; background:transparent; font-size:0.8rem; text-align:right; color:var(--text-sub);">
        <option value="newest">æ–°ç€é †</option>
        <option value="time">æœãƒ»å¤œåˆ¥</option>
        <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
        <option value="brand">ãƒ–ãƒ©ãƒ³ãƒ‰é †</option>
      </select>
    </div>
    <div id="routineArea"></div>
  </div>

  <!-- ================= CHAT TAB ================= -->
  <div id="tab-chat" class="tab-content fade-in">
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:20px;">
      <button class="btn-text" onclick="createNewChat()">ï¼‹ æ–°è¦ãƒãƒ£ãƒƒãƒˆ</button>
      <button class="btn-text" onclick="toggleChatHistory()">å±¥æ­´ã‚’è¡¨ç¤º</button>
    </div>
    
    <div id="chatHistoryContainer" style="display:none; background:#fff; margin-bottom:20px; padding:10px; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.05);"></div>

    <div id="chatHistory" class="chat-area">
      <!-- Chat bubbles go here -->
    </div>

    <div class="chat-footer">
      <textarea id="chatInput" class="chat-input" placeholder="ã‚³ã‚¹ãƒ¡ã®ç›¸è«‡ã‚’å…¥åŠ›..." rows="1"></textarea>
      <button onclick="sendChatMessage()" class="send-btn">â¤</button>
    </div>
  </div>

  <!-- ================= COSPA TAB ================= -->
  <div id="tab-cospa" class="tab-content fade-in">
    <div class="section-title">
      <span>ã‚³ã‚¹ãƒ‘åˆ†æ</span>
    </div>

    <div id="cospaTopSummary" style="margin-bottom:30px; text-align:center;"></div>

    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
      <select id="cospaCategory" onchange="renderCospa()" style="font-size:0.85rem; width:48%;">
        <option value="all">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
        <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
        <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
        <option value="ä¹³æ¶²">ä¹³æ¶²</option>
        <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
        <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
      </select>
      <select id="cospaSort" onchange="renderCospa()" style="font-size:0.85rem; width:48%;">
        <option value="cost_asc">å®‰ã„é † (æ—¥å‰²ã‚Š)</option>
        <option value="cost_desc">é«˜ã„é † (æ—¥å‰²ã‚Š)</option>
        <option value="days_desc">é•·ãä½¿ã£ã¦ã„ã‚‹é †</option>
        <option value="days_asc">ä½¿ç”¨æœŸé–“ãŒçŸ­ã„é †</option>
      </select>
    </div>

    <div id="cospaList"></div>
  </div>

  <!-- ================= SETTINGS TAB ================= -->
  <div id="tab-settings" class="tab-content fade-in">
    <div class="section-title"><span>è¨­å®š</span></div>
    
    <div class="alert-box">
      APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
    </div>
    
    <div class="card">
      <div class="input-group">
        <label>Gemini API ã‚­ãƒ¼</label>
        <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
      </div>

      <div class="input-group" style="margin-top:30px;">
        <label>ãƒãƒ£ãƒƒãƒˆç”¨ãƒ¢ãƒ‡ãƒ« (é«˜ç²¾åº¦)</label>
        <select id="chatModelSelect" onchange="updateModelCodeDisplay()">
          <option value="gemini-3-flash-preview">Gemini 3 Flash (æ¨å¥¨)</option>
          <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
          <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
        <div class="code-display">Model Code: <span id="chatModelCodeDisplay"></span></div>
      </div>

      <div class="input-group">
        <label>æ¤œç´¢ãƒ»ç™»éŒ²ç”¨ãƒ¢ãƒ‡ãƒ« (é«˜é€Ÿ)</label>
        <select id="fastModelSelect" onchange="updateModelCodeDisplay()">
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (æ¨å¥¨ãƒ»æœ€é€Ÿ)</option>
          <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
        <div class="code-display">Model Code: <span id="fastModelCodeDisplay"></span></div>
      </div>

      <button onclick="saveSettings()" class="btn-accent">è¨­å®šã‚’ä¿å­˜</button>
      <button onclick="clearApiKey()" class="btn-secondary" style="margin-top:20px; color:#c62828!important; border-color:#ef9a9a!important;">APIã‚­ãƒ¼ã‚’å‰Šé™¤</button>
    </div>

    <div class="section-title" style="margin-top:50px;"><span>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span></div>
    <div class="card">
      <button onclick="exportData()" class="btn-secondary">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (JSON)</button>
      <button onclick="importData()" class="btn-secondary">ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ (JSON)</button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
    </div>
  </div>

</div>

<!-- Progress Overlay -->
<div id="progressOverlay" class="progress-overlay">
  <div class="progress-spinner"></div>
  <div id="progressText" style="font-family:var(--font-serif); font-size:1.1rem; color:#555;">å‡¦ç†ä¸­...</div>
</div>

<canvas id="compressionCanvas" style="display:none;"></canvas>

<script>
/* ================= LOGIC START ================= */
let cosmeData = JSON.parse(localStorage.getItem('cosmeData_v8')) || [];
let chatHistories = JSON.parse(localStorage.getItem('chatHistories_v1')) || [];
let currentChatId = null;
let isRequesting = false;
let lastRequestTime = 0;

const DEFAULT_CHAT_MODEL = 'gemini-3-flash-preview';
const DEFAULT_FAST_MODEL = 'gemini-2.5-flash-lite';

/* Initialization */
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('openDate').valueAsDate = new Date();
  document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey_v1') || '';
  
  loadModelSettings();

  if(chatHistories.length > 0) {
    currentChatId = chatHistories[0].id;
    loadChat(currentChatId);
  } else {
    createNewChat();
  }
  
  render();
  renderCospa();

  // Chat Enter Key
  document.getElementById('chatInput').addEventListener('keydown', function(e) {
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
  });
});

/* Tabs */
function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  document.getElementById('btn-' + tabId).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  if(tabId === 'cospa') renderCospa();
  if(tabId === 'chat') setTimeout(scrollToBottom, 100);
}

function scrollToBottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

/* API Utils */
function validateApiKey() {
  var k = localStorage.getItem('geminiApiKey_v1');
  if(!k || k.length < 10) { alert('è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'); switchTab('settings'); return false; }
  return true;
}
function getApiUrl(isFast) {
  var model = isFast ? document.getElementById('fastModelSelect').value : document.getElementById('chatModelSelect').value;
  return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${localStorage.getItem('geminiApiKey_v1')}`;
}
async function waitForRateLimit() {
  var now = Date.now();
  if (now - lastRequestTime < 2000) await new Promise(r => setTimeout(r, 2000 - (now - lastRequestTime)));
  lastRequestTime = Date.now();
}
function showProgress(txt) {
  document.getElementById('progressOverlay').style.display = 'flex';
  document.getElementById('progressText').textContent = txt;
}
function hideProgress() { document.getElementById('progressOverlay').style.display = 'none'; }

/* Model Settings & Display Code */
function loadModelSettings() {
  var cm = localStorage.getItem('chatModel_v1');
  var fm = localStorage.getItem('fastModel_v1');
  if(!cm) cm = DEFAULT_CHAT_MODEL;
  if(!fm) fm = DEFAULT_FAST_MODEL;
  document.getElementById('chatModelSelect').value = cm;
  document.getElementById('fastModelSelect').value = fm;
  updateModelCodeDisplay();
}
function updateModelCodeDisplay() {
  document.getElementById('chatModelCodeDisplay').textContent = document.getElementById('chatModelSelect').value;
  document.getElementById('fastModelCodeDisplay').textContent = document.getElementById('fastModelSelect').value;
}

/* AI Helper */
function parseAIJson(text) {
  try { return JSON.parse(text); } catch(e) {}
  var clean = text.replace(/```json\s*|\s*```/g, '').trim();
  try { return JSON.parse(clean); } catch(e) {}
  var m = clean.match(/\{[\s\S]*\}/);
  if(m) return JSON.parse(m[0]);
  throw new Error("JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ");
}

/* Image Handling */
async function handleImageSelect(e) {
  if(!validateApiKey() || isRequesting) return;
  var file = e.target.files[0];
  if(!file) return;
  hidePhotoSheet();
  isRequesting = true; showProgress("ç”»åƒã‚’è§£æä¸­...");

  try {
    var base64 = (await compressImage(file)).split(',')[1];
    await waitForRateLimit();
    
    // Step 1: Identify
    var p1 = 'ã“ã®ç”»åƒã®åŒ–ç²§å“ã®ãƒ–ãƒ©ãƒ³ãƒ‰åã¨å•†å“åã‚’ç‰¹å®šã—ã€JSONã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„: {"itemName":"","brandName":""}';
    var r1 = await fetch(getApiUrl(true), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: p1 }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    var d1 = await r1.json();
    var j1 = parseAIJson(d1.candidates[0].content.parts[0].text);
    
    if(j1.itemName) document.getElementById('itemName').value = j1.itemName;
    if(j1.brandName) document.getElementById('brand').value = j1.brandName;

    // Step 2: Details
    if(j1.itemName) {
      document.getElementById('progressText').textContent = "è©³ç´°æƒ…å ±ã‚’å–å¾—ä¸­...";
      await waitForRateLimit();
      var p2 = `åŒ–ç²§å“ã€Œ${j1.brandName} ${j1.itemName}ã€ã®è©³ç´°æƒ…å ±ã‚’JSONã§å‡ºåŠ›ã—ã¦ãã ã•ã„: {"category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–","ingredients":"","description":"","price":0,"releaseDate":""}`;
      var r2 = await fetch(getApiUrl(true), {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: p2 }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      var d2 = await r2.json();
      var j2 = parseAIJson(d2.candidates[0].content.parts[0].text);
      if(j2.category) document.getElementById('categorySelect').value = j2.category;
      if(j2.description) document.getElementById('description').value = j2.description;
      if(j2.price) document.getElementById('itemPrice').value = j2.price;
    }
  } catch(e) {
    alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
  } finally {
    isRequesting = false; hideProgress(); e.target.value = '';
  }
}
function compressImage(file) {
  return new Promise(r => {
    var fr = new FileReader();
    fr.onload = e => {
      var img = new Image();
      img.onload = () => {
        var c = document.getElementById('compressionCanvas');
        var scale = Math.min(1000/img.width, 1);
        c.width = img.width * scale; c.height = img.height * scale;
        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
        r(c.toDataURL('image/jpeg', 0.8));
      };
      img.src = e.target.result;
    };
    fr.readAsDataURL(file);
  });
}

/* Manual AI Search */
async function triggerManualAISearch() {
  if(!validateApiKey() || isRequesting) return;
  var name = document.getElementById('itemName').value;
  if(!name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  isRequesting = true; showProgress("æ¤œç´¢ä¸­...");
  try {
    await waitForRateLimit();
    var p = `åŒ–ç²§å“ã€Œ${name}ã€ã®è©³ç´°æƒ…å ±ã‚’æ¤œç´¢ã—JSONã§å‡ºåŠ›: {"brand":"","category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–","description":"","price":0,"releaseDate":""}`;
    var res = await fetch(getApiUrl(true), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: p }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    var d = await res.json();
    var j = parseAIJson(d.candidates[0].content.parts[0].text);
    if(j.brand) document.getElementById('brand').value = j.brand;
    if(j.category) document.getElementById('categorySelect').value = j.category;
    if(j.description) document.getElementById('description').value = j.description;
    if(j.price) document.getElementById('itemPrice').value = j.price;
    if(j.releaseDate) document.getElementById('releaseDate').value = j.releaseDate;
  } catch(e) { alert(e.message); }
  finally { isRequesting = false; hideProgress(); }
}

/* Data Management */
function addItem() {
  var item = {
    id: Date.now(),
    name: document.getElementById('itemName').value,
    brand: document.getElementById('brand').value,
    category: document.getElementById('categorySelect').value,
    description: document.getElementById('description').value,
    releaseDate: document.getElementById('releaseDate').value,
    price: document.getElementById('itemPrice').value,
    openDate: document.getElementById('openDate').value,
    tag: document.getElementById('timeTag').value
  };
  if(!item.name) return alert('å•†å“åã¯å¿…é ˆã§ã™');
  cosmeData.unshift(item);
  saveData(); render(); renderCospa();
  document.getElementById('itemName').value = '';
  alert('ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
}
function saveData() { localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData)); }
function removeItem(id) {
  if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    cosmeData = cosmeData.filter(i => i.id !== id);
    saveData(); render(); renderCospa();
  }
}
function markFinished(id) {
  var i = cosmeData.find(x => x.id === id);
  if(i) {
    i.finishDate = i.finishDate ? null : new Date().toISOString().split('T')[0];
    saveData(); render(); renderCospa();
  }
}
function saveEdit(id, key, val) {
  var i = cosmeData.find(x => x.id === id);
  if(i) { i[key] = val; saveData(); renderCospa(); }
}

/* Rendering */
function render() {
  var type = document.getElementById('sortSelect').value;
  var d = [...cosmeData];
  if (type === 'time') d.sort((a,b) => (a.tag||'').localeCompare(b.tag||''));
  else if (type === 'category') d.sort((a,b) => (a.category||'').localeCompare(b.category||''));
  else if (type === 'brand') d.sort((a,b) => (a.brand||'').localeCompare(b.brand||''));
  
  var html = '';
  d.forEach(item => {
    var badgeClass = item.tag === 'æœ' ? 'morning' : (item.tag === 'æ™©' ? 'night' : 'both');
    var badgeLabel = item.tag === 'æœ' ? 'æœ' : (item.tag === 'æ™©' ? 'å¤œ' : 'æœå¤œ');
    
    html += `
    <details class="item-card-details">
      <summary>
        <div class="item-summ-left">
          <span class="item-brand">${escapeHtml(item.brand)}</span>
          <span class="item-name" style="${item.finishDate?'text-decoration:line-through;opacity:0.5':''}">${escapeHtml(item.name)}</span>
        </div>
        <div class="item-badges">
           ${item.finishDate ? '<span>âœ…</span>' : ''}
           <span class="badge ${badgeClass}">${badgeLabel}</span>
        </div>
      </summary>
      <div class="item-content">
        <p style="margin:5px 0;">${escapeHtml(item.description || 'èª¬æ˜ãªã—')}</p>
        <div class="flex-row" style="margin-top:15px;">
           <input type="number" value="${item.price}" placeholder="ä¾¡æ ¼" onchange="saveEdit(${item.id},'price',this.value)" style="font-size:0.9rem;">
           <input type="date" value="${item.openDate}" onchange="saveEdit(${item.id},'openDate',this.value)" style="font-size:0.9rem;">
        </div>
        <div class="flex-row" style="margin-top:10px;">
          <button class="btn-secondary" onclick="markFinished(${item.id})">${item.finishDate?'ä½¿ã„åˆ‡ã‚Šè§£é™¤':'ä½¿ã„åˆ‡ã‚Šã«ã™ã‚‹'}</button>
          <button class="btn-secondary" onclick="removeItem(${item.id})" style="color:red!important;border-color:#ffcccc!important;">å‰Šé™¤</button>
        </div>
      </div>
    </details>`;
  });
  document.getElementById('routineArea').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:50px;">ç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}

/* Cospa Logic */
function renderCospa() {
  var cat = document.getElementById('cospaCategory').value;
  var sort = document.getElementById('cospaSort').value;
  
  var list = cosmeData.filter(i => (cat==='all'||i.category===cat) && i.price && i.openDate);
  
  list.sort((a,b) => {
    var da = getDaily(a), db = getDaily(b);
    var daysA = getDays(a), daysB = getDays(b);
    
    if(sort === 'cost_asc') return da - db;
    if(sort === 'cost_desc') return db - da;
    if(sort === 'days_desc') return daysB - daysA;
    if(sort === 'days_asc') return daysA - daysB;
    return 0;
  });

  var html = '';
  var totalDaily = 0;
  
  list.forEach(item => {
    var days = getDays(item);
    var daily = Math.round(getDaily(item));
    totalDaily += daily;
    var barWidth = Math.min(100, (daily / 150) * 100);
    
    html += `
    <div class="cospa-card">
      <div class="cospa-header">
        <div>
          <div style="font-size:0.75rem;color:#888;">${escapeHtml(item.brand)}</div>
          <div style="font-weight:500;">${escapeHtml(item.name)}</div>
        </div>
        <div>
          <span class="cospa-price">Â¥${daily}</span><span class="cospa-unit">/æ—¥</span>
        </div>
      </div>
      <div class="cospa-bar-bg"><div class="cospa-bar-fill" style="width:${barWidth}%"></div></div>
      <div class="cospa-meta">
        <span>è³¼å…¥é¡: Â¥${item.price}</span>
        <span>ä½¿ç”¨æœŸé–“: ${days}æ—¥ ${item.finishDate?'(å®Œ)':''}</span>
      </div>
    </div>`;
  });

  document.getElementById('cospaList').innerHTML = html || '<div class="text-center" style="margin-top:40px;color:#ccc;">è¨ˆç®—å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  
  if(list.length > 0) {
    document.getElementById('cospaTopSummary').innerHTML = `
      <div style="font-size:0.9rem; color:#888; font-family:var(--font-serif); font-style:italic;">1æ—¥ã‚ãŸã‚Šã®åˆè¨ˆã‚³ã‚¹ãƒˆ</div>
      <div style="font-size:3rem; line-height:1; font-family:var(--font-serif); color:var(--text-main);">Â¥${Math.round(totalDaily)}</div>
    `;
  } else {
    document.getElementById('cospaTopSummary').innerHTML = '';
  }
}

function getDays(i) {
  var start = new Date(i.openDate);
  var end = i.finishDate ? new Date(i.finishDate) : new Date();
  var diff = Math.floor((end - start) / 86400000);
  return Math.max(1, diff);
}
function getDaily(i) { return i.price / getDays(i); }

/* Chat Logic */
function createNewChat() {
  var id = 'chat_' + Date.now();
  chatHistories.unshift({ id: id, title: 'æ–°è¦ãƒãƒ£ãƒƒãƒˆ', date: new Date().toISOString(), messages: [{ type: 'ai', text: 'ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã‚³ã‚¹ãƒ¡ã«åŸºã¥ã„ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¾ã™ã€‚ä½•ã§ã‚‚èã„ã¦ãã ã•ã„âœ¨' }] });
  saveChatHistories(); loadChat(id);
}
function loadChat(id) {
  currentChatId = id;
  var chat = chatHistories.find(c => c.id === id);
  var area = document.getElementById('chatHistory');
  area.innerHTML = '';
  chat.messages.forEach(m => appendMsg(m.type, m.text));
  renderChatList();
}
function appendMsg(type, text) {
  var div = document.createElement('div');
  div.className = `msg-row ${type}`;
  var bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
  div.appendChild(bubble);
  document.getElementById('chatHistory').appendChild(div);
}
async function sendChatMessage() {
  if(!validateApiKey() || isRequesting) return;
  var txt = document.getElementById('chatInput').value.trim();
  if(!txt) return;
  
  document.getElementById('chatInput').value = '';
  isRequesting = true;
  appendMsg('user', txt);
  scrollToBottom();

  var chat = chatHistories.find(c => c.id === currentChatId);
  chat.messages.push({ type: 'user', text: txt });
  if(chat.messages.length === 2) chat.title = txt.substring(0, 20);
  saveChatHistories();

  try {
    await waitForRateLimit();
    var context = JSON.stringify(cosmeData.map(c => ({n:c.name, b:c.brand, c:c.category})));
    var prompt = `å½¹å‰²:ç¾å®¹éƒ¨å“¡ã€‚æ–‡è„ˆ:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€æŒã‚³ã‚¹ãƒ¡=${context}ã€‚è³ªå•:${txt}`;
    
    var res = await fetch(getApiUrl(false), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    var d = await res.json();
    var ans = d.candidates[0].content.parts[0].text;
    
    appendMsg('ai', ans);
    chat.messages.push({ type: 'ai', text: ans });
    saveChatHistories();
  } catch(e) {
    appendMsg('ai', "ã‚¨ãƒ©ãƒ¼: " + e.message);
  } finally {
    isRequesting = false;
    scrollToBottom();
  }
}
function saveChatHistories() { localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories)); }
function renderChatList() {
  var h = '';
  chatHistories.forEach(c => {
    h += `<div onclick="loadChat('${c.id}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; background:${c.id===currentChatId?'#f9f9f9':'#fff'}">
      <div style="font-weight:600; font-size:0.9rem; color:var(--text-main);">${escapeHtml(c.title)}</div>
      <div style="font-size:0.75rem; color:#999;">${new Date(c.date).toLocaleDateString()}</div>
    </div>`;
  });
  document.getElementById('chatHistoryContainer').innerHTML = h;
}
function toggleChatHistory() {
  var el = document.getElementById('chatHistoryContainer');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
  renderChatList();
}

/* Settings Utils */
function saveSettings() {
  localStorage.setItem('geminiApiKey_v1', document.getElementById('geminiApiKey').value.trim());
  localStorage.setItem('chatModel_v1', document.getElementById('chatModelSelect').value);
  localStorage.setItem('fastModel_v1', document.getElementById('fastModelSelect').value);
  alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function clearApiKey() { localStorage.removeItem('geminiApiKey_v1'); alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); }
function exportData() {
  var b = new Blob([JSON.stringify({data:cosmeData, chats:chatHistories})], {type:'application/json'});
  var a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='cosme_backup.json'; a.click();
}
function importData(){ document.getElementById('importFile').click(); }
function handleImport(e){
  var r=new FileReader(); r.onload=function(ev){
    try{ var d=JSON.parse(ev.target.result); cosmeData=d.data||[]; chatHistories=d.chats||[]; saveData(); saveChatHistories(); render(); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(x){alert('ã‚¨ãƒ©ãƒ¼');}
  }; r.readAsText(e.target.files[0]);
}

function escapeHtml(text) {
  if(text == null) return '';
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
</script>
</body>
</html>
