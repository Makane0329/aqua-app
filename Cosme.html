<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cosme Genius Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap');

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { overflow-x: hidden; overscroll-behavior: none; -webkit-text-size-adjust: 100%; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Hiragino Sans', 'Yu Gothic', sans-serif;
  background: #fafafa; margin: 0; padding: 0; padding-bottom: 30px;
  color: #1a1a1a; line-height: 1.6; -webkit-font-smoothing: antialiased;
  overflow-x: hidden; width: 100%; position: relative;
  overscroll-behavior-x: none; touch-action: pan-y;
}
.container { max-width: 500px; width: 100%; margin: 0 auto; padding: 0 20px 30px; overflow-x: hidden; max-width: min(500px, 100vw); }

.header {
  background: linear-gradient(135deg, #000000 0%, #2c2c2c 100%);
  color: white; padding: 25px 20px; text-align: center;
  font-family: 'Cormorant Garamond', serif; letter-spacing: 4px;
  font-weight: 300; font-size: 1.4rem; margin: 0 -20px 30px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative; overflow: hidden;
  animation: headerSlideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}
.header::before {
  content: ''; position: absolute; top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: headerGlow 8s ease-in-out infinite;
}
@keyframes headerSlideDown { from { opacity:0; transform:translateY(-30px); } to { opacity:1; transform:translateY(0); } }
@keyframes headerGlow { 0%,100%{transform:translate(0,0);} 50%{transform:translate(30px,30px);} }

.tabs {
  display: flex; margin-bottom: 30px; background: #ffffff;
  border-radius: 12px; overflow: hidden;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
  animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) 0.1s both;
}
.tab-btn {
  flex: 1; background: transparent; color: #666; border: none;
  border-right: 1px solid #f0f0f0; padding: 14px 4px;
  cursor: pointer; font-weight: 500; font-size: 11px;
  transition: all 0.4s cubic-bezier(0.16,1,0.3,1); letter-spacing: 0.3px; position: relative;
}
.tab-btn:last-child { border-right: none; }
.tab-btn::before {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
  background: #000; transform: scaleX(0); transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
}
.tab-btn.active::before { transform: scaleX(1); }
.tab-btn:active { transform: scale(0.95); }
.tab-btn.active { background: linear-gradient(to bottom, #fafafa 0%, #fff 100%); color: #000; font-weight: 600; }

.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1); }
@keyframes fadeInUp { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

.card {
  background: #fff; padding: 30px; margin-bottom: 25px;
  border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);
  transition: all 0.4s cubic-bezier(0.16,1,0.3,1);
  animation: cardAppear 0.6s cubic-bezier(0.16,1,0.3,1) both;
}
.card:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.12); transform: translateY(-2px); }
@keyframes cardAppear { from{opacity:0;transform:translateY(30px) scale(0.95);} to{opacity:1;transform:translateY(0) scale(1);} }
.card:nth-child(2){animation-delay:0.1s;} .card:nth-child(3){animation-delay:0.2s;}

h2 {
  font-size: 0.85rem; font-family: 'Cormorant Garamond', serif;
  color: #1a1a1a; letter-spacing: 2px; text-transform: uppercase;
  font-weight: 600; margin: 0 0 25px 0; padding-bottom: 15px;
  border-bottom: 2px solid #000; position: relative;
}
h2::after {
  content: ''; position: absolute; bottom: -2px; left: 0;
  width: 50px; height: 2px; background: #c9a97e;
  animation: borderExpand 1s cubic-bezier(0.16,1,0.3,1);
}
@keyframes borderExpand { from{width:0;} to{width:50px;} }

input, select, button, textarea {
  width: 100%; padding: 14px 18px; margin-top: 12px;
  border: 2px solid #e5e5e5; box-sizing: border-box; font-size: 16px;
  font-family: inherit; background: white; border-radius: 10px;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
}
input:focus, select:focus, textarea:focus {
  outline: none; border-color: #000; box-shadow: 0 0 0 4px rgba(0,0,0,0.05); transform: translateY(-1px);
}
button {
  background: linear-gradient(135deg, #000 0%, #2c2c2c 100%);
  color: white; border: none; font-weight: 600; cursor: pointer;
  letter-spacing: 1px; text-transform: uppercase; font-size: 13px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; overflow: hidden;
}
button::before {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 0; height: 0; border-radius: 50%;
  background: rgba(255,255,255,0.2); transform: translate(-50%,-50%);
  transition: width 0.6s, height 0.6s;
}
button:hover::before { width: 300px; height: 300px; }
button:hover { box-shadow: 0 6px 25px rgba(0,0,0,0.3); transform: translateY(-2px); }
button:active { transform: translateY(0); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; box-shadow: none; }
textarea { resize: none; min-height: 90px; }

.progress-container {
  background: linear-gradient(to bottom, #fafafa, #fff); margin-bottom: 20px; display: none;
  padding: 20px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); animation: fadeInUp 0.3s ease;
}
.progress-bar-bg { width:100%; background:#e0e0e0; height:6px; overflow:hidden; margin-top:12px; border-radius:10px; }
.progress-bar-fill {
  height: 100%; width: 0%; background: linear-gradient(90deg, #000, #c9a97e);
  transition: width 0.6s cubic-bezier(0.16,1,0.3,1); border-radius: 10px; position: relative; overflow: hidden;
}
.progress-bar-fill::after {
  content: ''; position: absolute; top:0; left:0; bottom:0; right:0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 1.5s infinite;
}
@keyframes shimmer { 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }

/* ===== ãƒãƒ£ãƒƒãƒˆ: æ¨ªå¹…ãƒ»ç¸¦å¹…æ‹¡å¤§ ===== */
.chat-area {
  /* ç¸¦å¹…ã‚’æ‹¡å¤§: 420px â†’ 560px */
  height: 560px;
  overflow-y: auto; -webkit-overflow-scrolling: touch;
  background: linear-gradient(to bottom, #f9f9f9, #fff); padding: 20px;
  border-radius: 12px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
  display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px;
}
/* ãƒãƒ£ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®paddingå‰Šæ¸›ã§æ¨ªå¹…ç¢ºä¿ */
.chat-card {
  padding: 16px !important;
}

.msg-user {
  align-self: flex-end;
  background: linear-gradient(135deg, #000 0%, #2c2c2c 100%);
  color: white; padding: 12px 16px; border-radius: 18px 18px 4px 18px;
  /* æ¨ªå¹…ã‚’æ‹¡å¤§: 80% â†’ 92% */
  max-width: 92%;
  font-size: 15px; word-wrap: break-word; line-height: 1.6;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15); animation: messageSlideIn 0.3s cubic-bezier(0.16,1,0.3,1);
}
.msg-ai {
  align-self: flex-start;
  background: white; border: 2px solid #f0f0f0;
  color: #1a1a1a; padding: 14px 16px; border-radius: 18px 18px 18px 4px;
  /* æ¨ªå¹…ã‚’æ‹¡å¤§: 85% â†’ 95% */
  max-width: 95%;
  font-size: 15px; line-height: 1.75; word-wrap: break-word;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08); animation: messageSlideIn 0.3s cubic-bezier(0.16,1,0.3,1);
}
.msg-ai strong,.msg-ai b{color:#000;font-weight:700;}
.msg-ai h3{font-size:16px;font-weight:700;color:#000;margin:12px 0 8px;border-bottom:2px solid #c9a97e;padding-bottom:6px;}
.msg-ai h4{font-size:15px;font-weight:600;color:#2c2c2c;margin:10px 0 6px;}
.msg-ai em,.msg-ai i{color:#c9a97e;font-style:italic;}
.msg-ai code{background:#f5f5f5;border:1px solid #e0e0e0;padding:2px 6px;border-radius:4px;font-size:14px;color:#d32f2f;}
.msg-ai ul,.msg-ai ol{margin:8px 0;padding-left:20px;}
.msg-ai li{margin:6px 0;line-height:1.6;}
.msg-ai blockquote{border-left:4px solid #c9a97e;padding-left:16px;margin:12px 0;color:#666;font-style:italic;}
@keyframes messageSlideIn { from{opacity:0;transform:scale(0.8) translateY(10px);} to{opacity:1;transform:scale(1) translateY(0);} }
.msg-system {
  color: #c62828; background: linear-gradient(135deg, #ffebee, #fff5f5);
  padding: 14px; border-radius: 12px; border: 2px solid #ef9a9a; font-size: 13px;
}
.chat-input-bar { display:flex; gap:12px; }
.chat-textarea { flex-grow:1; height:50px; resize:none; padding:14px 18px; }
.send-btn { width:50px; height:50px; padding:0; font-size:18px; flex-shrink:0; border-radius:12px; }
.chat-controls { display:flex; gap:12px; margin-bottom:15px; }
.chat-controls button { margin-top:0; padding:12px 18px; font-size:12px; }
.chat-history-list { margin-bottom:20px; max-height:300px; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.chat-history-item {
  background:white; border:2px solid #f0f0f0; padding:14px 18px; margin-bottom:10px;
  cursor:pointer; display:flex; justify-content:space-between; align-items:center;
  border-radius:12px; transition:all 0.3s cubic-bezier(0.16,1,0.3,1); animation:fadeInUp 0.3s ease both;
}
.chat-history-item:hover{background:#fafafa;border-color:#000;transform:translateX(4px);box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.chat-history-item.active{background:linear-gradient(135deg,#000 0%,#2c2c2c 100%);color:white;border-color:#000;box-shadow:0 4px 20px rgba(0,0,0,0.2);}
.chat-history-info{flex:1;}
.chat-history-title{font-size:13px;font-weight:600;margin-bottom:3px;}
.chat-history-date{font-size:11px;opacity:0.7;}
.chat-history-delete{width:auto;padding:8px 14px;font-size:11px;margin:0;background:#d32f2f;box-shadow:0 2px 8px rgba(211,47,47,0.3);}
.chat-history-item.active .chat-history-delete{background:white;color:#000;}

/* Item Cards */
.item-card-details {
  border: 2px solid #f0f0f0; margin-top: 15px; background: white;
  overflow: hidden; border-radius: 12px; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  animation: fadeInUp 0.4s ease both;
}
.item-card-details:hover{box-shadow:0 4px 20px rgba(0,0,0,0.08);border-color:#000;}
.item-card-details[open]{box-shadow:0 6px 25px rgba(0,0,0,0.12);}
.item-card-details summary {
  padding: 20px; cursor: pointer; list-style: none; font-weight: 600;
  user-select: none; font-size: 14px; letter-spacing: 0.3px;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1); position: relative;
}
.item-card-details summary::after {
  content:'â–¼'; position:absolute; right:20px; top:50%;
  transform:translateY(-50%) rotate(0deg); transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);
  font-size:12px; opacity:0.6;
}
.item-card-details[open] summary::after{transform:translateY(-50%) rotate(180deg);}
.item-card-details summary:hover{background:linear-gradient(to right,#fafafa,#fff);}
.item-card-details summary::-webkit-details-marker{display:none;}
.item-details-content {
  padding: 25px; font-size: 13px; border-top: 2px solid #f5f5f5;
  background: linear-gradient(to bottom, #fafafa, #fff); line-height: 1.8;
  animation: expandDown 0.4s cubic-bezier(0.16,1,0.3,1);
}
@keyframes expandDown{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}
.item-details-content p{margin:10px 0;color:#1a1a1a;}
.item-details-content b{color:#1a1a1a;font-weight:600;letter-spacing:0.5px;}

.item-action-btns { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
.item-action-btns button { width: auto; padding: 10px 15px; margin-top: 0; font-size: 12px; }

/* ===== ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ===== */
.edit-field-row {
  display: flex; align-items: center; gap: 8px; margin: 8px 0;
}
.edit-field-row b { flex-shrink: 0; min-width: 90px; color: #1a1a1a; font-weight: 600; }
.edit-inline {
  flex: 1; padding: 7px 12px; border: 2px solid #e5e5e5; border-radius: 8px;
  font-size: 13px; font-family: inherit; background: #fafafa;
  transition: all 0.2s; margin: 0; width: auto;
}
.edit-inline:focus { outline: none; border-color: #c9a97e; background: white; box-shadow: 0 0 0 3px rgba(201,169,126,0.15); transform: none; }
.edit-save-btn {
  width: auto; padding: 7px 14px; margin: 0; font-size: 11px;
  background: linear-gradient(135deg, #c9a97e 0%, #b8976d 100%) !important;
  border-radius: 8px; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(201,169,126,0.3);
}

/* Category Headers */
.category-header {
  background: linear-gradient(135deg, #000 0%, #2c2c2c 100%); color: white;
  padding: 18px 25px; margin-top: 25px; margin-bottom: 15px;
  font-family: 'Cormorant Garamond', serif; font-size: 14px;
  letter-spacing: 2px; font-weight: 600; display: flex; justify-content: space-between;
  align-items: center; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  animation: fadeInUp 0.4s ease both;
}
.category-header:first-child{margin-top:0;}
.category-count{font-size:11px;background:rgba(255,255,255,0.2);padding:6px 12px;letter-spacing:1px;border-radius:20px;}

.pagination{display:flex;justify-content:center;align-items:center;gap:15px;margin-top:25px;}
.pagination button{width:auto;padding:12px 22px;font-size:12px;margin-top:0;}
.pagination span{padding:12px 22px;background:white;border:2px solid #f0f0f0;font-size:13px;letter-spacing:0.5px;border-radius:10px;font-weight:600;}

.sort-controls{display:flex;gap:12px;margin-bottom:20px;}
.sort-controls select{margin-top:0;}

.alert-box{background:linear-gradient(135deg,#fff8e1,#ffecb3);border:2px solid #ffd54f;padding:18px;margin-bottom:20px;font-size:13px;color:#f57f17;line-height:1.6;border-radius:12px;box-shadow:0 2px 15px rgba(245,127,23,0.15);}
.alert-box b{display:block;margin-bottom:8px;font-weight:600;}

.btn-secondary{background:linear-gradient(135deg,#c9a97e 0%,#b8976d 100%)!important;color:white!important;}
.btn-danger{background:linear-gradient(135deg,#d32f2f 0%,#b71c1c 100%)!important;color:white!important;}
.btn-success{background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%)!important;color:white!important;}

.retry-notice{background:linear-gradient(135deg,#e3f2fd,#bbdefb);border:2px solid #90caf9;color:#1565c0;padding:14px;margin-top:15px;font-size:12px;line-height:1.6;border-radius:10px;}
.flex-row{display:flex;gap:10px;}
.flex-between{display:flex;justify-content:space-between;align-items:center;}

/* ===== ã‚³ã‚¹ãƒ‘ã‚¿ãƒ– ===== */
.cospa-filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.cospa-filter-bar select { margin-top: 0; flex: 1; min-width: 120px; }

.cospa-summary {
  background: linear-gradient(135deg, #000 0%, #2c2c2c 100%);
  color: white; padding: 20px 25px; border-radius: 14px;
  margin-bottom: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  animation: cardAppear 0.5s cubic-bezier(0.16,1,0.3,1);
}
.cospa-summary-title { font-family: 'Cormorant Garamond', serif; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; opacity: 0.7; margin-bottom: 8px; }
.cospa-summary-value { font-family: 'Cormorant Garamond', serif; font-size: 2.2rem; font-weight: 300; letter-spacing: 2px; line-height: 1; }
.cospa-summary-sub { font-size: 11px; opacity: 0.6; margin-top: 6px; letter-spacing: 0.5px; }

.cospa-card {
  background: white; border: 2px solid #f0f0f0; border-radius: 14px;
  padding: 20px; margin-bottom: 14px; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  animation: fadeInUp 0.4s ease both; position: relative; overflow: hidden;
}
.cospa-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
  background: linear-gradient(to bottom, #c9a97e, #b8976d);
}
.cospa-card:hover { box-shadow: 0 6px 25px rgba(0,0,0,0.1); border-color: #c9a97e; transform: translateX(4px); }
.cospa-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.cospa-card-name { font-weight: 700; font-size: 14px; flex: 1; padding-right: 10px; line-height: 1.4; }
.cospa-card-price { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 600; color: #000; white-space: nowrap; }
.cospa-card-price span { font-size: 11px; font-family: inherit; color: #666; letter-spacing: 0.5px; }
.cospa-card-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
.cospa-badge { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 600; letter-spacing: 0.5px; background: #f0f0f0; color: #555; }
.cospa-badge.cat { background: #000; color: white; }
.cospa-badge.days { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #2e7d32; }
.cospa-badge.finished { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; }
.cospa-badge.warning { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: #e65100; }
.cospa-bar-wrap { margin-top: 10px; }
.cospa-bar-label { font-size: 10px; color: #999; margin-bottom: 4px; letter-spacing: 0.3px; }
.cospa-bar-bg { width:100%; background:#f0f0f0; height:5px; border-radius:10px; overflow:hidden; }
.cospa-bar-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, #c9a97e, #b8976d); transition: width 1s cubic-bezier(0.16,1,0.3,1); }
.cospa-empty { text-align: center; padding: 40px 20px; color: #999; font-size: 14px; line-height: 2; }
.cospa-rank { position: absolute; right: 20px; bottom: 20px; font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 300; color: #f0f0f0; pointer-events: none; letter-spacing: 2px; }

/* ===== ã‚³ã‚¹ãƒ‘å‰Šé™¤ãƒœã‚¿ãƒ³ ===== */
.cospa-delete-btn {
  width: auto; padding: 7px 12px; margin: 10px 0 0; font-size: 11px;
  background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%) !important;
  border-radius: 8px; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(211,47,47,0.2);
}

::-webkit-scrollbar{width:8px;height:8px;}
::-webkit-scrollbar-track{background:#f0f0f0;border-radius:10px;}
::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#c9a97e,#b8976d);border-radius:10px;}
::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,#b8976d,#a8866d);}
</style>
</head>
<body>

<div class="header">
  <span style="position:relative;z-index:1;">COSME GENIUS PRO</span>
</div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" id="btn-register" onclick="switchTab('register')">ğŸ’„ ç™»éŒ²</button>
    <button class="tab-btn" id="btn-chat" onclick="switchTab('chat')">ğŸ’¬ ç›¸è«‡</button>
    <button class="tab-btn" id="btn-cospa" onclick="switchTab('cospa')">ğŸ’° ã‚³ã‚¹ãƒ‘</button>
    <button class="tab-btn" id="btn-settings" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
  </div>

  <!-- ===== ç™»éŒ²ã‚¿ãƒ– ===== -->
  <div id="tab-register" class="tab-content active">
    <div class="card">
      <h2>âœ¨ ã‚³ã‚¹ãƒ¡ç™»éŒ²</h2>
      <button onclick="showPhotoSheet()" style="margin-bottom:25px;padding:16px;font-size:14px;letter-spacing:1px;">
        <span style="position:relative;z-index:1;">ğŸ“· å†™çœŸã‹ã‚‰AIç™»éŒ²</span>
      </button>

      <div id="photoSheet" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.5);" onclick="hidePhotoSheet()">
        <div style="position:absolute;bottom:0;left:0;right:0;background:white;border-radius:20px 20px 0 0;padding:20px;max-width:500px;margin:0 auto;" onclick="event.stopPropagation()">
          <div style="width:40px;height:4px;background:#e0e0e0;border-radius:4px;margin:0 auto 20px;"></div>
          <p style="text-align:center;font-size:12px;color:#999;margin:0 0 20px;letter-spacing:1px;text-transform:uppercase;font-family:'Cormorant Garamond',serif;">å†™çœŸã‚’é¸æŠ</p>
          <label for="cameraInput" style="display:flex;align-items:center;gap:14px;padding:18px;border-radius:12px;border:2px solid #f0f0f0;margin-bottom:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#000'" onmouseout="this.style.borderColor='#f0f0f0'" onclick="hidePhotoSheet()">
            <span style="font-size:26px;">ğŸ“¸</span>
            <span><div style="font-weight:700;font-size:15px;color:#1a1a1a;">ã‚«ãƒ¡ãƒ©ã§æ’®å½±</div><div style="font-size:12px;color:#999;margin-top:2px;">ãã®å ´ã§å•†å“ã‚’æ’®å½±</div></span>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(event)">
          </label>
          <label for="albumInput" style="display:flex;align-items:center;gap:14px;padding:18px;border-radius:12px;border:2px solid #f0f0f0;margin-bottom:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#000'" onmouseout="this.style.borderColor='#f0f0f0'" onclick="hidePhotoSheet()">
            <span style="font-size:26px;">ğŸ–¼ï¸</span>
            <span><div style="font-weight:700;font-size:15px;color:#1a1a1a;">ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸æŠ</div><div style="font-size:12px;color:#999;margin-top:2px;">ãƒ•ã‚©ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶</div></span>
            <input type="file" id="albumInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
          </label>
          <label for="fileInput" style="display:flex;align-items:center;gap:14px;padding:18px;border-radius:12px;border:2px solid #f0f0f0;margin-bottom:20px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#000'" onmouseout="this.style.borderColor='#f0f0f0'" onclick="hidePhotoSheet()">
            <span style="font-size:26px;">ğŸ“</span>
            <span><div style="font-weight:700;font-size:15px;color:#1a1a1a;">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</div><div style="font-size:12px;color:#999;margin-top:2px;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªãªã©ã‹ã‚‰é¸ã¶</div></span>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
          </label>
          <button onclick="hidePhotoSheet()" style="background:#f0f0f0;color:#1a1a1a;box-shadow:none;padding:14px;font-size:13px;letter-spacing:0.5px;">
            <span style="position:relative;z-index:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
          </button>
        </div>
      </div>

      <div id="progressContainer" class="progress-container">
        <div id="progressText" style="font-size:12px;color:#1a1a1a;text-align:center;font-weight:500;letter-spacing:0.5px;">ç”»åƒã‚’è§£æä¸­...</div>
        <div class="progress-bar-bg"><div id="progressBar" class="progress-bar-fill"></div></div>
      </div>

      <div class="flex-row">
        <input type="text" id="itemName" placeholder="å•†å“å" style="margin-top:0;flex:1;">
        <button onclick="triggerManualAISearch()" style="width:auto;white-space:nowrap;margin-top:0;padding:0 14px;flex-shrink:0;font-size:12px;"><span style="position:relative;z-index:1;">âœ¨ AIæ¨æ¸¬</span></button>
      </div>
      <input type="text" id="brand" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰å">
      <select id="categorySelect">
        <option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
        <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
        <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
        <option value="ä¹³æ¶²">ä¹³æ¶²</option>
        <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
        <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <input type="text" id="ingredient" placeholder="å…¨æˆåˆ†ï¼ˆä¾‹: æ°´ã€ã‚°ãƒªã‚»ãƒªãƒ³ã€BG...ï¼‰">
      <textarea id="description" placeholder="å•†å“èª¬æ˜"></textarea>
      <div class="flex-row">
        <input type="text" id="releaseDate" placeholder="ç™ºå£²æ—¥">
        <input type="number" id="itemPrice" placeholder="ä¾¡æ ¼ï¼ˆå††ï¼‰">
      </div>
      <label style="font-size:12px;color:#666;margin-top:12px;display:block;letter-spacing:0.3px;">ä½¿ç”¨é–‹å§‹æ—¥</label>
      <input type="date" id="openDate">
      <select id="timeTag">
        <option value="æœ">æœç”¨</option>
        <option value="æ™©">æ™©ç”¨</option>
        <option value="æœæ™©">æœæ™©ä¸¡æ–¹</option>
      </select>
      <button onclick="addItem()" style="margin-top:20px;padding:15px;"><span style="position:relative;z-index:1;">ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹</span></button>
    </div>

    <div class="card">
      <div class="flex-between" style="margin-bottom:20px;">
        <h2 style="margin:0;border:none;padding:0;">ğŸ“‹ ç™»éŒ²æ¸ˆã¿ã‚³ã‚¹ãƒ¡</h2>
        <button onclick="exportData()" class="btn-secondary" style="width:auto;padding:10px 15px;font-size:11px;margin:0;"><span style="position:relative;z-index:1;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span></button>
      </div>
      <div class="sort-controls">
        <select id="sortSelect" onchange="render()">
          <option value="newest">æ–°ç€é †</option>
          <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
          <option value="brand">ãƒ–ãƒ©ãƒ³ãƒ‰åˆ¥</option>
          <option value="expiring">ä½¿ç”¨æ—¥æ•°é †</option>
        </select>
      </div>
      <div id="routineArea"></div>
      <div id="paginationArea" class="pagination"></div>
    </div>
  </div>

  <!-- ===== ã‚³ã‚¹ãƒ‘ã‚¿ãƒ– ===== -->
  <div id="tab-cospa" class="tab-content">
    <div class="card">
      <h2>ğŸ’° ã‚³ã‚¹ãƒ‘åˆ†æ</h2>
      <div id="cospaTopSummary"></div>
      <div class="cospa-filter-bar">
        <select id="cospaCategory" onchange="renderCospa()">
          <option value="all">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
          <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
          <option value="ä¹³æ¶²">ä¹³æ¶²</option>
          <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
          <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
        <select id="cospaSort" onchange="renderCospa()">
          <option value="cost_asc">1æ—¥ã‚ãŸã‚Šå®‰ã„é †</option>
          <option value="cost_desc">1æ—¥ã‚ãŸã‚Šé«˜ã„é †</option>
          <option value="days_desc">ä½¿ç”¨æ—¥æ•°é•·ã„é †</option>
          <option value="name_asc">åå‰é †</option>
        </select>
      </div>
      <div id="cospaList"></div>
    </div>
  </div>

  <!-- ===== ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ– ===== -->
  <div id="tab-chat" class="tab-content">
    <!-- chat-card ã‚¯ãƒ©ã‚¹ã§ padding å‰Šæ¸› â†’ æ¨ªå¹…æœ€å¤§åŒ– -->
    <div class="card chat-card">
      <h2>ğŸ’¬ ã‚³ã‚¹ãƒ¡ç›¸è«‡å®¤</h2>
      <div class="chat-controls">
        <button onclick="createNewChat()" style="flex:1;"><span style="position:relative;z-index:1;">â• æ–°è¦ãƒãƒ£ãƒƒãƒˆ</span></button>
        <button onclick="toggleChatHistory()" id="historyToggleBtn" style="flex:1;"><span style="position:relative;z-index:1;">ğŸ“œ å±¥æ­´</span></button>
      </div>
      <div id="chatHistoryContainer" class="chat-history-list" style="display:none;"></div>
      <div id="chatHistory" class="chat-area">
        <div class="msg-ai">ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã•ã‚ŒãŸã‚³ã‚¹ãƒ¡æƒ…å ±ã‚’å…ƒã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™âœ¨</div>
      </div>
      <div class="chat-input-bar">
        <textarea id="chatInput" class="chat-textarea" placeholder="è³ªå•ã‚’å…¥åŠ›..."></textarea>
        <button id="sendBtn" onclick="sendChatMessage()" class="send-btn"><span style="position:relative;z-index:1;">â¤</span></button>
      </div>
    </div>
  </div>

  <!-- ===== è¨­å®šã‚¿ãƒ– ===== -->
  <div id="tab-settings" class="tab-content">
    <div class="card">
      <h2>âš™ï¸ ã‚¢ãƒ—ãƒªè¨­å®š</h2>
      <div class="alert-box">
        <b>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„</b>
        APIã‚­ãƒ¼ã¯æš—å·åŒ–ã•ã‚Œãšã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å…±æœ‰ç«¯æœ«ã§ã¯ä½¿ç”¨å¾Œã«å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
      </div>
      <div style="background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border:2px solid #81c784;padding:18px;margin-bottom:20px;font-size:13px;color:#2e7d32;line-height:1.6;border-radius:12px;">
        <b>ğŸ’¾ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½</b>
        ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã™ã‚‹ãŸã³ã«è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </div>
      <label style="font-weight:600;color:#1a1a1a;font-size:13px;letter-spacing:0.5px;display:block;margin-bottom:5px;">ğŸ¤– Gemini API ã‚­ãƒ¼</label>
      <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
      <p style="font-size:12px;color:#666;margin:15px 0 8px;letter-spacing:0.3px;">ğŸ¤– ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</p>
      <div style="background:linear-gradient(135deg,#f3e5f5,#e1bee7);border:2px solid #ce93d8;padding:14px;border-radius:10px;font-size:13px;color:#6a1b9a;font-weight:600;letter-spacing:0.5px;">
        âœ¨ Gemini 3 Flash Previewï¼ˆå›ºå®šï¼‰
      </div>
      <div class="retry-notice" style="margin-top:15px;">
        ğŸ’¡ <b>Gemini 3 Flash Preview:</b> æ€è€ƒãƒ¢ãƒ¼ãƒ‰æ­è¼‰ã®ãŸã‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã‚’è‡ªå‹•ã§æœ€é©åŒ–ã—ã¦ã„ã¾ã™ã€‚<br><br>
        âš ï¸ <b>ã‚¨ãƒ©ãƒ¼429å¯¾ç­–:</b> ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã„å ´åˆã¯1åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚
      </div>
      <button onclick="saveSettings()" style="margin-top:20px;padding:15px;"><span style="position:relative;z-index:1;">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</span></button>
      <button onclick="clearApiKey()" class="btn-danger" style="margin-top:10px;padding:15px;"><span style="position:relative;z-index:1;">ğŸ—‘ï¸ APIã‚­ãƒ¼ã‚’å‰Šé™¤</span></button>
      <hr style="margin:25px 0;border:none;border-top:1px solid #e5e5e5;">
      <button onclick="importData()" class="btn-secondary" style="padding:15px;"><span style="position:relative;z-index:1;">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</span></button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
    </div>
  </div>
</div>

<canvas id="compressionCanvas" style="display:none;"></canvas>

<script>
let cosmeData = JSON.parse(localStorage.getItem('cosmeData_v8')) || [];
let currentPage = 1;
const itemsPerPage = 10;
let isRequesting = false;
let lastRequestTime = 0;
const APP_VERSION = 'v9.2';

let chatHistories = JSON.parse(localStorage.getItem('chatHistories_v1')) || [];
let currentChatId = null;
let showingHistory = false;

/* ===== ãƒ‡ãƒ¼ã‚¿ä¿å­˜ ===== */
function autoBackup() {
  if(cosmeData.length > 0) {
    var backup = { version: APP_VERSION, timestamp: new Date().toISOString(), data: cosmeData, chats: chatHistories };
    localStorage.setItem('cosmeBackup_auto', JSON.stringify(backup));
  }
}
function saveCosmeData() {
  localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData));
  autoBackup();
}

/* ===== åˆæœŸåŒ– ===== */
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('openDate').valueAsDate = new Date();
  document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey_v1') || '';
  document.getElementById('chatInput').addEventListener('keydown', function(e) {
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
  });
  if(chatHistories.length > 0) { currentChatId = chatHistories[0].id; loadChat(currentChatId); }
  else { createNewChat(); }
  render();
  renderCospa();
});

/* ===== ã‚¿ãƒ–åˆ‡æ›¿ ===== */
function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(function(el){ el.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(el){ el.classList.remove('active'); });
  document.getElementById('tab-' + tabId).classList.add('active');
  document.getElementById('btn-' + tabId).classList.add('active');
  if(tabId === 'cospa') renderCospa();
}

/* ===== API è¨­å®š ===== */
function validateApiKey() {
  var apiKey = localStorage.getItem('geminiApiKey_v1');
  if(!apiKey || apiKey.length < 10) { alert('âš ï¸ è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„'); switchTab('settings'); return false; }
  return true;
}
async function waitForRateLimit() {
  var now = Date.now();
  var timeSinceLastRequest = now - lastRequestTime;
  var minInterval = 2000;
  if(timeSinceLastRequest < minInterval) {
    await new Promise(function(resolve){ setTimeout(resolve, minInterval - timeSinceLastRequest); });
  }
  lastRequestTime = Date.now();
}
function getApiUrl() {
  var apiKey = localStorage.getItem('geminiApiKey_v1');
  return 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=' + apiKey;
}

/* ===== Gemini 3 Flash Preview æ€è€ƒãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ ===== */
function extractTextFromParts(data) {
  try {
    var parts = data.candidates[0].content.parts;
    var textParts = parts.filter(function(p) { return typeof p.text === 'string'; });
    if(textParts.length === 0) throw new Error('ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    for(var i = textParts.length - 1; i >= 0; i--) {
      if(textParts[i].text.includes('{')) return textParts[i].text;
    }
    return textParts[textParts.length - 1].text;
  } catch(e) {
    throw new Error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

function parseAIJson(text) {
  try {
    var jsonText = text.replace(/```json\n?|```/g, '').trim();
    return JSON.parse(jsonText);
  } catch(e) {
    var match = text.match(/\{[\s\S]*\}/);
    if(match) { try { return JSON.parse(match[0]); } catch(e2) {} }
    throw new Error("AIã®å¿œç­”å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: " + text.substring(0, 150));
  }
}
function handleApiError(resp, errorData) {
  if(resp.status === 429) throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ä¸­ã€‚1åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
  if(resp.status === 404) throw new Error('ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚APIã‚­ãƒ¼ãŒGemini 3å¯¾å¿œã‹ã”ç¢ºèªãã ã•ã„ã€‚');
  throw new Error('API Error: ' + resp.status + ' - ' + (errorData.error ? errorData.error.message : 'ä¸æ˜'));
}

/* ===== å†™çœŸã‚·ãƒ¼ãƒˆ ===== */
function showPhotoSheet() { document.getElementById('photoSheet').style.display = 'block'; document.body.style.overflow = 'hidden'; }
function hidePhotoSheet() { document.getElementById('photoSheet').style.display = 'none'; document.body.style.overflow = ''; }

document.addEventListener('touchmove', function(e) { if(e.touches.length > 1) e.preventDefault(); }, { passive: false });
var lastTouchEnd = 0;
document.addEventListener('touchend', function(e) { var now = Date.now(); if(now - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd = now; }, false);

/* ===== AIæ¨æ¸¬ ===== */
async function triggerManualAISearch() {
  if(!validateApiKey()) return;
  if(isRequesting) { alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚'); return; }
  var name = document.getElementById('itemName').value.trim();
  if(!name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  isRequesting = true;
  startProgress("AIãŒè©³ç´°ã‚’æ¤œç´¢ä¸­...", 40);
  try {
    await waitForRateLimit();
    var prompt = 'åŒ–ç²§å“ã€Œ' + name + 'ã€ã®æƒ…å ±ã‚’JSONå½¢å¼ã®ã¿ã§å›ç­”ã€‚ä½™åˆ†ãªãƒ†ã‚­ã‚¹ãƒˆä¸è¦ã€‚\n{"brand":"","category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–ã®ã„ãšã‚Œã‹","ingredients":"å…¨æˆåˆ†ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§","description":"","price":0,"releaseDate":""}';
    var resp = await fetch(getApiUrl(), {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.1, maxOutputTokens: 512 } })
    });
    if(!resp.ok) { var ed = await resp.json().catch(function(){return{};}); handleApiError(resp, ed); }
    var data = await resp.json();
    if(data.error) throw new Error(data.error.message);
    var res = parseAIJson(extractTextFromParts(data));
    if(res.brand) document.getElementById('brand').value = res.brand;
    if(res.category) document.getElementById('categorySelect').value = res.category;
    if(res.ingredients) document.getElementById('ingredient').value = res.ingredients;
    if(res.description) document.getElementById('description').value = res.description;
    if(res.price) document.getElementById('itemPrice').value = res.price;
    if(res.releaseDate) document.getElementById('releaseDate').value = res.releaseDate;
    finishProgress();
  } catch(e) { hideProgress(); alert("AIæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message); }
  finally { isRequesting = false; }
}

/* ===== ç”»åƒè§£æ ===== */
async function handleImageSelect(event) {
  if(!validateApiKey()) return;
  if(isRequesting) { alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚'); event.target.value = ''; return; }
  var file = event.target.files[0];
  if(!file) return;
  isRequesting = true;
  startProgress("ç”»åƒã‹ã‚‰å•†å“åã‚’èª­ã¿å–ã‚Šä¸­...", 20);
  try {
    var base64Data = await compressImage(file);
    updateProgress(40);
    var base64 = base64Data.split(',')[1];
    await waitForRateLimit();
    var prompt1 = 'ç”»åƒã‹ã‚‰åŒ–ç²§å“ã®å•†å“åã¨ãƒ–ãƒ©ãƒ³ãƒ‰åã ã‘èª­ã¿å–ã£ã¦JSONå½¢å¼ã®ã¿ã§å›ç­”ã€‚{"itemName":"","brandName":""}';
    var resp1 = await fetch(getApiUrl(), {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt1 }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }], generationConfig: { temperature: 0.1, maxOutputTokens: 256 } })
    });
    if(!resp1.ok) { var ed = await resp1.json().catch(function(){return{};}); handleApiError(resp1, ed); }
    var data1 = await resp1.json();
    if(data1.error) throw new Error(data1.error.message);
    var res1 = parseAIJson(extractTextFromParts(data1));
    var itemName = res1.itemName || '';
    var brandName = res1.brandName || '';
    if(itemName) document.getElementById('itemName').value = itemName;
    if(brandName) document.getElementById('brand').value = brandName;
    updateProgress(65);
    if(itemName) {
      startProgress("å•†å“æƒ…å ±ã‚’AIäºˆæ¸¬ä¸­...", 70);
      await waitForRateLimit();
      var prompt2 = 'åŒ–ç²§å“ã€Œ' + itemName + 'ã€(ãƒ–ãƒ©ãƒ³ãƒ‰:' + (brandName||'ä¸æ˜') + ')ã®æƒ…å ±ã‚’JSONå½¢å¼ã®ã¿ã§å›ç­”ã€‚{"category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–ã®ã„ãšã‚Œã‹","ingredients":"å…¨æˆåˆ†ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§","description":"","price":0,"releaseDate":""}';
      var resp2 = await fetch(getApiUrl(), {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt2 }] }], generationConfig: { temperature: 0.1, maxOutputTokens: 512 } })
      });
      if(!resp2.ok) { var ed2 = await resp2.json().catch(function(){return{};}); handleApiError(resp2, ed2); }
      var data2 = await resp2.json();
      if(data2.error) throw new Error(data2.error.message);
      var res2 = parseAIJson(extractTextFromParts(data2));
      if(res2.category) document.getElementById('categorySelect').value = res2.category;
      if(res2.ingredients) document.getElementById('ingredient').value = res2.ingredients;
      if(res2.description) document.getElementById('description').value = res2.description;
      if(res2.price) document.getElementById('itemPrice').value = res2.price;
      if(res2.releaseDate) document.getElementById('releaseDate').value = res2.releaseDate;
    }
    finishProgress();
  } catch(e) { hideProgress(); alert("è§£æã‚¨ãƒ©ãƒ¼: " + e.message); }
  finally { isRequesting = false; event.target.value = ''; }
}

function compressImage(file) {
  return new Promise(function(resolve) {
    var r = new FileReader();
    r.readAsDataURL(file);
    r.onload = function(e) {
      var img = new Image();
      img.src = e.target.result;
      img.onload = function() {
        var c = document.getElementById('compressionCanvas');
        var ctx = c.getContext('2d');
        var scale = Math.min(600 / img.width, 1);
        c.width = img.width * scale; c.height = img.height * scale;
        ctx.drawImage(img, 0, 0, c.width, c.height);
        resolve(c.toDataURL('image/jpeg', 0.75));
      };
    };
  });
}

/* ===== ãƒãƒ£ãƒƒãƒˆ ===== */
function createNewChat() {
  var chatId = 'chat_' + Date.now();
  var newChat = { id: chatId, title: 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ', date: new Date().toISOString(),
    messages: [{ type: 'ai', text: 'ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã•ã‚ŒãŸã‚³ã‚¹ãƒ¡æƒ…å ±ã‚’å…ƒã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™âœ¨' }] };
  chatHistories.unshift(newChat);
  saveChatHistories();
  currentChatId = chatId;
  loadChat(chatId);
  if(showingHistory) toggleChatHistory();
}
function loadChat(chatId) {
  currentChatId = chatId;
  var chat = chatHistories.find(function(c){ return c.id === chatId; });
  if(!chat) return;
  var chatHistory = document.getElementById('chatHistory');
  chatHistory.innerHTML = '';
  chat.messages.forEach(function(msg) {
    var div = document.createElement('div');
    div.className = msg.type === 'user' ? 'msg-user' : (msg.type === 'ai' ? 'msg-ai' : 'msg-system');
    div.innerHTML = formatMessage(msg.text, msg.type);
    chatHistory.appendChild(div);
  });
  chatHistory.scrollTop = chatHistory.scrollHeight;
  renderChatHistoryList();
}
function formatMessage(text, type) {
  if(type === 'user' || type === 'system') return escapeHtml(text).replace(/\n/g, '<br>');
  var f = escapeHtml(text);
  f = f.replace(/###\s+(.+?)($|\n)/g, '<h4>$1</h4>');
  f = f.replace(/##\s+(.+?)($|\n)/g, '<h3>$1</h3>');
  f = f.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  f = f.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
  f = f.replace(/`(.+?)`/g, '<code>$1</code>');
  f = f.replace(/^[-â€¢]\s+(.+?)$/gm, '<li>$1</li>');
  f = f.replace(/^\d+\.\s+(.+?)$/gm, '<li>$1</li>');
  f = f.replace(/\n/g, '<br>');
  return f;
}
function toggleChatHistory() {
  showingHistory = !showingHistory;
  var container = document.getElementById('chatHistoryContainer');
  var btn = document.getElementById('historyToggleBtn');
  if(showingHistory) { container.style.display = 'block'; btn.innerHTML = '<span style="position:relative;z-index:1;">âœ• é–‰ã˜ã‚‹</span>'; renderChatHistoryList(); }
  else { container.style.display = 'none'; btn.innerHTML = '<span style="position:relative;z-index:1;">ğŸ“œ å±¥æ­´</span>'; }
}
function renderChatHistoryList() {
  var container = document.getElementById('chatHistoryContainer');
  var html = '';
  chatHistories.forEach(function(chat) {
    var isActive = chat.id === currentChatId;
    var date = new Date(chat.date).toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    html += '<div class="chat-history-item' + (isActive ? ' active' : '') + '" onclick="selectChat(\'' + chat.id + '\')">';
    html += '<div class="chat-history-info"><div class="chat-history-title">' + escapeHtml(chat.title) + '</div>';
    html += '<div class="chat-history-date">' + date + '</div></div>';
    html += '<button class="chat-history-delete" onclick="event.stopPropagation();deleteChat(\'' + chat.id + '\')"><span style="position:relative;z-index:1;">ğŸ—‘ï¸</span></button>';
    html += '</div>';
  });
  if(!html) html = '<div style="padding:20px;text-align:center;color:#999;font-size:13px;">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  container.innerHTML = html;
}
function selectChat(chatId) { loadChat(chatId); }
function deleteChat(chatId) {
  if(!confirm('ã“ã®ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  chatHistories = chatHistories.filter(function(c){ return c.id !== chatId; });
  saveChatHistories();
  if(currentChatId === chatId) { if(chatHistories.length > 0) loadChat(chatHistories[0].id); else createNewChat(); }
  else renderChatHistoryList();
}
function saveChatHistories() { localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories)); }
function updateChatTitle(chatId, firstMessage) {
  var chat = chatHistories.find(function(c){ return c.id === chatId; });
  if(!chat) return;
  chat.title = firstMessage.length > 20 ? firstMessage.substring(0, 20) + '...' : firstMessage;
  saveChatHistories(); renderChatHistoryList();
}
function addMessageToChat(chatId, type, text) {
  var chat = chatHistories.find(function(c){ return c.id === chatId; });
  if(!chat) return;
  chat.messages.push({ type: type, text: text });
  if(type === 'user' && chat.messages.filter(function(m){ return m.type === 'user'; }).length === 1) updateChatTitle(chatId, text);
  saveChatHistories();
}
async function sendChatMessage() {
  if(!validateApiKey()) return;
  if(isRequesting) { alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚'); return; }
  var inputEl = document.getElementById('chatInput');
  var sendBtn = document.getElementById('sendBtn');
  var message = inputEl.value.trim();
  if(!message) return;
  isRequesting = true;
  inputEl.disabled = true; sendBtn.disabled = true;
  var chatHistory = document.getElementById('chatHistory');
  var userDiv = document.createElement('div');
  userDiv.className = 'msg-user'; userDiv.textContent = message;
  chatHistory.appendChild(userDiv);
  addMessageToChat(currentChatId, 'user', message);
  inputEl.value = '';
  chatHistory.scrollTop = chatHistory.scrollHeight;
  var streamMsgId = 'stream-' + Date.now();
  var streamDiv = document.createElement('div');
  streamDiv.id = streamMsgId; streamDiv.className = 'msg-ai';
  streamDiv.innerHTML = '<span style="color:#999;">è€ƒãˆä¸­...</span>';
  chatHistory.appendChild(streamDiv);
  var cosmeListText = cosmeData.length > 0 ? JSON.stringify(cosmeData) : 'ç™»éŒ²ã‚³ã‚¹ãƒ¡ãªã—';
  var promptText = 'ã‚ãªãŸã¯ç¾å®¹éƒ¨å“¡AIã§ã™ã€‚é‡è¦ç‚¹ã¯**å¤ªå­—**ã€è¦‹å‡ºã—ã¯##/###ã€ãƒªã‚¹ãƒˆã¯-ã‚„æ•°å­—ã§æ•´ç†ã—ã¦ãã ã•ã„ã€‚\nã€ç™»éŒ²ã‚³ã‚¹ãƒ¡ã€‘:' + cosmeListText + '\nã€è³ªå•ã€‘:' + message;
  try {
    await waitForRateLimit();
    var resp = await fetch(getApiUrl(), {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }], generationConfig: { temperature: 0.8, maxOutputTokens: 1024 } })
    });
    if(!resp.ok) { var ed = await resp.json().catch(function(){return{};}); handleApiError(resp, ed); }
    var data = await resp.json();
    if(data.error) throw new Error(data.error.message);
    if(!data.candidates || !data.candidates[0]?.content?.parts) throw new Error('APIã‹ã‚‰ã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™');
    var fullText = extractTextFromParts(data);
    var charIndex = 0;
    var typingInterval = setInterval(function() {
      if(charIndex < fullText.length) {
        streamDiv.innerHTML = formatMessage(fullText.substring(0, charIndex + 1), 'ai');
        chatHistory.scrollTop = chatHistory.scrollHeight;
        charIndex += Math.max(1, Math.floor(Math.random() * 3));
      } else {
        clearInterval(typingInterval);
        streamDiv.innerHTML = formatMessage(fullText, 'ai');
        addMessageToChat(currentChatId, 'ai', fullText);
      }
    }, 30);
  } catch(e) {
    var el = document.getElementById(streamMsgId);
    if(el) el.remove();
    var errDiv = document.createElement('div');
    errDiv.className = 'msg-system'; errDiv.textContent = 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + e.message;
    chatHistory.appendChild(errDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    addMessageToChat(currentChatId, 'system', 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + e.message);
  } finally {
    isRequesting = false; inputEl.disabled = false; sendBtn.disabled = false; inputEl.focus();
  }
}

/* ===== ç™»éŒ² ===== */
function addItem() {
  var item = {
    name: document.getElementById('itemName').value.trim(),
    brand: document.getElementById('brand').value.trim(),
    category: document.getElementById('categorySelect').value,
    ingredient: document.getElementById('ingredient').value.trim(),
    description: document.getElementById('description').value.trim(),
    releaseDate: document.getElementById('releaseDate').value,
    price: document.getElementById('itemPrice').value,
    openDate: document.getElementById('openDate').value,
    finishDate: null,
    tag: document.getElementById('timeTag').value,
    id: Date.now()
  };
  if(!item.name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  cosmeData.unshift(item);
  saveCosmeData();
  ['itemName','brand','ingredient','description','releaseDate','itemPrice'].forEach(function(id){ document.getElementById(id).value = ''; });
  document.getElementById('categorySelect').value = '';
  document.getElementById('openDate').valueAsDate = new Date();
  currentPage = 1;
  render();
  renderCospa();
  alert("ç™»éŒ²ã—ã¾ã—ãŸï¼âœ¨");
}

/* ===== ç™»éŒ²ã‚¿ãƒ–ã®å‰Šé™¤ï¼ˆã‚³ã‚¹ãƒ‘ã«ã¯å½±éŸ¿ã—ãªã„ï¼‰ ===== */
function removeItem(id) {
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã‚³ã‚¹ãƒ‘ã‚¿ãƒ–ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚")) {
    cosmeData = cosmeData.filter(function(i){ return i.id !== id; });
    saveCosmeData();
    var totalPages = Math.ceil(cosmeData.length / itemsPerPage);
    if(currentPage > totalPages && currentPage > 1) currentPage = totalPages;
    render();
    // ã‚³ã‚¹ãƒ‘ã‚¿ãƒ–ã¯å†æç”»ã—ãªã„ â†’ ç‹¬ç«‹ã—ã¦ç®¡ç†
  }
}

/* ===== ã‚³ã‚¹ãƒ‘ã‚¿ãƒ–å°‚ç”¨å‰Šé™¤ ===== */
function removeCospaItem(id) {
  if(confirm("ã‚³ã‚¹ãƒ‘ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç™»éŒ²ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰")) {
    cosmeData = cosmeData.filter(function(i){ return i.id !== id; });
    saveCosmeData();
    renderCospa();
    // ç™»éŒ²ã‚¿ãƒ–ã¯å†æç”»ã—ãªã„
  }
}

/* ===== â˜… ä½¿ç”¨é–‹å§‹æ—¥ãƒ»ä¾¡æ ¼ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›† ===== */
function saveEditField(id, field, inputId) {
  var item = cosmeData.find(function(i){ return i.id === id; });
  if(!item) return;
  var val = document.getElementById(inputId).value;
  item[field] = val;
  saveCosmeData();
  // ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰å†…ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆå†æç”»ãªã—ã§å€¤ã ã‘åæ˜ ï¼‰
  var displayEl = document.getElementById('display-' + field + '-' + id);
  if(displayEl) {
    if(field === 'price') {
      displayEl.textContent = val ? 'Â¥' + parseFloat(val).toLocaleString() : '-';
    } else if(field === 'openDate') {
      var days = getDaysUsed(val);
      displayEl.textContent = (val || '-') + (days !== null ? ' (' + days + 'æ—¥çµŒé)' : '');
    } else {
      displayEl.textContent = val || '-';
    }
  }
  // ã‚³ã‚¹ãƒ‘ã®1æ—¥ã‚ãŸã‚Šè¡¨ç¤ºã‚‚æ›´æ–°
  var cospaEl = document.getElementById('display-cospa-' + id);
  if(cospaEl) {
    var cp = calcDailyPrice(item);
    cospaEl.textContent = cp ? 'Â¥' + Math.round(cp.daily) + (item.finishDate ? 'ï¼ˆå®Œèµ°ï¼‰' : 'ï¼ˆä½¿ç”¨ä¸­ï¼‰') : '-';
  }
  // ä¿å­˜ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  var btn = document.querySelector('[data-savebtn="' + id + '-' + field + '"]');
  if(btn) {
    btn.innerHTML = '<span style="position:relative;z-index:1;">âœ“ ä¿å­˜æ¸ˆ</span>';
    setTimeout(function(){ btn.innerHTML = '<span style="position:relative;z-index:1;">ä¿å­˜</span>'; }, 1500);
  }
}

/* ===== ä½¿ã„åˆ‡ã‚Š ===== */
function markFinished(id) {
  var item = cosmeData.find(function(i){ return i.id === id; });
  if(!item) return;
  if(item.finishDate) {
    if(!confirm("ä½¿ã„åˆ‡ã‚Šæ—¥ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    item.finishDate = null;
    alert("ä½¿ã„åˆ‡ã‚Šã‚’è§£é™¤ã—ã¾ã—ãŸ");
  } else {
    var today = new Date().toISOString().split('T')[0];
    item.finishDate = today;
    alert("ä½¿ã„åˆ‡ã‚Šå®Œäº†ï¼âœ¨ ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼");
  }
  saveCosmeData();
  render(); renderCospa();
}

/* ===== ã‚³ã‚¹ãƒ‘è¨ˆç®— ===== */
function calcDailyPrice(item) {
  var price = parseFloat(item.price);
  if(!price || price <= 0) return null;
  var openDate = item.openDate;
  if(!openDate) return null;
  var endDate = item.finishDate ? new Date(item.finishDate) : new Date();
  var startDate = new Date(openDate);
  var days = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
  if(days <= 0) return null;
  return { daily: price / days, days: days, finished: !!item.finishDate };
}

/* ===== ã‚³ã‚¹ãƒ‘ã‚¿ãƒ–æç”»ï¼ˆç‹¬ç«‹ãƒ»å°‚ç”¨å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãï¼‰ ===== */
function renderCospa() {
  var categoryFilter = document.getElementById('cospaCategory') ? document.getElementById('cospaCategory').value : 'all';
  var sortType = document.getElementById('cospaSort') ? document.getElementById('cospaSort').value : 'cost_asc';

  var filtered = cosmeData.filter(function(item) {
    if(categoryFilter !== 'all' && item.category !== categoryFilter) return false;
    return calcDailyPrice(item) !== null;
  });

  filtered.sort(function(a, b) {
    var ca = calcDailyPrice(a), cb = calcDailyPrice(b);
    if(sortType === 'cost_asc') return ca.daily - cb.daily;
    if(sortType === 'cost_desc') return cb.daily - ca.daily;
    if(sortType === 'days_desc') return cb.days - ca.days;
    if(sortType === 'name_asc') return (a.name || '').localeCompare(b.name || '');
    return 0;
  });

  var summaryEl = document.getElementById('cospaTopSummary');
  if(filtered.length > 0) {
    var totalDaily = filtered.reduce(function(sum, item){ return sum + calcDailyPrice(item).daily; }, 0);
    var totalMonthly = totalDaily * 30;
    summaryEl.innerHTML =
      '<div class="cospa-summary" style="display:flex;gap:20px;">' +
        '<div style="flex:1;"><div class="cospa-summary-title">1æ—¥ã‚ãŸã‚Šåˆè¨ˆ</div>' +
        '<div class="cospa-summary-value">Â¥' + Math.round(totalDaily).toLocaleString() + '</div>' +
        '<div class="cospa-summary-sub">è¡¨ç¤ºä¸­ã® ' + filtered.length + ' ä»¶åˆè¨ˆ</div></div>' +
        '<div style="flex:1;"><div class="cospa-summary-title">1ãƒ¶æœˆã‚ãŸã‚Šåˆè¨ˆ</div>' +
        '<div class="cospa-summary-value">Â¥' + Math.round(totalMonthly).toLocaleString() + '</div>' +
        '<div class="cospa-summary-sub">Ã— 30æ—¥æ›ç®—</div></div>' +
      '</div>';
  } else {
    summaryEl.innerHTML = '';
  }

  var listEl = document.getElementById('cospaList');
  if(filtered.length === 0) {
    var noDataMsg = cosmeData.length === 0 ?
      'ğŸ’„ ã¾ãšã‚³ã‚¹ãƒ¡ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„' :
      (categoryFilter !== 'all' ? 'ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ä¾¡æ ¼ãƒ»ä½¿ç”¨é–‹å§‹æ—¥ãŒç™»éŒ²ã•ã‚ŒãŸã‚³ã‚¹ãƒ¡ãŒã‚ã‚Šã¾ã›ã‚“' : 'ä¾¡æ ¼ã¨ä½¿ç”¨é–‹å§‹æ—¥ãŒç™»éŒ²ã•ã‚ŒãŸã‚³ã‚¹ãƒ¡ãŒã‚ã‚Šã¾ã›ã‚“');
    listEl.innerHTML = '<div class="cospa-empty">ğŸ“Š ' + noDataMsg + '<br><small style="color:#bbb;">ä¾¡æ ¼ã¨ä½¿ç”¨é–‹å§‹æ—¥ã‚’å…¥åŠ›ã™ã‚‹ã¨<br>1æ—¥ã‚ãŸã‚Šã®ã‚³ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small></div>';
    return;
  }

  var maxDaily = Math.max.apply(null, filtered.map(function(item){ return calcDailyPrice(item).daily; }));
  var html = '';
  filtered.forEach(function(item, idx) {
    var cp = calcDailyPrice(item);
    var barWidth = maxDaily > 0 ? Math.round((cp.daily / maxDaily) * 100) : 0;
    var rankLabel = idx === 0 ? 'æœ€å®‰' : (idx === filtered.length - 1 && filtered.length > 1 ? 'æœ€é«˜' : '');

    html += '<div class="cospa-card">';
    html += '<span class="cospa-rank">' + (idx + 1) + '</span>';
    html += '<div class="cospa-card-header">';
    html += '<div class="cospa-card-name">' + escapeHtml((item.brand ? item.brand + ' ' : '') + item.name) + '</div>';
    html += '<div class="cospa-card-price">Â¥' + Math.round(cp.daily) + '<span> / æ—¥</span></div>';
    html += '</div>';
    html += '<div class="cospa-card-meta">';
    if(item.category) html += '<span class="cospa-badge cat">' + escapeHtml(item.category) + '</span>';
    html += '<span class="cospa-badge days">ğŸ“… ' + cp.days + 'æ—¥ä½¿ç”¨</span>';
    if(cp.finished) html += '<span class="cospa-badge finished">âœ… ä½¿ã„åˆ‡ã‚Šæ¸ˆ</span>';
    else html += '<span class="cospa-badge warning">ğŸ”„ ä½¿ç”¨ä¸­</span>';
    if(rankLabel) html += '<span class="cospa-badge" style="background:linear-gradient(135deg,#000,#333);color:white;">ğŸ† ' + rankLabel + '</span>';
    html += '</div>';
    html += '<div class="cospa-bar-wrap">';
    html += '<div class="cospa-bar-label">Â¥' + parseFloat(item.price).toLocaleString() + ' Ã· ' + cp.days + 'æ—¥</div>';
    html += '<div class="cospa-bar-bg"><div class="cospa-bar-fill" style="width:' + barWidth + '%"></div></div>';
    html += '</div>';
    /* â˜… ã‚³ã‚¹ãƒ‘å°‚ç”¨å‰Šé™¤ãƒœã‚¿ãƒ³ â˜… */
    html += '<button class="cospa-delete-btn" onclick="removeCospaItem(' + item.id + ')"><span style="position:relative;z-index:1;">ğŸ—‘ï¸ ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤</span></button>';
    html += '</div>';
  });

  listEl.innerHTML = html;

  setTimeout(function() {
    var bars = listEl.querySelectorAll('.cospa-bar-fill');
    bars.forEach(function(bar) {
      var w = bar.style.width;
      bar.style.width = '0%';
      requestAnimationFrame(function() { bar.style.width = w; });
    });
  }, 50);
}

/* ===== ç™»éŒ²ãƒªã‚¹ãƒˆæç”» ===== */
function getDaysUsed(openDate) {
  if(!openDate) return null;
  return Math.floor((new Date() - new Date(openDate)) / (1000 * 60 * 60 * 24));
}
function sortData() {
  var sortType = document.getElementById('sortSelect').value;
  var sorted = cosmeData.slice();
  if(sortType === 'newest') sorted.sort(function(a,b){ return b.id - a.id; });
  else if(sortType === 'category') sorted.sort(function(a,b){ return (a.category||'ãã®ä»–').localeCompare(b.category||'ãã®ä»–'); });
  else if(sortType === 'brand') sorted.sort(function(a,b){ return (a.brand||'').localeCompare(b.brand||''); });
  else if(sortType === 'expiring') sorted.sort(function(a,b){ return (getDaysUsed(b.openDate)||0) - (getDaysUsed(a.openDate)||0); });
  return sorted;
}
function render() {
  var sorted = sortData();
  var sortType = document.getElementById('sortSelect').value;
  var paginatedData = sorted.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
  var area = document.getElementById('routineArea');
  var html = '';
  if(sortType === 'category') {
    var categories = {};
    paginatedData.forEach(function(item) {
      var cat = item.category || 'ãã®ä»–';
      if(!categories[cat]) categories[cat] = [];
      categories[cat].push(item);
    });
    ['æ´—é¡”æ–™','åŒ–ç²§æ°´','ä¹³æ¶²','ç¾å®¹æ¶²','ã‚¯ãƒªãƒ¼ãƒ ','ãã®ä»–'].forEach(function(catName) {
      if(!categories[catName]) return;
      html += '<div class="category-header"><span>' + catName + '</span><span class="category-count">' + categories[catName].length + 'å€‹</span></div>';
      categories[catName].forEach(function(item){ html += renderItemCard(item); });
    });
  } else {
    paginatedData.forEach(function(item){ html += renderItemCard(item); });
  }
  area.innerHTML = html;
  renderPagination(sorted.length);
}

/* ===== â˜… ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ä»˜ãã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ ===== */
function renderItemCard(item) {
  var daysUsed = getDaysUsed(item.openDate);
  var cp = calcDailyPrice(item);
  var priceDisplay = item.price ? 'Â¥' + parseFloat(item.price).toLocaleString() : '-';
  var openDisplay = (item.openDate || '-') + (daysUsed !== null ? ' (' + daysUsed + 'æ—¥çµŒé)' : '');
  var cospaDisplay = cp ? 'Â¥' + Math.round(cp.daily) + (item.finishDate ? 'ï¼ˆå®Œèµ°ï¼‰' : 'ï¼ˆä½¿ç”¨ä¸­ï¼‰') : '-';

  var html = '<details class="item-card-details">';
  html += '<summary>' + escapeHtml((item.brand ? item.brand + ' ' : '') + item.name) + ' [' + item.tag + ']' + (item.finishDate ? ' âœ…' : '') + '</summary>';
  html += '<div class="item-details-content">';
  html += '<p><b>ã‚«ãƒ†ã‚´ãƒª:</b> ' + escapeHtml(item.category || '-') + '</p>';
  html += '<p><b>å…¨æˆåˆ†:</b> ' + escapeHtml(item.ingredient || '-') + '</p>';
  html += '<p><b>èª¬æ˜:</b> ' + escapeHtml(item.description || '-') + '</p>';
  html += '<p><b>ç™ºå£²æ—¥:</b> ' + escapeHtml(item.releaseDate || '-') + '</p>';

  /* â˜… ä¾¡æ ¼ ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â˜… */
  html += '<div class="edit-field-row">';
  html += '<b>ä¾¡æ ¼:</b>';
  html += '<span id="display-price-' + item.id + '" style="font-size:13px;color:#1a1a1a;">' + priceDisplay + '</span>';
  html += '</div>';
  html += '<div class="edit-field-row" style="margin-top:4px;">';
  html += '<input type="number" id="edit-price-' + item.id + '" class="edit-inline" value="' + (item.price || '') + '" placeholder="ä¾¡æ ¼ï¼ˆå††ï¼‰" min="0">';
  html += '<button class="edit-save-btn" data-savebtn="' + item.id + '-price" onclick="saveEditField(' + item.id + ',\'price\',\'edit-price-' + item.id + '\')">';
  html += '<span style="position:relative;z-index:1;">ä¿å­˜</span></button>';
  html += '</div>';

  /* â˜… ä½¿ç”¨é–‹å§‹æ—¥ ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â˜… */
  html += '<div class="edit-field-row" style="margin-top:10px;">';
  html += '<b>ä½¿ç”¨é–‹å§‹æ—¥:</b>';
  html += '<span id="display-openDate-' + item.id + '" style="font-size:13px;color:#1a1a1a;">' + openDisplay + '</span>';
  html += '</div>';
  html += '<div class="edit-field-row" style="margin-top:4px;">';
  html += '<input type="date" id="edit-openDate-' + item.id + '" class="edit-inline" value="' + (item.openDate || '') + '">';
  html += '<button class="edit-save-btn" data-savebtn="' + item.id + '-openDate" onclick="saveEditField(' + item.id + ',\'openDate\',\'edit-openDate-' + item.id + '\')">';
  html += '<span style="position:relative;z-index:1;">ä¿å­˜</span></button>';
  html += '</div>';

  if(item.finishDate) html += '<p><b>ä½¿ã„åˆ‡ã‚Šæ—¥:</b> ' + item.finishDate + '</p>';
  if(cp) html += '<p><b>1æ—¥ã‚ãŸã‚Š:</b> <span id="display-cospa-' + item.id + '" style="color:#000;font-weight:700;">' + cospaDisplay + '</span></p>';

  html += '<div class="item-action-btns">';
  html += '<button onclick="markFinished(' + item.id + ')" class="btn-success" style="flex:1;"><span style="position:relative;z-index:1;">' + (item.finishDate ? 'â†©ï¸ ä½¿ã„åˆ‡ã‚Šè§£é™¤' : 'âœ… ä½¿ã„åˆ‡ã‚Šå®Œäº†') + '</span></button>';
  html += '<button onclick="removeItem(' + item.id + ')" class="btn-danger"><span style="position:relative;z-index:1;">ğŸ—‘ï¸ å‰Šé™¤</span></button>';
  html += '</div>';
  html += '</div>';
  html += '</details>';
  return html;
}

function renderPagination(totalItems) {
  var totalPages = Math.ceil(totalItems / itemsPerPage);
  var el = document.getElementById('paginationArea');
  if(totalPages <= 1) { el.innerHTML = ''; return; }
  var html = '';
  if(currentPage > 1) html += '<button onclick="changePage(' + (currentPage-1) + ')"><span style="position:relative;z-index:1;">â—€ å‰ã¸</span></button>';
  html += '<span>' + currentPage + ' / ' + totalPages + '</span>';
  if(currentPage < totalPages) html += '<button onclick="changePage(' + (currentPage+1) + ')"><span style="position:relative;z-index:1;">æ¬¡ã¸ â–¶</span></button>';
  el.innerHTML = html;
}
function changePage(page) { currentPage = page; render(); document.getElementById('routineArea').scrollIntoView({behavior:'smooth'}); }

/* ===== è¨­å®š ===== */
function saveSettings() {
  localStorage.setItem('geminiApiKey_v1', document.getElementById('geminiApiKey').value.trim());
  alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼âœ¨');
}
function clearApiKey() {
  if(confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('geminiApiKey_v1'); document.getElementById('geminiApiKey').value = ''; alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); }
}

/* ===== ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ===== */
function exportData() {
  if(cosmeData.length === 0 && chatHistories.length === 0) { alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  var backup = { version: APP_VERSION, timestamp: new Date().toISOString(), data: cosmeData, chats: chatHistories };
  var blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'cosme-backup-' + new Date().toISOString().split('T')[0] + '.json'; a.click();
  URL.revokeObjectURL(url);
  alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\nã‚³ã‚¹ãƒ¡: ' + cosmeData.length + 'ä»¶\nãƒãƒ£ãƒƒãƒˆ: ' + chatHistories.length + 'ä»¶');
}
function importData() { document.getElementById('importFile').click(); }
function handleImport(event) {
  var file = event.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var importedData = JSON.parse(e.target.result);
      if(importedData.data && Array.isArray(importedData.data)) {
        if(confirm(importedData.data.length + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
          cosmeData = importedData.data;
          if(importedData.chats) { chatHistories = importedData.chats; localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories)); }
          saveCosmeData(); currentPage = 1; render(); renderCospa(); switchTab('register'); alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
        }
      } else if(Array.isArray(importedData)) {
        if(confirm(importedData.length + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          cosmeData = importedData; saveCosmeData(); currentPage = 1; render(); renderCospa(); switchTab('register'); alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
        }
      } else { throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™'); }
    } catch(e) { alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* ===== ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ ===== */
function startProgress(t, p) { document.getElementById('progressContainer').style.display='block'; document.getElementById('progressText').innerText=t; updateProgress(p); }
function updateProgress(p) { document.getElementById('progressBar').style.width=p+'%'; }
function finishProgress() { updateProgress(100); setTimeout(function(){ document.getElementById('progressContainer').style.display='none'; }, 800); }
function hideProgress() { document.getElementById('progressContainer').style.display='none'; }

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function escapeHtml(text) {
  if(text === null || text === undefined) return '';
  var div = document.createElement('div'); div.textContent = String(text); return div.innerHTML;
}
</script>
</body>
</html>
