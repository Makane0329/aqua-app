<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cosme Genius Pro v10.13</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap');

:root {
  --bg-color: #f2f2f0;
  --card-bg: #ffffff;
  --text-main: #333333;
  --text-sub: #555555;
  --accent-color: #a89f91;
  --accent-dark: #8d8579;
  --header-bg: #e6e5e3;
  --line-color: #e0e0e0;
  --font-serif: 'Cormorant Garamond', serif;
  --font-sans: 'Zen Kaku Gothic New', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-bottom: env(safe-area-inset-bottom);
  --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
  --shadow-float: 0 8px 30px rgba(0, 0, 0, 0.08);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { overflow-x: hidden; -webkit-text-size-adjust: 100%; height: 100%; }
body {
  font-family: var(--font-sans);
  background-color: var(--bg-color);
  margin: 0; padding: 0;
  color: var(--text-main);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  width: 100%;
  overscroll-behavior-y: none;
  min-height: 100%;
  padding-bottom: var(--safe-bottom);
}
::-webkit-scrollbar { display: none; }

/* === Header === */
.header-area {
  padding: 50px 20px 30px;
  background: linear-gradient(to bottom, #e6e5e3, #f2f2f0);
  position: relative; z-index: 10; text-align: center;
}
.brand-title {
  font-family: var(--font-serif); font-size: 2.2rem; font-weight: 500;
  letter-spacing: 0.05em; margin: 0; color: var(--text-main); text-transform: uppercase;
}
.brand-subtitle {
  font-family: var(--font-sans); font-size: 0.7rem; letter-spacing: 0.2em;
  color: var(--text-sub); margin-top: 8px; display: block; font-weight: 400;
}

/* === Tabs === */
.tabs-sticky-wrapper {
  position: -webkit-sticky; position: sticky; top: 0; z-index: 100;
  background: rgba(242, 242, 240, 0.95);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05);
  box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.tabs {
  display: flex; justify-content: center; gap: 15px;
  max-width: 600px; margin: 0 auto; padding: 0 10px;
}
.tab-btn {
  background: transparent; border: none; font-family: var(--font-sans);
  font-size: 0.85rem; color: #888; padding: 8px 12px; cursor: pointer;
  transition: all 0.3s ease; position: relative; font-weight: 500;
}
.tab-btn.active { color: var(--text-main); font-weight: 700; }
.tab-btn.active::after {
  content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 20px; height: 2px; background-color: var(--accent-color);
}

/* === Container === */
.container { max-width: 600px; width: 100%; margin: 0 auto; padding: 20px 20px 120px; }

/* === Components === */
.section-title {
  font-family: var(--font-serif); font-size: 1.3rem; color: var(--text-main);
  margin: 40px 0 20px; padding-bottom: 8px; border-bottom: 1px solid var(--accent-color);
  display: flex; justify-content: space-between; align-items: flex-end;
}
.card { background: var(--card-bg); padding: 25px; border-radius: 4px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
.input-group { margin-bottom: 20px; }
label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; }

input, select, textarea {
  width: 100%; padding: 14px 12px; border: 1px solid #ddd; background: #fafafa;
  border-radius: 4px; font-family: var(--font-sans); font-size: 1rem;
  color: var(--text-main); transition: all 0.3s; appearance: none; -webkit-appearance: none;
}
select {
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); background: #fff; }
input::placeholder, textarea::placeholder { color: #bbb; }

button {
  width: 100%; padding: 16px; background: var(--text-main); color: #fff; border: none;
  font-family: var(--font-sans); font-weight: 500; font-size: 0.95rem;
  letter-spacing: 0.05em; cursor: pointer; transition: opacity 0.3s, transform 0.2s;
  border-radius: 4px; margin-top: 10px; position: relative; overflow: hidden;
}
button:active { transform: scale(0.98); }
button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
.btn-secondary { background: transparent !important; color: var(--text-main) !important; border: 1px solid #ccc !important; }
.btn-accent { background: var(--accent-color) !important; color: #fff !important; border: none !important; }
.btn-text {
  background: transparent !important; border: none !important; padding: 5px 10px !important;
  color: var(--accent-dark) !important; width: auto !important; margin: 0 !important; font-size: 0.8rem;
}

/* === Toggle Switch === */
.toggle-label { display: flex; align-items: center; cursor: pointer; }
.toggle-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-slider {
  position: absolute; inset: 0; background: #ccc; border-radius: 24px;
  transition: background 0.2s;
  cursor: pointer;
}
.toggle-slider::before {
  content: ''; position: absolute;
  width: 18px; height: 18px; left: 3px; top: 3px;
  background: white; border-radius: 50%;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .toggle-slider { background: var(--accent-color); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

/* === å†™çœŸAIç™»éŒ²: ãƒªã‚¹ãƒˆå½¢å¼ãƒœã‚¿ãƒ³ === */
.photo-list-card {
  background: #fff;
  border-radius: 4px;
  box-shadow: var(--shadow-soft);
  overflow: hidden;
  margin-bottom: 0;
}
.photo-list-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 18px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.photo-list-item:last-child { border-bottom: none; }
.photo-list-item:active { background: #f5f5f5; }
.photo-list-item input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer;
  width: 100%; height: 100%; padding: 0; border: none; background: transparent; font-size: 16px;
}
.photo-list-icon {
  width: 40px; height: 40px; border-radius: 50%;
  background: #f0eee9; display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; flex-shrink: 0;
}
.photo-list-label { font-size: 0.95rem; font-weight: 500; color: var(--text-main); }
.photo-list-sub { font-size: 0.75rem; color: #999; margin-top: 1px; }
.photo-list-arrow { margin-left: auto; color: #ccc; font-size: 0.9rem; flex-shrink: 0; }

/* === AIè‡ªå‹•å…¥åŠ›ãƒœã‚¿ãƒ³: å…¥åŠ›æ¬„ã¨åŒã˜é«˜ã• === */
.name-search-row {
  display: flex;
  gap: 10px;
  align-items: stretch;
  margin-bottom: 20px;
}
.name-search-row input {
  flex: 1;
  margin: 0;
}
.name-search-row .ai-search-btn {
  flex-shrink: 0;
  width: auto;
  padding: 0 18px;
  margin: 0;
  font-size: 0.85rem;
  white-space: nowrap;
  border-radius: 4px;
  align-self: stretch;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: unset;
  height: auto;
}

/* === List Items === */
.filter-tabs {
  display: flex; gap: 5px; margin-bottom: 15px; background: #e0e0e0;
  padding: 4px; border-radius: 6px;
}
.filter-tab { flex: 1; text-align: center; padding: 8px 0; font-size: 0.8rem; cursor: pointer; border-radius: 4px; color: #666; transition: 0.3s; }
.filter-tab.active { background: #fff; color: var(--text-main); font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

.item-card-details { background: #fff; border: 1px solid rgba(0,0,0,0.05); margin-bottom: 8px; border-radius: 4px; transition: all 0.3s ease; }
.item-card-details[open] { box-shadow: var(--shadow-soft); border-color: transparent; margin-bottom: 15px; }
.item-card-details summary { padding: 18px 15px; cursor: pointer; list-style: none; display: flex; flex-direction: column; gap: 8px; }
.item-card-details summary::-webkit-details-marker { display: none; }
.summary-top-row { display: flex; align-items: flex-start; justify-content: space-between; width: 100%; }
.summary-bottom-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
.item-brand { font-size: 0.7rem; color: #666; font-weight: 500; letter-spacing: 0.05em; margin-bottom: 2px; }
.item-name { font-size: 1.05rem; font-weight: 600; color: var(--text-main); white-space: normal; word-break: break-all; line-height: 1.4; }
.item-badges { display: flex; gap: 5px; flex-shrink: 0; align-items: center; flex-wrap: wrap; }
.badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 2px; font-weight: 600; }
.badge.morning { background: #fff8e1; color: #f39c12; border: 1px solid #ffe0b2; }
.badge.night { background: #e8eaf6; color: #3f51b5; border: 1px solid #c5cae9; }
.badge.both { background: #f3e5f5; color: #9c27b0; border: 1px solid #e1bee7; }
.badge.category { background: #eee; color: #444; border: 1px solid #ddd; }
.badge.finished { background: #cfd8dc; color: #455a64; border: 1px solid #b0bec5; }
.item-content { padding: 0 20px 20px; font-size: 0.9rem; color: var(--text-sub); border-top: 1px solid #f5f5f5; margin-top: 10px; padding-top: 15px; }
.ingredients-box { background: #f9f9f9; padding: 10px; border-radius: 4px; font-size: 0.8rem; color: #555; margin-top: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; }

/* === Tag Selector in item detail === */
.tag-selector { display: flex; gap: 6px; }
.tag-btn {
  flex: 1; padding: 9px 4px; font-size: 0.8rem; font-weight: 500;
  background: #f5f5f5; color: #666; border: 1.5px solid #e0e0e0;
  border-radius: 4px; margin: 0; width: auto; letter-spacing: 0;
  transition: all 0.2s;
}
.tag-btn:active { transform: scale(0.97); }
.tag-active-morning { background: #fff8e1 !important; color: #f39c12 !important; border-color: #ffe0b2 !important; font-weight: 700 !important; }
.tag-active-night   { background: #e8eaf6 !important; color: #3f51b5 !important; border-color: #c5cae9 !important; font-weight: 700 !important; }
.tag-active-both    { background: #f3e5f5 !important; color: #9c27b0 !important; border-color: #e1bee7 !important; font-weight: 700 !important; }

/* === Cospa === */
.cospa-card { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
.cospa-header { display: flex; justify-content: space-between; align-items: baseline; padding-right: 30px; }
.cospa-price { font-family: var(--font-serif); font-size: 1.6rem; color: var(--text-main); font-weight: 600; }
.cospa-unit { font-size: 0.8rem; color: #999; margin-left: 3px; }
.cospa-bar-bg { width: 100%; height: 4px; background: #eee; margin-top: 12px; border-radius: 2px; overflow: hidden; position: relative; }
.cospa-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--text-main)); position: absolute; left: 0; top: 0; }
.cospa-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top: 8px; }
.cospa-delete-btn { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; padding: 0; margin: 0; background: transparent; color: #ccc; border: none; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
.cospa-delete-btn:hover { color: #d32f2f; }

/* === Chat UI === */
.chat-area { padding-bottom: 120px; display: flex; flex-direction: column; gap: 20px; }
.msg-row { display: flex; width: 100%; }
.msg-row.user { justify-content: flex-end; }
.msg-row.ai { justify-content: flex-start; }
.msg-bubble { max-width: 90%; padding: 14px 18px; font-size: 1rem; line-height: 1.55; border-radius: 12px; word-break: break-word; box-shadow: 0 3px 8px rgba(0,0,0,0.06); }
.msg-row.user .msg-bubble { background: #3a3a3a; color: #f0f0f0; border-bottom-right-radius: 2px; font-weight: 400; white-space: pre-wrap; }
.msg-row.ai .msg-bubble { background: #fcfbf9; border: 1px solid #dcdcdc; color: #333; border-bottom-left-radius: 2px; font-weight: 400; }
.msg-bubble h3 { font-size: 1.1rem; font-weight: 700; margin: 1.2em 0 0.5em; color: #111; border-bottom: 1px solid #eee; padding-bottom: 4px; }
.msg-bubble h3:first-child { margin-top: 0; }
.msg-bubble strong { font-weight: 700; color: #000; }
.msg-bubble ul { padding-left: 1.2em; margin: 0.5em 0; }
.msg-bubble li { margin-bottom: 0.3em; list-style-type: disc; }
.msg-bubble hr { border: 0; height: 1px; background: #e0e0e0; margin: 1.5em 0; }

.typing-indicator { display: flex; gap: 4px; padding: 12px 16px; background: #fcfbf9; border: 1px solid #dcdcdc; border-radius: 12px; border-bottom-left-radius: 2px; width: fit-content; margin-bottom: 10px; }
.typing-indicator span { width: 6px; height: 6px; background: #888; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
.typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
.typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

.chat-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(242, 242, 240, 0.98); backdrop-filter: blur(10px); padding: 12px 15px; padding-bottom: calc(15px + var(--safe-bottom)); border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: flex-end; z-index: 2000; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
.chat-input { flex: 1; border: 1px solid #ccc; background: #fff; border-radius: 20px; padding: 12px 16px; font-size: 16px; min-height: 48px; max-height: 120px; margin: 0; transition: border-color 0.2s; resize: none; line-height: 1.5; color: #333; }
.chat-input:focus { border-color: var(--accent-color); }
.send-btn { width: 48px; height: 48px; border-radius: 50%; padding: 0; margin: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: var(--text-main); flex-shrink: 0; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

/* === Utils === */
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
.flex-row { display: flex; gap: 10px; align-items: center; }
.text-center { text-align: center; }
.alert-box { background: #fff3e0; padding: 15px; font-size: 0.85rem; color: #e65100; border-radius: 4px; margin-bottom: 20px; border: 1px solid #ffe0b2; }
.code-display { font-family: monospace; font-size: 0.75rem; color: #666; background: #eee; padding: 4px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; }

.progress-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.85); z-index: 3000; display:none; flex-direction:column; align-items:center; justify-content:center; }
.progress-spinner { width: 40px; height: 40px; border: 3px solid #ddd; border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
@keyframes spin { to {transform: rotate(360deg);} }
</style>
</head>
<body>

<!-- Header -->
<div class="header-area">
  <h1 class="brand-title">COSME GENIUS</h1>
  <span class="brand-subtitle">PRO EDITION v10.13</span>
</div>

<!-- Tabs -->
<div class="tabs-sticky-wrapper">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('register')" id="btn-register">ç™»éŒ²</button>
    <button class="tab-btn" onclick="switchTab('chat')" id="btn-chat">ç›¸è«‡</button>
    <button class="tab-btn" onclick="switchTab('cospa')" id="btn-cospa">ã‚³ã‚¹ãƒ‘</button>
    <button class="tab-btn" onclick="switchTab('settings')" id="btn-settings">è¨­å®š</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">

  <!-- ================= REGISTER TAB ================= -->
  <div id="tab-register" class="tab-content active">
    <div class="section-title"><span>ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²</span></div>

    <!-- å†™çœŸAIç™»éŒ² -->
    <div class="photo-list-card" style="margin-bottom: 20px;">
      <div class="photo-list-item">
        <div>
          <div class="photo-list-label">ğŸ“· å†™çœŸã‹ã‚‰AIç™»éŒ²</div>
          <div class="photo-list-sub">ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰ç”»åƒã‚’é¸æŠã—ã¦è‡ªå‹•å…¥åŠ› (1ã‚¹ãƒ†ãƒƒãƒ—ãƒ»é«˜é€Ÿ)</div>
        </div>
        <div class="photo-list-arrow">â€º</div>
        <input type="file" accept="image/*" onchange="handleImageSelect(event)">
      </div>
    </div>

    <!-- Manual Input Form -->
    <div class="card">
      <div class="name-search-row">
        <input type="text" id="itemName" placeholder="å•†å“å (å¿…é ˆ)">
        <button onclick="triggerManualAISearch()" id="btn-ai-search" class="btn-accent ai-search-btn">AIè‡ªå‹•å…¥åŠ›</button>
      </div>
      <div class="input-group"><input type="text" id="brand" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰å"></div>
      <div class="input-group">
        <select id="categorySelect">
          <option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
          <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
          <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
          <option value="ä¹³æ¶²">ä¹³æ¶²</option>
          <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
          <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div class="input-group"><textarea id="description" rows="2" placeholder="èª¬æ˜ãƒ»ãƒ¡ãƒ¢"></textarea></div>
      <div class="input-group">
        <label>å…¨æˆåˆ† (AIç™»éŒ²ã§è‡ªå‹•å–å¾—)</label>
        <textarea id="ingredients" rows="3" placeholder="æ°´, ã‚°ãƒªã‚»ãƒªãƒ³..."></textarea>
      </div>
      <div class="input-group flex-row">
        <input type="text" id="releaseDate" placeholder="ç™ºå£²æ—¥">
        <input type="number" id="itemPrice" placeholder="ä¾¡æ ¼ (å††)">
      </div>
      <div class="input-group">
        <label>ä½¿ç”¨é–‹å§‹æ—¥</label>
        <input type="date" id="openDate">
      </div>
      <div class="input-group">
        <select id="timeTag">
          <option value="æœ">æœç”¨</option>
          <option value="æ™©">å¤œç”¨</option>
          <option value="æœæ™©">æœæ™©å…¼ç”¨</option>
        </select>
      </div>
      <button onclick="addItem()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <div class="section-title" style="margin-top:50px; border:none; padding-bottom:0; display:block;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span>ç™»éŒ²ãƒªã‚¹ãƒˆ</span>
        <select id="sortSelect" onchange="render()" style="width:auto; border:none; background:transparent; font-size:0.8rem; text-align:right; color:var(--text-sub);">
          <option value="newest">æ–°ç€é †</option>
          <option value="time">æœãƒ»å¤œåˆ¥</option>
          <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
          <option value="brand">ãƒ–ãƒ©ãƒ³ãƒ‰é †</option>
        </select>
      </div>
      <div class="filter-tabs">
        <div class="filter-tab active" id="filter-active" onclick="setFilter('active')">ä½¿ç”¨ä¸­</div>
        <div class="filter-tab" id="filter-finished" onclick="setFilter('finished')">ä½¿ã„åˆ‡ã‚Š</div>
        <div class="filter-tab" id="filter-all" onclick="setFilter('all')">å…¨ã¦</div>
      </div>
    </div>
    <div id="routineArea"></div>
  </div>

  <!-- ================= CHAT TAB ================= -->
  <div id="tab-chat" class="tab-content">
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:20px;">
      <button class="btn-text" onclick="createNewChat()">ï¼‹ æ–°è¦ãƒãƒ£ãƒƒãƒˆ</button>
      <button class="btn-text" onclick="toggleChatHistory()">å±¥æ­´ã‚’è¡¨ç¤º</button>
    </div>
    <div id="chatHistoryContainer" style="display:none; background:#fff; margin-bottom:20px; padding:10px; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.05);"></div>
    <div id="chatHistory" class="chat-area"></div>
    <div class="chat-footer">
      <textarea id="chatInput" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1" oninput="adjustChatHeight(this)"></textarea>
      <button onclick="sendChatMessage()" class="send-btn">â¤</button>
    </div>
  </div>

  <!-- ================= COSPA TAB ================= -->
  <div id="tab-cospa" class="tab-content">
    <div class="section-title"><span>ã‚³ã‚¹ãƒ‘åˆ†æ</span></div>
    <div id="cospaTopSummary" style="margin-bottom:30px; text-align:center;"></div>
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
      <select id="cospaCategory" onchange="renderCospa()" style="font-size:0.85rem; width:48%;">
        <option value="all">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
        <option value="æ´—é¡”æ–™">æ´—é¡”æ–™</option>
        <option value="åŒ–ç²§æ°´">åŒ–ç²§æ°´</option>
        <option value="ä¹³æ¶²">ä¹³æ¶²</option>
        <option value="ç¾å®¹æ¶²">ç¾å®¹æ¶²</option>
        <option value="ã‚¯ãƒªãƒ¼ãƒ ">ã‚¯ãƒªãƒ¼ãƒ </option>
      </select>
      <select id="cospaSort" onchange="renderCospa()" style="font-size:0.85rem; width:48%;">
        <option value="cost_asc">å®‰ã„é † (æ—¥å‰²ã‚Š)</option>
        <option value="cost_desc">é«˜ã„é † (æ—¥å‰²ã‚Š)</option>
        <option value="days_desc">é•·ãä½¿ã£ã¦ã„ã‚‹é †</option>
        <option value="days_asc">ä½¿ç”¨æœŸé–“ãŒçŸ­ã„é †</option>
      </select>
    </div>
    <div id="cospaList"></div>
  </div>

  <!-- ================= SETTINGS TAB ================= -->
  <div id="tab-settings" class="tab-content">
    <div class="section-title"><span>è¨­å®š</span></div>
    <div class="alert-box">APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</div>
    <div class="card">
      <div class="input-group">
        <label>Gemini API ã‚­ãƒ¼</label>
        <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
      </div>

      <!-- ãƒãƒ£ãƒƒãƒˆç”¨ãƒ¢ãƒ‡ãƒ« -->
      <div class="input-group" style="margin-top:30px;">
        <label>ãƒãƒ£ãƒƒãƒˆç”¨ãƒ¢ãƒ‡ãƒ«</label>
        <select id="chatModelSelect" onchange="updateModelCodeDisplay()">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
          <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite</option>
          <option value="gemini-3-flash-preview">Gemini 3 Flash (æ¨å¥¨)</option>
          <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
        </select>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
          <div class="code-display">Code: <span id="chatModelCodeDisplay"></span></div>
          <label class="toggle-label" style="margin:0;">
            <span style="font-size:0.75rem; color:var(--text-sub); margin-right:8px;">æ€è€ƒãƒ¢ãƒ¼ãƒ‰</span>
            <div class="toggle-switch">
              <input type="checkbox" id="chatThinkingToggle" checked>
              <span class="toggle-slider"></span>
            </div>
          </label>
        </div>
      </div>

      <!-- æ¤œç´¢ãƒ»ç™»éŒ²ç”¨ãƒ¢ãƒ‡ãƒ« -->
      <div class="input-group">
        <label>æ¤œç´¢ãƒ»ç™»éŒ²ç”¨ãƒ¢ãƒ‡ãƒ«</label>
        <select id="fastModelSelect" onchange="updateModelCodeDisplay()">
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (æœ€é€Ÿ)</option>
          <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
          <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
          <option value="gemini-3-flash-preview">Gemini 3 Flash (æ¨å¥¨)</option>
          <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
        </select>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
          <div class="code-display">Code: <span id="fastModelCodeDisplay"></span></div>
          <label class="toggle-label" style="margin:0;">
            <span style="font-size:0.75rem; color:var(--text-sub); margin-right:8px;">æ€è€ƒãƒ¢ãƒ¼ãƒ‰</span>
            <div class="toggle-switch">
              <input type="checkbox" id="fastThinkingToggle">
              <span class="toggle-slider"></span>
            </div>
          </label>
        </div>
      </div>

      <button onclick="saveSettings()" class="btn-accent">è¨­å®šã‚’ä¿å­˜</button>
      <button onclick="clearApiKey()" class="btn-secondary" style="margin-top:20px; color:#c62828!important; border-color:#ef9a9a!important;">APIã‚­ãƒ¼ã‚’å‰Šé™¤</button>
    </div>
    <div class="section-title" style="margin-top:50px;"><span>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span></div>
    <div class="card">
      <button onclick="exportData()" class="btn-secondary">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (JSON)</button>
      <button onclick="importData()" class="btn-secondary">ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ (JSON)</button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
    </div>
  </div>
</div>

<!-- Global Overlay -->
<div id="progressOverlay" class="progress-overlay">
  <div class="progress-spinner"></div>
  <div id="progressText" style="font-family:var(--font-serif); font-size:1.1rem; color:#555;">å‡¦ç†ä¸­...</div>
</div>
<canvas id="compressionCanvas" style="display:none;"></canvas>

<script>
let cosmeData = JSON.parse(localStorage.getItem('cosmeData_v8')) || [];
let chatHistories = JSON.parse(localStorage.getItem('chatHistories_v1')) || [];
let currentChatId = null;
let isRequesting = false;
let lastRequestTime = 0;
let currentFilter = 'active';

const DEFAULT_CHAT_MODEL = 'gemini-3-flash-preview';
const DEFAULT_FAST_MODEL = 'gemini-2.5-flash-lite';

// æ€è€ƒãƒ¢ãƒ¼ãƒ‰: gemini-2.5-pro / gemini-2.5-flash ã®ã¿å¯¾å¿œ
function modelSupportsThinking(modelId) {
  return modelId && modelId.startsWith('gemini-2.5') && !modelId.includes('lite');
}

function getGenConfig(isFast) {
  const modelSelectId = isFast ? 'fastModelSelect' : 'chatModelSelect';
  const modelId = document.getElementById(modelSelectId)?.value || '';
  const thinkingToggle = isFast
    ? document.getElementById('fastThinkingToggle')?.checked
    : document.getElementById('chatThinkingToggle')?.checked;

  const cfg = { temperature: isFast ? 0.2 : 0.7 };

  if (thinkingToggle && modelSupportsThinking(modelId)) {
    cfg.thinkingConfig = { thinkingBudget: 8192 };
  }
  return cfg;
}

function getImageApiUrl() {
  return `https://generativelanguage.googleapis.com/v1beta/models/${document.getElementById('fastModelSelect').value}:generateContent?key=${localStorage.getItem('geminiApiKey_v1')}`;
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById('openDate').valueAsDate = new Date();
  document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey_v1') || '';
  loadModelSettings();
  if(chatHistories.length > 0) { currentChatId = chatHistories[0].id; loadChat(currentChatId); }
  else { createNewChat(); }
  render(); renderCospa();
});

function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  document.getElementById('btn-' + tabId).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  if(tabId === 'cospa') renderCospa();
  if(tabId === 'chat') setTimeout(scrollToBottom, 100);
}
function scrollToBottom() { window.scrollTo(0, document.body.scrollHeight); }

function validateApiKey() {
  var k = localStorage.getItem('geminiApiKey_v1');
  if(!k || k.length < 10) { alert('è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'); switchTab('settings'); return false; }
  return true;
}
function getApiUrl(isFast) {
  var model = isFast
    ? document.getElementById('fastModelSelect').value
    : document.getElementById('chatModelSelect').value;
  return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${localStorage.getItem('geminiApiKey_v1')}`;
}

async function waitForRateLimit() {
  var now = Date.now();
  if (now - lastRequestTime < 200) await new Promise(r => setTimeout(r, 200 - (now - lastRequestTime)));
  lastRequestTime = Date.now();
}

/* UI Helpers */
function showOverlay(txt) {
  document.getElementById('progressOverlay').style.display = 'flex';
  document.getElementById('progressText').textContent = txt;
}
function hideOverlay() { document.getElementById('progressOverlay').style.display = 'none'; }
function setBtnLoading(btnId, isLoading, text='AIè‡ªå‹•å…¥åŠ›') {
  var btn = document.getElementById(btnId);
  if(!btn) return;
  if(isLoading) { btn.disabled = true; btn.textContent = 'æ¤œç´¢ä¸­...'; }
  else { btn.disabled = false; btn.textContent = text; }
}

// JSONãƒ‘ãƒ¼ã‚¹
function parseAIJson(text) {
  if(!text) return null;
  try { return JSON.parse(text); } catch(e) {}
  var clean = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
  try { return JSON.parse(clean); } catch(e) {}
  var start = clean.indexOf('{');
  var end = clean.lastIndexOf('}');
  if(start !== -1 && end !== -1 && end > start) {
    try { return JSON.parse(clean.substring(start, end + 1)); } catch(e) {}
  }
  return null;
}

/* =====================================================
   callGeminiAPI
   ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ç¯€ç´„ã®ãŸã‚ï¼‰
   ãƒ»gemini-3ç³»ã¯responseMimeTypeéå¯¾å¿œã®ãŸã‚é€ä¿¡ã—ãªã„
   ===================================================== */
async function callGeminiAPI(url, parts, config, jsonMode = false) {
  var genConfig = Object.assign({}, config);

  // gemini-3ç³»ã¯responseMimeTypeéå¯¾å¿œ
  var supportsJsonMode = !url.includes('gemini-3');
  if (jsonMode && supportsJsonMode) {
    genConfig.responseMimeType = "application/json";
  }
  if (jsonMode && !genConfig.maxOutputTokens) {
    genConfig.maxOutputTokens = 512;
  }

  var res = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: genConfig })
  });

  if (!res.ok) {
    var errJson = await res.json().catch(() => ({}));
    var errMsg = errJson?.error?.message || `HTTP ${res.status}`;

    // ã‚¯ã‚©ãƒ¼ã‚¿è¶…é
    if (res.status === 429 || errMsg.includes('quota') || errMsg.includes('Quota')) {
      var retryMatch = errMsg.match(/retry in ([\d.]+)s/i);
      var waitSec = retryMatch ? Math.ceil(parseFloat(retryMatch[1])) : null;
      throw new Error('APIã®ç„¡æ–™æ ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚' +
        (waitSec ? `ç´„${waitSec}ç§’å¾Œã«ãŠè©¦ã—ãã ã•ã„ã€‚` : 'ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚') +
        '\nè¨­å®šã§ã‚ˆã‚Šè»½é‡ãªãƒ¢ãƒ‡ãƒ«ï¼ˆFlash-Liteï¼‰ã¸ã®å¤‰æ›´ã‚‚ãŠè©¦ã—ãã ã•ã„ã€‚');
    }

    // ã‚µãƒ¼ãƒãƒ¼éè² è·
    if (res.status === 503 || errMsg.includes('high demand') || errMsg.includes('overloaded') || errMsg.includes('UNAVAILABLE')) {
      throw new Error('ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚\nï¼ˆæ•°ç§’ã€œæ•°åç§’å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ï¼‰');
    }

    // â˜…ãƒªãƒˆãƒ©ã‚¤ãªã—: ã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾ã‚¹ãƒ­ãƒ¼ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã®2é‡é€šä¿¡ã‚’æ’é™¤ï¼‰
    throw new Error(errMsg);
  }

  var d = await res.json();

  if (!d.candidates || d.candidates.length === 0) {
    var reason = d.promptFeedback?.blockReason || 'ä¸æ˜';
    throw new Error(`å¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼ˆç†ç”±: ${reason}ï¼‰`);
  }

  var resParts = d.candidates[0]?.content?.parts || [];
  var textPart = resParts.filter(p => typeof p.text === 'string').pop();
  return textPart?.text || '';
}

/* =====================================================
   handleImageSelect
   â˜…å¤‰æ›´: 2ã‚¹ãƒ†ãƒƒãƒ—â†’1ã‚¹ãƒ†ãƒƒãƒ—ã«çµ±åˆï¼ˆé€Ÿåº¦æ”¹å–„ï¼‰
   ===================================================== */
async function handleImageSelect(e) {
  if(!validateApiKey() || isRequesting) return;
  var file = e.target.files[0];
  if(!file) return;
  isRequesting = true;
  showOverlay("AIè§£æä¸­...");

  try {
    var base64 = (await compressImage(file)).split(',')[1];
    await waitForRateLimit();

    // â˜…1å›ã®é€šä¿¡ã§å…¨æƒ…å ±ã‚’å–å¾—ï¼ˆæ—§:2å›â†’æ–°:1å›ï¼‰
    var combinedPrompt = `ã“ã®åŒ–ç²§å“ç”»åƒã‚’è§£æã—ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’JSONå½¢å¼ã§æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚å¿…ãšJSONã®ã¿è¿”ã—ã¦ãã ã•ã„ã€‚
{"itemName":"å•†å“å","brandName":"ãƒ–ãƒ©ãƒ³ãƒ‰å","category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–ã®ã„ãšã‚Œã‹","ingredients":"å…¨æˆåˆ†","description":"ç‰¹å¾´ã®è¦ç´„","price":0,"releaseDate":"YYYY/MM/DD"}`;

    var responseText = await callGeminiAPI(getImageApiUrl(), [
      { text: combinedPrompt },
      { inlineData: { mimeType: "image/jpeg", data: base64 } }
    ], getGenConfig(true), true);

    var result = parseAIJson(responseText);
    if(result) {
      if(result.itemName)   document.getElementById('itemName').value   = result.itemName;
      if(result.brandName)  document.getElementById('brand').value      = result.brandName;
      if(result.category)   document.getElementById('categorySelect').value = result.category;
      if(result.description)document.getElementById('description').value= result.description;
      if(result.ingredients)document.getElementById('ingredients').value= result.ingredients;
      if(result.price)      document.getElementById('itemPrice').value  = result.price;
      if(result.releaseDate)document.getElementById('releaseDate').value= result.releaseDate;
      alert('AIç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
    } else {
      alert('æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç”»åƒã‚’ã‚ˆã‚Šé®®æ˜ãªã‚‚ã®ã«ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  } catch(err) {
    alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
  } finally {
    isRequesting = false; hideOverlay(); e.target.value = '';
  }
}

function compressImage(file) {
  return new Promise(r => {
    var fr = new FileReader();
    fr.onload = e => {
      var img = new Image();
      img.onload = () => {
        var c = document.getElementById('compressionCanvas');
        var scale = Math.min(1000/img.width, 1);
        c.width = img.width * scale; c.height = img.height * scale;
        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
        r(c.toDataURL('image/jpeg', 0.8));
      };
      img.src = e.target.result;
    };
    fr.readAsDataURL(file);
  });
}

/* Text Search (AIè‡ªå‹•å…¥åŠ›) */
async function triggerManualAISearch() {
  if(!validateApiKey() || isRequesting) return;
  var name = document.getElementById('itemName').value.trim();
  if(!name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  isRequesting = true;
  setBtnLoading('btn-ai-search', true);

  try {
    await waitForRateLimit();
    var p = `åŒ–ç²§å“ã€Œ${name}ã€ã®æƒ…å ±ã‚’ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚å¿…ãšJSONã®ã¿è¿”ã—ã¦ãã ã•ã„ã€‚
{"brand":"","category":"æ´—é¡”æ–™/åŒ–ç²§æ°´/ä¹³æ¶²/ç¾å®¹æ¶²/ã‚¯ãƒªãƒ¼ãƒ /ãã®ä»–ã®ã„ãšã‚Œã‹","ingredients":"å…¨æˆåˆ†","description":"èª¬æ˜","price":0,"releaseDate":""}`;

    var text = await callGeminiAPI(getApiUrl(true), [{ text: p }], getGenConfig(true), true);
    var j = parseAIJson(text);

    if(!j) throw new Error("æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å•†å“åã‚’ã‚ˆã‚Šæ­£ç¢ºã«å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");

    if(j.brand)      document.getElementById('brand').value = j.brand;
    if(j.category)   document.getElementById('categorySelect').value = j.category;
    if(j.description)document.getElementById('description').value = j.description;
    if(j.ingredients)document.getElementById('ingredients').value = j.ingredients;
    if(j.price)      document.getElementById('itemPrice').value = j.price;
    if(j.releaseDate)document.getElementById('releaseDate').value = j.releaseDate;

  } catch(err) {
    alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + err.message);
  } finally {
    isRequesting = false;
    setBtnLoading('btn-ai-search', false);
  }
}

/* Data Logic */
function addItem() {
  var item = {
    id: Date.now(),
    name: document.getElementById('itemName').value.trim(),
    brand: document.getElementById('brand').value.trim(),
    category: document.getElementById('categorySelect').value,
    description: document.getElementById('description').value.trim(),
    ingredients: document.getElementById('ingredients').value.trim(),
    releaseDate: document.getElementById('releaseDate').value,
    price: document.getElementById('itemPrice').value,
    openDate: document.getElementById('openDate').value,
    tag: document.getElementById('timeTag').value
  };
  if(!item.name) return alert('å•†å“åã¯å¿…é ˆã§ã™');
  cosmeData.unshift(item);
  saveData(); render(); renderCospa();
  ['itemName','brand','description','ingredients','itemPrice','releaseDate'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('categorySelect').selectedIndex = 0;
  alert('è¿½åŠ ã—ã¾ã—ãŸ');
}
function saveData() { localStorage.setItem('cosmeData_v8', JSON.stringify(cosmeData)); }
function removeItem(id) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { cosmeData = cosmeData.filter(i => i.id !== id); saveData(); render(); renderCospa(); } }
function removeCospaItem(id) { if(confirm('ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { cosmeData = cosmeData.filter(i => i.id !== id); saveData(); render(); renderCospa(); } }
function markFinished(id) {
  var i = cosmeData.find(x => x.id === id);
  if(i) { i.finishDate = i.finishDate ? null : new Date().toISOString().split('T')[0]; saveData(); render(); renderCospa(); }
}
function saveEdit(id, key, val) { var i = cosmeData.find(x => x.id === id); if(i) { i[key] = val; saveData(); renderCospa(); } }

function saveTagEdit(id, tag, clickedBtn) {
  var item = cosmeData.find(x => x.id === id);
  if(!item) return;
  item.tag = tag;
  saveData();
  var selector = clickedBtn.closest('.tag-selector');
  selector.querySelectorAll('.tag-btn').forEach(b => {
    b.classList.remove('tag-active-morning','tag-active-night','tag-active-both');
  });
  var cls = tag === 'æœ' ? 'tag-active-morning' : (tag === 'æ™©' ? 'tag-active-night' : 'tag-active-both');
  clickedBtn.classList.add(cls);
  var details = clickedBtn.closest('details');
  var badge = details.querySelector('.badge.morning, .badge.night, .badge.both');
  if(badge) {
    badge.className = 'badge ' + (tag==='æœ'?'morning': tag==='æ™©'?'night':'both');
    badge.textContent = tag==='æœ'?'æœ': tag==='æ™©'?'å¤œ':'æœå¤œ';
  }
}

function setFilter(type) {
  currentFilter = type;
  document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('filter-' + type).classList.add('active');
  render();
}

function render() {
  var type = document.getElementById('sortSelect').value;
  var d = cosmeData.filter(item => {
    if(currentFilter === 'active') return !item.finishDate;
    if(currentFilter === 'finished') return item.finishDate;
    return true;
  });
  if (type === 'time') d.sort((a,b) => (a.tag||'').localeCompare(b.tag||''));
  else if (type === 'category') d.sort((a,b) => (a.category||'').localeCompare(b.category||''));
  else if (type === 'brand') d.sort((a,b) => (a.brand||'').localeCompare(b.brand||''));

  var html = '';
  d.forEach(item => {
    var badgeClass = item.tag === 'æœ' ? 'morning' : (item.tag === 'æ™©' ? 'night' : 'both');
    var badgeLabel = item.tag === 'æœ' ? 'æœ' : (item.tag === 'æ™©' ? 'å¤œ' : 'æœå¤œ');
    var categoryLabel = item.category || 'ãã®ä»–';
    html += `
    <details class="item-card-details">
      <summary>
        <div class="summary-top-row">
          <div style="display:flex; flex-direction:column; width:100%; padding-right:10px;">
            <div class="item-brand">${escapeHtml(item.brand)}</div>
            <div class="item-name" style="${item.finishDate?'text-decoration:line-through;opacity:0.6':''}">${escapeHtml(item.name)}</div>
          </div>
        </div>
        <div class="summary-bottom-row" style="margin-top:5px;">
          <div class="item-badges">
            <span class="badge category">${categoryLabel}</span>
            <span class="badge ${badgeClass}">${badgeLabel}</span>
            ${item.finishDate ? '<span class="badge finished">ä½¿ã„åˆ‡ã‚Š</span>' : ''}
          </div>
        </div>
      </summary>
      <div class="item-content">
        <p style="margin:5px 0;">${escapeHtml(item.description || 'èª¬æ˜ãªã—')}</p>
        ${item.ingredients ? `<div class="ingredients-box"><b>å…¨æˆåˆ†:</b><br>${escapeHtml(item.ingredients)}</div>` : ''}
        <div class="flex-row" style="margin-top:15px;">
          <input type="number" value="${item.price}" placeholder="ä¾¡æ ¼" onchange="saveEdit(${item.id},'price',this.value)" style="font-size:0.9rem;">
          <input type="date" value="${item.openDate}" onchange="saveEdit(${item.id},'openDate',this.value)" style="font-size:0.9rem;">
        </div>
        <div style="margin-top:10px;">
          <label style="font-size:0.72rem; color:#888; margin-bottom:4px; display:block; font-weight:600;">ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
          <div class="tag-selector">
            <button class="tag-btn ${item.tag==='æœ'?'tag-active-morning':''}" onclick="saveTagEdit(${item.id},'æœ',this)">â˜€ï¸ æœ</button>
            <button class="tag-btn ${item.tag==='æ™©'?'tag-active-night':''}" onclick="saveTagEdit(${item.id},'æ™©',this)">ğŸŒ™ å¤œ</button>
            <button class="tag-btn ${item.tag==='æœæ™©'?'tag-active-both':''}" onclick="saveTagEdit(${item.id},'æœæ™©',this)">âœ¨ æœå¤œ</button>
          </div>
        </div>
        <div class="flex-row" style="margin-top:10px;">
          <button class="btn-secondary" onclick="markFinished(${item.id})">${item.finishDate?'ä½¿ã„åˆ‡ã‚Šè§£é™¤':'ä½¿ã„åˆ‡ã‚Šã«ã™ã‚‹'}</button>
          <button class="btn-secondary" onclick="removeItem(${item.id})" style="color:red!important;border-color:#ffcccc!important;">å‰Šé™¤</button>
        </div>
      </div>
    </details>`;
  });
  document.getElementById('routineArea').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:50px;font-size:0.9rem;">è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}

function renderCospa() {
  var cat = document.getElementById('cospaCategory').value;
  var sort = document.getElementById('cospaSort').value;
  var list = cosmeData.filter(i => (cat==='all'||i.category===cat) && i.price && i.openDate);
  list.sort((a,b) => {
    var da = getDaily(a), db = getDaily(b);
    var daysA = getDays(a), daysB = getDays(b);
    if(sort === 'cost_asc') return da - db;
    if(sort === 'cost_desc') return db - da;
    if(sort === 'days_desc') return daysB - daysA;
    if(sort === 'days_asc') return daysA - daysB;
    return 0;
  });
  var html = '', totalDaily = 0;
  list.forEach(item => {
    var days = getDays(item);
    var daily = Math.round(getDaily(item));
    totalDaily += daily;
    var barWidth = Math.min(100, (daily / 150) * 100);
    html += `
    <div class="cospa-card">
      <button class="cospa-delete-btn" onclick="removeCospaItem(${item.id})">ğŸ—‘ï¸</button>
      <div class="cospa-header">
        <div><div style="font-size:0.75rem;color:#888;">${escapeHtml(item.brand)}</div><div style="font-weight:500;">${escapeHtml(item.name)}</div></div>
        <div><span class="cospa-price">Â¥${daily}</span><span class="cospa-unit">/æ—¥</span></div>
      </div>
      <div class="cospa-bar-bg"><div class="cospa-bar-fill" style="width:${barWidth}%"></div></div>
      <div class="cospa-meta"><span>Â¥${item.price}</span><span>${days}æ—¥ ${item.finishDate?'(å®Œ)':''}</span></div>
    </div>`;
  });
  document.getElementById('cospaList').innerHTML = html || '<div class="text-center" style="margin-top:40px;color:#ccc;">ãƒ‡ãƒ¼ã‚¿ä¸è¶³</div>';
  if(list.length > 0) {
    document.getElementById('cospaTopSummary').innerHTML = `<div style="font-size:0.9rem; color:#888; font-family:var(--font-serif);">1æ—¥ã‚ãŸã‚Šã®åˆè¨ˆ</div><div style="font-size:3rem; line-height:1; font-family:var(--font-serif); color:var(--text-main);">Â¥${Math.round(totalDaily)}</div>`;
  }
}
function getDays(i) {
  var start = new Date(i.openDate);
  var end = i.finishDate ? new Date(i.finishDate) : new Date();
  return Math.max(1, Math.floor((end - start) / 86400000));
}
function getDaily(i) { return i.price / getDays(i); }

/* =====================================================
   Chat
   â˜…å¤‰æ›´: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ ingredients ã‚’é™¤å¤–ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ç¯€ç´„ï¼‰
   ===================================================== */
function createNewChat() {
  var id = 'chat_' + Date.now();
  chatHistories.unshift({ id: id, title: 'æ–°è¦ãƒãƒ£ãƒƒãƒˆ', date: new Date().toISOString(), messages: [{ type: 'ai', text: 'ã“ã‚“ã«ã¡ã¯ï¼ç™»éŒ²ã‚³ã‚¹ãƒ¡ã«åŸºã¥ã„ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¾ã™ã€‚ä½•ã§ã‚‚èã„ã¦ãã ã•ã„âœ¨' }] });
  saveChatHistories(); loadChat(id);
}
function loadChat(id) {
  currentChatId = id;
  var chat = chatHistories.find(c => c.id === id);
  var area = document.getElementById('chatHistory');
  area.innerHTML = '';
  chat.messages.forEach(m => appendMsg(m.type, m.text, false));
  renderChatList();
}
function appendMsg(type, text, animate = false) {
  var div = document.createElement('div');
  div.className = `msg-row ${type}`;
  var bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  if (type === 'ai') { bubble.innerHTML = formatMarkdown(text); }
  else { bubble.textContent = text; }
  if (animate && type === 'ai') {
    div.appendChild(bubble);
    document.getElementById('chatHistory').appendChild(div);
    bubble.style.opacity = '0';
    setTimeout(() => { bubble.style.opacity = '1'; bubble.style.transition = 'opacity 0.3s'; }, 50);
    scrollToBottom();
  } else {
    div.appendChild(bubble);
    document.getElementById('chatHistory').appendChild(div);
  }
}
function formatMarkdown(text) {
  if (!text) return '';
  let html = text
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/^\- (.*$)/gim, '<ul><li>$1</li></ul>')
    .replace(/<\/ul>\s*<ul>/g, '')
    .replace(/---/g, '<hr>');
  return html.replace(/\n/g, '<br>');
}
function showTypingIndicator() {
  var div = document.createElement('div');
  div.className = 'msg-row ai'; div.id = 'typing-indicator-row';
  div.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
  document.getElementById('chatHistory').appendChild(div);
  scrollToBottom();
}
function removeTypingIndicator() {
  var el = document.getElementById('typing-indicator-row');
  if(el) el.remove();
}
function adjustChatHeight(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }

async function sendChatMessage() {
  if(!validateApiKey() || isRequesting) return;
  var input = document.getElementById('chatInput');
  var txt = input.value.trim();
  if(!txt) return;
  input.value = ''; input.style.height = 'auto';
  isRequesting = true;
  appendMsg('user', txt);
  scrollToBottom();

  var chat = chatHistories.find(c => c.id === currentChatId);
  chat.messages.push({ type: 'user', text: txt });
  if(chat.messages.length === 2) chat.title = txt.substring(0, 20);
  saveChatHistories();
  showTypingIndicator();

  try {
    await waitForRateLimit();

    // â˜…æˆåˆ†(ingredients)ã‚’é™¤å¤–ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„
    // æˆåˆ†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹è³ªå•ã®å ´åˆã®ã¿æˆåˆ†ã‚‚é€ã‚‹
    var needsIngredients = /æˆåˆ†|ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼|æ•æ„Ÿ|åˆºæ¿€|ç›¸æ€§|é…åˆ/.test(txt);
    var context = JSON.stringify(cosmeData.map(c => {
      var obj = { n: c.name, b: c.brand, c: c.category };
      if(needsIngredients && c.ingredients) {
        // æˆåˆ†ã¯å…ˆé ­100æ–‡å­—ã®ã¿ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„ï¼‰
        obj.ing = c.ingredients.substring(0, 100);
      }
      return obj;
    }));

    var prompt = `å½¹å‰²:ç¾å®¹éƒ¨å“¡ã€‚æ–‡è„ˆ:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€æŒã‚³ã‚¹ãƒ¡=${context}ã€‚è³ªå•:${txt}ã€‚å›ç­”ã¯èª­ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯**å¤ªå­—**ã«ã€è¦‹å‡ºã—ã¯### ã‚’ä½¿ã„ã€ç®‡æ¡æ›¸ãã¯- ã‚’ä½¿ã£ã¦æ•´å½¢ã—ã¦ãã ã•ã„ã€‚`;
    var ans = await callGeminiAPI(getApiUrl(false), [{ text: prompt }], getGenConfig(false));
    if(!ans) ans = "å›ç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
    removeTypingIndicator();
    appendMsg('ai', ans, true);
    chat.messages.push({ type: 'ai', text: ans });
    saveChatHistories();
  } catch(err) {
    removeTypingIndicator();
    appendMsg('ai', "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message);
  } finally {
    isRequesting = false; scrollToBottom();
  }
}
function saveChatHistories() { localStorage.setItem('chatHistories_v1', JSON.stringify(chatHistories)); }
function renderChatList() {
  var h = '';
  chatHistories.forEach(c => {
    h += `<div onclick="loadChat('${c.id}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; background:${c.id===currentChatId?'#f9f9f9':'#fff'}"><div style="font-weight:600; font-size:0.9rem; color:var(--text-main);">${escapeHtml(c.title)}</div><div style="font-size:0.75rem; color:#999;">${new Date(c.date).toLocaleDateString()}</div></div>`;
  });
  document.getElementById('chatHistoryContainer').innerHTML = h;
}
function toggleChatHistory() {
  var el = document.getElementById('chatHistoryContainer');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
  renderChatList();
}

/* Settings */
function loadModelSettings() {
  var cm = localStorage.getItem('chatModel_v1') || DEFAULT_CHAT_MODEL;
  var fm = localStorage.getItem('fastModel_v1') || DEFAULT_FAST_MODEL;

  var cmSel = document.getElementById('chatModelSelect');
  var fmSel = document.getElementById('fastModelSelect');
  if ([...cmSel.options].some(o => o.value === cm)) cmSel.value = cm;
  else { cmSel.value = DEFAULT_CHAT_MODEL; localStorage.setItem('chatModel_v1', DEFAULT_CHAT_MODEL); }
  if ([...fmSel.options].some(o => o.value === fm)) fmSel.value = fm;
  else { fmSel.value = DEFAULT_FAST_MODEL; localStorage.setItem('fastModel_v1', DEFAULT_FAST_MODEL); }

  var chatThinking = localStorage.getItem('chatThinking_v1');
  var fastThinking = localStorage.getItem('fastThinking_v1');
  document.getElementById('chatThinkingToggle').checked = chatThinking === null ? true : chatThinking === 'true';
  document.getElementById('fastThinkingToggle').checked = fastThinking === null ? false : fastThinking === 'true';

  updateModelCodeDisplay();
}
function updateModelCodeDisplay() {
  document.getElementById('chatModelCodeDisplay').textContent = document.getElementById('chatModelSelect').value;
  document.getElementById('fastModelCodeDisplay').textContent = document.getElementById('fastModelSelect').value;
}
function saveSettings() {
  localStorage.setItem('geminiApiKey_v1', document.getElementById('geminiApiKey').value.trim());
  localStorage.setItem('chatModel_v1', document.getElementById('chatModelSelect').value);
  localStorage.setItem('fastModel_v1', document.getElementById('fastModelSelect').value);
  localStorage.setItem('chatThinking_v1', document.getElementById('chatThinkingToggle').checked.toString());
  localStorage.setItem('fastThinking_v1', document.getElementById('fastThinkingToggle').checked.toString());
  alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function clearApiKey() { localStorage.removeItem('geminiApiKey_v1'); document.getElementById('geminiApiKey').value = ''; alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); }

/* Data IO */
function exportData() {
  var b = new Blob([JSON.stringify({data:cosmeData, chats:chatHistories})], {type:'application/json'});
  var a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='cosme_backup.json'; a.click();
}
function importData(){ document.getElementById('importFile').click(); }
function handleImport(e){
  var r=new FileReader(); r.onload=function(ev){ try{ var d=JSON.parse(ev.target.result); cosmeData=d.data||[]; chatHistories=d.chats||[]; saveData(); saveChatHistories(); render(); alert('å¾©å…ƒã—ã¾ã—ãŸ'); }catch(x){alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼');} }; r.readAsText(e.target.files[0]);
}

function escapeHtml(text) {
  if(text == null) return '';
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
</script>
</body>
</html>
